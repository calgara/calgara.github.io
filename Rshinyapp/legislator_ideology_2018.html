<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>widgetframe</title>
<script src="data:application/x-javascript;base64,KGZ1bmN0aW9uKCkgewogIC8vIElmIHdpbmRvdy5IVE1MV2lkZ2V0cyBpcyBhbHJlYWR5IGRlZmluZWQsIHRoZW4gdXNlIGl0OyBvdGhlcndpc2UgY3JlYXRlIGEKICAvLyBuZXcgb2JqZWN0LiBUaGlzIGFsbG93cyBwcmVjZWRpbmcgY29kZSB0byBzZXQgb3B0aW9ucyB0aGF0IGFmZmVjdCB0aGUKICAvLyBpbml0aWFsaXphdGlvbiBwcm9jZXNzICh0aG91Z2ggbm9uZSBjdXJyZW50bHkgZXhpc3QpLgogIHdpbmRvdy5IVE1MV2lkZ2V0cyA9IHdpbmRvdy5IVE1MV2lkZ2V0cyB8fCB7fTsKCiAgLy8gU2VlIGlmIHdlJ3JlIHJ1bm5pbmcgaW4gYSB2aWV3ZXIgcGFuZS4gSWYgbm90LCB3ZSdyZSBpbiBhIHdlYiBicm93c2VyLgogIHZhciB2aWV3ZXJNb2RlID0gd2luZG93LkhUTUxXaWRnZXRzLnZpZXdlck1vZGUgPQogICAgICAvXGJ2aWV3ZXJfcGFuZT0xXGIvLnRlc3Qod2luZG93LmxvY2F0aW9uKTsKCiAgLy8gU2VlIGlmIHdlJ3JlIHJ1bm5pbmcgaW4gU2hpbnkgbW9kZS4gSWYgbm90LCBpdCdzIGEgc3RhdGljIGRvY3VtZW50LgogIC8vIE5vdGUgdGhhdCBzdGF0aWMgd2lkZ2V0cyBjYW4gYXBwZWFyIGluIGJvdGggU2hpbnkgYW5kIHN0YXRpYyBtb2RlcywgYnV0CiAgLy8gb2J2aW91c2x5LCBTaGlueSB3aWRnZXRzIGNhbiBvbmx5IGFwcGVhciBpbiBTaGlueSBhcHBzL2RvY3VtZW50cy4KICB2YXIgc2hpbnlNb2RlID0gd2luZG93LkhUTUxXaWRnZXRzLnNoaW55TW9kZSA9CiAgICAgIHR5cGVvZih3aW5kb3cuU2hpbnkpICE9PSAidW5kZWZpbmVkIiAmJiAhIXdpbmRvdy5TaGlueS5vdXRwdXRCaW5kaW5nczsKCiAgLy8gV2UgY2FuJ3QgY291bnQgb24galF1ZXJ5IGJlaW5nIGF2YWlsYWJsZSwgc28gd2UgaW1wbGVtZW50IG91ciBvd24KICAvLyB2ZXJzaW9uIGlmIG5lY2Vzc2FyeS4KICBmdW5jdGlvbiBxdWVyeVNlbGVjdG9yQWxsKHNjb3BlLCBzZWxlY3RvcikgewogICAgaWYgKHR5cGVvZihqUXVlcnkpICE9PSAidW5kZWZpbmVkIiAmJiBzY29wZSBpbnN0YW5jZW9mIGpRdWVyeSkgewogICAgICByZXR1cm4gc2NvcGUuZmluZChzZWxlY3Rvcik7CiAgICB9CiAgICBpZiAoc2NvcGUucXVlcnlTZWxlY3RvckFsbCkgewogICAgICByZXR1cm4gc2NvcGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhc0FycmF5KHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwpCiAgICAgIHJldHVybiBbXTsKICAgIGlmICgkLmlzQXJyYXkodmFsdWUpKQogICAgICByZXR1cm4gdmFsdWU7CiAgICByZXR1cm4gW3ZhbHVlXTsKICB9CgogIC8vIEltcGxlbWVudCBqUXVlcnkncyBleHRlbmQKICBmdW5jdGlvbiBleHRlbmQodGFyZ2V0IC8qLCAuLi4gKi8pIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV07CiAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgdGFyZ2V0W3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHRhcmdldDsKICB9CgogIC8vIElFOCBkb2Vzbid0IHN1cHBvcnQgQXJyYXkuZm9yRWFjaC4KICBmdW5jdGlvbiBmb3JFYWNoKHZhbHVlcywgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIGlmICh2YWx1ZXMuZm9yRWFjaCkgewogICAgICB2YWx1ZXMuZm9yRWFjaChjYWxsYmFjaywgdGhpc0FyZyk7CiAgICB9IGVsc2UgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc0FyZywgdmFsdWVzW2ldLCBpLCB2YWx1ZXMpOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBSZXBsYWNlcyB0aGUgc3BlY2lmaWVkIG1ldGhvZCB3aXRoIHRoZSByZXR1cm4gdmFsdWUgb2YgZnVuY1NvdXJjZS4KICAvLwogIC8vIE5vdGUgdGhhdCBmdW5jU291cmNlIHNob3VsZCBub3QgQkUgdGhlIG5ldyBtZXRob2QsIGl0IHNob3VsZCBiZSBhIGZ1bmN0aW9uCiAgLy8gdGhhdCBSRVRVUk5TIHRoZSBuZXcgbWV0aG9kLiBmdW5jU291cmNlIHJlY2VpdmVzIGEgc2luZ2xlIGFyZ3VtZW50IHRoYXQgaXMKICAvLyB0aGUgb3ZlcnJpZGRlbiBtZXRob2QsIGl0IGNhbiBiZSBjYWxsZWQgZnJvbSB0aGUgbmV3IG1ldGhvZC4gVGhlIG92ZXJyaWRkZW4KICAvLyBtZXRob2QgY2FuIGJlIGNhbGxlZCBsaWtlIGEgcmVndWxhciBmdW5jdGlvbiwgaXQgaGFzIHRoZSB0YXJnZXQgcGVybWFuZW50bHkKICAvLyBib3VuZCB0byBpdCBzbyAidGhpcyIgd2lsbCB3b3JrIGNvcnJlY3RseS4KICBmdW5jdGlvbiBvdmVycmlkZU1ldGhvZCh0YXJnZXQsIG1ldGhvZE5hbWUsIGZ1bmNTb3VyY2UpIHsKICAgIHZhciBzdXBlckZ1bmMgPSB0YXJnZXRbbWV0aG9kTmFtZV0gfHwgZnVuY3Rpb24oKSB7fTsKICAgIHZhciBzdXBlckZ1bmNCb3VuZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3VwZXJGdW5jLmFwcGx5KHRhcmdldCwgYXJndW1lbnRzKTsKICAgIH07CiAgICB0YXJnZXRbbWV0aG9kTmFtZV0gPSBmdW5jU291cmNlKHN1cGVyRnVuY0JvdW5kKTsKICB9CgogIC8vIEFkZCBhIG1ldGhvZCB0byBkZWxlZ2F0b3IgdGhhdCwgd2hlbiBpbnZva2VkLCBjYWxscwogIC8vIGRlbGVnYXRlZS5tZXRob2ROYW1lLiBJZiB0aGVyZSBpcyBubyBzdWNoIG1ldGhvZCBvbgogIC8vIHRoZSBkZWxlZ2F0ZWUsIGJ1dCB0aGVyZSB3YXMgb25lIG9uIGRlbGVnYXRvciBiZWZvcmUKICAvLyBkZWxlZ2F0ZU1ldGhvZCB3YXMgY2FsbGVkLCB0aGVuIHRoZSBvcmlnaW5hbCB2ZXJzaW9uCiAgLy8gaXMgaW52b2tlZCBpbnN0ZWFkLgogIC8vIEZvciBleGFtcGxlOgogIC8vCiAgLy8gdmFyIGEgPSB7CiAgLy8gICBtZXRob2QxOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2ExJyk7IH0KICAvLyAgIG1ldGhvZDI6IGZ1bmN0aW9uKCkgeyBjb25zb2xlLmxvZygnYTInKTsgfQogIC8vIH07CiAgLy8gdmFyIGIgPSB7CiAgLy8gICBtZXRob2QxOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2IxJyk7IH0KICAvLyB9OwogIC8vIGRlbGVnYXRlTWV0aG9kKGEsIGIsICJtZXRob2QxIik7CiAgLy8gZGVsZWdhdGVNZXRob2QoYSwgYiwgIm1ldGhvZDIiKTsKICAvLyBhLm1ldGhvZDEoKTsKICAvLyBhLm1ldGhvZDIoKTsKICAvLwogIC8vIFRoZSBvdXRwdXQgd291bGQgYmUgImIxIiwgImEyIi4KICBmdW5jdGlvbiBkZWxlZ2F0ZU1ldGhvZChkZWxlZ2F0b3IsIGRlbGVnYXRlZSwgbWV0aG9kTmFtZSkgewogICAgdmFyIGluaGVyaXRlZCA9IGRlbGVnYXRvclttZXRob2ROYW1lXTsKICAgIGRlbGVnYXRvclttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGFyZ2V0ID0gZGVsZWdhdGVlOwogICAgICB2YXIgbWV0aG9kID0gZGVsZWdhdGVlW21ldGhvZE5hbWVdOwoKICAgICAgLy8gVGhlIG1ldGhvZCBkb2Vzbid0IGV4aXN0IG9uIHRoZSBkZWxlZ2F0ZWUuIEluc3RlYWQsCiAgICAgIC8vIGNhbGwgdGhlIG1ldGhvZCBvbiB0aGUgZGVsZWdhdG9yLCBpZiBpdCBleGlzdHMuCiAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgdGFyZ2V0ID0gZGVsZWdhdG9yOwogICAgICAgIG1ldGhvZCA9IGluaGVyaXRlZDsKICAgICAgfQoKICAgICAgaWYgKG1ldGhvZCkgewogICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGFyZ2V0LCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KCiAgLy8gSW1wbGVtZW50IGEgdmFndWUgZmFjc2ltaWxpZSBvZiBqUXVlcnkncyBkYXRhIG1ldGhvZAogIGZ1bmN0aW9uIGVsZW1lbnREYXRhKGVsLCBuYW1lLCB2YWx1ZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikgewogICAgICByZXR1cm4gZWxbImh0bWx3aWRnZXRfZGF0YV8iICsgbmFtZV07CiAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMykgewogICAgICBlbFsiaHRtbHdpZGdldF9kYXRhXyIgKyBuYW1lXSA9IHZhbHVlOwogICAgICByZXR1cm4gZWw7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIldyb25nIG51bWJlciBvZiBhcmd1bWVudHMgZm9yIGVsZW1lbnREYXRhOiAiICsKICAgICAgICBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0KICB9CgogIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzQ0NjE3MC9lc2NhcGUtc3RyaW5nLWZvci11c2UtaW4tamF2YXNjcmlwdC1yZWdleAogIGZ1bmN0aW9uIGVzY2FwZVJlZ0V4cChzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZSgvW1wtXFtcXVwvXHtcfVwoXClcKlwrXD9cLlxcXF5cJFx8XS9nLCAiXFwkJiIpOwogIH0KCiAgZnVuY3Rpb24gaGFzQ2xhc3MoZWwsIGNsYXNzTmFtZSkgewogICAgdmFyIHJlID0gbmV3IFJlZ0V4cCgiXFxiIiArIGVzY2FwZVJlZ0V4cChjbGFzc05hbWUpICsgIlxcYiIpOwogICAgcmV0dXJuIHJlLnRlc3QoZWwuY2xhc3NOYW1lKTsKICB9CgogIC8vIGVsZW1lbnRzIC0gYXJyYXkgKG9yIGFycmF5LWxpa2Ugb2JqZWN0KSBvZiBIVE1MIGVsZW1lbnRzCiAgLy8gY2xhc3NOYW1lIC0gY2xhc3MgbmFtZSB0byB0ZXN0IGZvcgogIC8vIGluY2x1ZGUgLSBpZiB0cnVlLCBvbmx5IHJldHVybiBlbGVtZW50cyB3aXRoIGdpdmVuIGNsYXNzTmFtZTsKICAvLyAgIGlmIGZhbHNlLCBvbmx5IHJldHVybiBlbGVtZW50cyAqd2l0aG91dCogZ2l2ZW4gY2xhc3NOYW1lCiAgZnVuY3Rpb24gZmlsdGVyQnlDbGFzcyhlbGVtZW50cywgY2xhc3NOYW1lLCBpbmNsdWRlKSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoaGFzQ2xhc3MoZWxlbWVudHNbaV0sIGNsYXNzTmFtZSkgPT0gaW5jbHVkZSkKICAgICAgICByZXN1bHRzLnB1c2goZWxlbWVudHNbaV0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfQoKICBmdW5jdGlvbiBvbihvYmosIGV2ZW50TmFtZSwgZnVuYykgewogICAgaWYgKG9iai5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgIG9iai5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgZnVuYywgZmFsc2UpOwogICAgfSBlbHNlIGlmIChvYmouYXR0YWNoRXZlbnQpIHsKICAgICAgb2JqLmF0dGFjaEV2ZW50KGV2ZW50TmFtZSwgZnVuYyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBvZmYob2JqLCBldmVudE5hbWUsIGZ1bmMpIHsKICAgIGlmIChvYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcikKICAgICAgb2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBmdW5jLCBmYWxzZSk7CiAgICBlbHNlIGlmIChvYmouZGV0YWNoRXZlbnQpIHsKICAgICAgb2JqLmRldGFjaEV2ZW50KGV2ZW50TmFtZSwgZnVuYyk7CiAgICB9CiAgfQoKICAvLyBUcmFuc2xhdGUgYXJyYXkgb2YgdmFsdWVzIHRvIHRvcC9yaWdodC9ib3R0b20vbGVmdCwgYXMgdXN1YWwgd2l0aAogIC8vIHRoZSAicGFkZGluZyIgQ1NTIHByb3BlcnR5CiAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQ1NTL3BhZGRpbmcKICBmdW5jdGlvbiB1bnBhY2tQYWRkaW5nKHZhbHVlKSB7CiAgICBpZiAodHlwZW9mKHZhbHVlKSA9PT0gIm51bWJlciIpCiAgICAgIHZhbHVlID0gW3ZhbHVlXTsKICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDEpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMF0sIGJvdHRvbTogdmFsdWVbMF0sIGxlZnQ6IHZhbHVlWzBdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDIpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMF0sIGxlZnQ6IHZhbHVlWzFdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDMpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMl0sIGxlZnQ6IHZhbHVlWzFdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDQpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMl0sIGxlZnQ6IHZhbHVlWzNdfTsKICAgIH0KICB9CgogIC8vIENvbnZlcnQgYW4gdW5wYWNrZWQgcGFkZGluZyBvYmplY3QgdG8gYSBDU1MgdmFsdWUKICBmdW5jdGlvbiBwYWRkaW5nVG9Dc3MocGFkZGluZ09iaikgewogICAgcmV0dXJuIHBhZGRpbmdPYmoudG9wICsgInB4ICIgKyBwYWRkaW5nT2JqLnJpZ2h0ICsgInB4ICIgKyBwYWRkaW5nT2JqLmJvdHRvbSArICJweCAiICsgcGFkZGluZ09iai5sZWZ0ICsgInB4IjsKICB9CgogIC8vIE1ha2VzIGEgbnVtYmVyIHN1aXRhYmxlIGZvciBDU1MKICBmdW5jdGlvbiBweCh4KSB7CiAgICBpZiAodHlwZW9mKHgpID09PSAibnVtYmVyIikKICAgICAgcmV0dXJuIHggKyAicHgiOwogICAgZWxzZQogICAgICByZXR1cm4geDsKICB9CgogIC8vIFJldHJpZXZlcyBydW50aW1lIHdpZGdldCBzaXppbmcgaW5mb3JtYXRpb24gZm9yIGFuIGVsZW1lbnQuCiAgLy8gVGhlIHJldHVybiB2YWx1ZSBpcyBlaXRoZXIgbnVsbCwgb3IgYW4gb2JqZWN0IHdpdGggZmlsbCwgcGFkZGluZywKICAvLyBkZWZhdWx0V2lkdGgsIGRlZmF1bHRIZWlnaHQgZmllbGRzLgogIGZ1bmN0aW9uIHNpemluZ1BvbGljeShlbCkgewogICAgdmFyIHNpemluZ0VsID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcigic2NyaXB0W2RhdGEtZm9yPSciICsgZWwuaWQgKyAiJ11bdHlwZT0nYXBwbGljYXRpb24vaHRtbHdpZGdldC1zaXppbmcnXSIpOwogICAgaWYgKCFzaXppbmdFbCkKICAgICAgcmV0dXJuIG51bGw7CiAgICB2YXIgc3AgPSBKU09OLnBhcnNlKHNpemluZ0VsLnRleHRDb250ZW50IHx8IHNpemluZ0VsLnRleHQgfHwgInt9Iik7CiAgICBpZiAodmlld2VyTW9kZSkgewogICAgICByZXR1cm4gc3Audmlld2VyOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHNwLmJyb3dzZXI7CiAgICB9CiAgfQoKICAvLyBAcGFyYW0gdGFza3MgQXJyYXkgb2Ygc3RyaW5ncyAob3IgZmFsc3kgdmFsdWUsIGluIHdoaWNoIGNhc2Ugbm8tb3ApLgogIC8vICAgRWFjaCBlbGVtZW50IG11c3QgYmUgYSB2YWxpZCBKYXZhU2NyaXB0IGV4cHJlc3Npb24gdGhhdCB5aWVsZHMgYQogIC8vICAgZnVuY3Rpb24uIE9yLCBjYW4gYmUgYW4gYXJyYXkgb2Ygb2JqZWN0cyB3aXRoICJjb2RlIiBhbmQgImRhdGEiCiAgLy8gICBwcm9wZXJ0aWVzOyBpbiB0aGlzIGNhc2UsIHRoZSAiY29kZSIgcHJvcGVydHkgc2hvdWxkIGJlIGEgc3RyaW5nCiAgLy8gICBvZiBKUyB0aGF0J3MgYW4gZXhwciB0aGF0IHlpZWxkcyBhIGZ1bmN0aW9uLCBhbmQgImRhdGEiIHNob3VsZCBiZQogIC8vICAgYW4gb2JqZWN0IHRoYXQgd2lsbCBiZSBhZGRlZCBhcyBhbiBhZGRpdGlvbmFsIGFyZ3VtZW50IHdoZW4gdGhhdAogIC8vICAgZnVuY3Rpb24gaXMgY2FsbGVkLgogIC8vIEBwYXJhbSB0YXJnZXQgVGhlIG9iamVjdCB0aGF0IHdpbGwgYmUgInRoaXMiIGZvciBlYWNoIGZ1bmN0aW9uCiAgLy8gICBleGVjdXRpb24uCiAgLy8gQHBhcmFtIGFyZ3MgQXJyYXkgb2YgYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byB0aGUgZnVuY3Rpb25zLiAoVGhlCiAgLy8gICBzYW1lIGFyZ3VtZW50cyB3aWxsIGJlIHBhc3NlZCB0byBhbGwgZnVuY3Rpb25zLikKICBmdW5jdGlvbiBldmFsQW5kUnVuKHRhc2tzLCB0YXJnZXQsIGFyZ3MpIHsKICAgIGlmICh0YXNrcykgewogICAgICBmb3JFYWNoKHRhc2tzLCBmdW5jdGlvbih0YXNrKSB7CiAgICAgICAgdmFyIHRoZXNlQXJncyA9IGFyZ3M7CiAgICAgICAgaWYgKHR5cGVvZih0YXNrKSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHRoZXNlQXJncyA9IHRoZXNlQXJncy5jb25jYXQoW3Rhc2suZGF0YV0pOwogICAgICAgICAgdGFzayA9IHRhc2suY29kZTsKICAgICAgICB9CiAgICAgICAgdmFyIHRhc2tGdW5jID0gZXZhbCgiKCIgKyB0YXNrICsgIikiKTsKICAgICAgICBpZiAodHlwZW9mKHRhc2tGdW5jKSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXNrIG11c3QgYmUgYSBmdW5jdGlvbiEgU291cmNlOlxuIiArIHRhc2spOwogICAgICAgIH0KICAgICAgICB0YXNrRnVuYy5hcHBseSh0YXJnZXQsIHRoZXNlQXJncyk7CiAgICAgIH0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5pdFNpemluZyhlbCkgewogICAgdmFyIHNpemluZyA9IHNpemluZ1BvbGljeShlbCk7CiAgICBpZiAoIXNpemluZykKICAgICAgcmV0dXJuOwoKICAgIHZhciBjZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiaHRtbHdpZGdldF9jb250YWluZXIiKTsKICAgIGlmICghY2VsKQogICAgICByZXR1cm47CgogICAgaWYgKHR5cGVvZihzaXppbmcucGFkZGluZykgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUubWFyZ2luID0gIjAiOwogICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLnBhZGRpbmcgPSBwYWRkaW5nVG9Dc3ModW5wYWNrUGFkZGluZyhzaXppbmcucGFkZGluZykpOwogICAgfQoKICAgIGlmIChzaXppbmcuZmlsbCkgewogICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiI7CiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUuaGVpZ2h0ID0gIjEwMCUiOwogICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5oZWlnaHQgPSAiMTAwJSI7CiAgICAgIGlmIChjZWwpIHsKICAgICAgICBjZWwuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgICAgIHZhciBwYWQgPSB1bnBhY2tQYWRkaW5nKHNpemluZy5wYWRkaW5nKTsKICAgICAgICBjZWwuc3R5bGUudG9wID0gcGFkLnRvcCArICJweCI7CiAgICAgICAgY2VsLnN0eWxlLnJpZ2h0ID0gcGFkLnJpZ2h0ICsgInB4IjsKICAgICAgICBjZWwuc3R5bGUuYm90dG9tID0gcGFkLmJvdHRvbSArICJweCI7CiAgICAgICAgY2VsLnN0eWxlLmxlZnQgPSBwYWQubGVmdCArICJweCI7CiAgICAgICAgZWwuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgICAgZWwuc3R5bGUuaGVpZ2h0ID0gIjEwMCUiOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGdldFdpZHRoOiBmdW5jdGlvbigpIHsgcmV0dXJuIGNlbC5vZmZzZXRXaWR0aDsgfSwKICAgICAgICBnZXRIZWlnaHQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gY2VsLm9mZnNldEhlaWdodDsgfQogICAgICB9OwoKICAgIH0gZWxzZSB7CiAgICAgIGVsLnN0eWxlLndpZHRoID0gcHgoc2l6aW5nLndpZHRoKTsKICAgICAgZWwuc3R5bGUuaGVpZ2h0ID0gcHgoc2l6aW5nLmhlaWdodCk7CgogICAgICByZXR1cm4gewogICAgICAgIGdldFdpZHRoOiBmdW5jdGlvbigpIHsgcmV0dXJuIGVsLm9mZnNldFdpZHRoOyB9LAogICAgICAgIGdldEhlaWdodDogZnVuY3Rpb24oKSB7IHJldHVybiBlbC5vZmZzZXRIZWlnaHQ7IH0KICAgICAgfTsKICAgIH0KICB9CgogIC8vIERlZmF1bHQgaW1wbGVtZW50YXRpb25zIGZvciBtZXRob2RzCiAgdmFyIGRlZmF1bHRzID0gewogICAgZmluZDogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgcmV0dXJuIHF1ZXJ5U2VsZWN0b3JBbGwoc2NvcGUsICIuIiArIHRoaXMubmFtZSk7CiAgICB9LAogICAgcmVuZGVyRXJyb3I6IGZ1bmN0aW9uKGVsLCBlcnIpIHsKICAgICAgdmFyICRlbCA9ICQoZWwpOwoKICAgICAgdGhpcy5jbGVhckVycm9yKGVsKTsKCiAgICAgIC8vIEFkZCBhbGwgdGhlc2UgZXJyb3IgY2xhc3NlcywgYXMgU2hpbnkgZG9lcwogICAgICB2YXIgZXJyQ2xhc3MgPSAic2hpbnktb3V0cHV0LWVycm9yIjsKICAgICAgaWYgKGVyci50eXBlICE9PSBudWxsKSB7CiAgICAgICAgLy8gdXNlIHRoZSBjbGFzc2VzIG9mIHRoZSBlcnJvciBjb25kaXRpb24gYXMgQ1NTIGNsYXNzIG5hbWVzCiAgICAgICAgZXJyQ2xhc3MgPSBlcnJDbGFzcyArICIgIiArICQubWFwKGFzQXJyYXkoZXJyLnR5cGUpLCBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICByZXR1cm4gZXJyQ2xhc3MgKyAiLSIgKyB0eXBlOwogICAgICAgIH0pLmpvaW4oIiAiKTsKICAgICAgfQogICAgICBlcnJDbGFzcyA9IGVyckNsYXNzICsgIiBodG1sd2lkZ2V0cy1lcnJvciI7CgogICAgICAvLyBJcyBlbCBpbmxpbmUgb3IgYmxvY2s/IElmIGlubGluZSBvciBpbmxpbmUtYmxvY2ssIGp1c3QgZGlzcGxheTpub25lIGl0CiAgICAgIC8vIGFuZCBhZGQgYW4gaW5saW5lIGVycm9yLgogICAgICB2YXIgZGlzcGxheSA9ICRlbC5jc3MoImRpc3BsYXkiKTsKICAgICAgJGVsLmRhdGEoInJlc3RvcmUtZGlzcGxheS1tb2RlIiwgZGlzcGxheSk7CgogICAgICBpZiAoZGlzcGxheSA9PT0gImlubGluZSIgfHwgZGlzcGxheSA9PT0gImlubGluZS1ibG9jayIpIHsKICAgICAgICAkZWwuaGlkZSgpOwogICAgICAgIGlmIChlcnIubWVzc2FnZSAhPT0gIiIpIHsKICAgICAgICAgIHZhciBlcnJvclNwYW4gPSAkKCI8c3Bhbj4iKS5hZGRDbGFzcyhlcnJDbGFzcyk7CiAgICAgICAgICBlcnJvclNwYW4udGV4dChlcnIubWVzc2FnZSk7CiAgICAgICAgICAkZWwuYWZ0ZXIoZXJyb3JTcGFuKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZGlzcGxheSA9PT0gImJsb2NrIikgewogICAgICAgIC8vIElmIGJsb2NrLCBhZGQgYW4gZXJyb3IganVzdCBhZnRlciB0aGUgZWwsIHNldCB2aXNpYmlsaXR5Om5vbmUgb24gdGhlCiAgICAgICAgLy8gZWwsIGFuZCBwb3NpdGlvbiB0aGUgZXJyb3IgdG8gYmUgb24gdG9wIG9mIHRoZSBlbC4KICAgICAgICAvLyBNYXJrIGl0IHdpdGggYSB1bmlxdWUgSUQgYW5kIENTUyBjbGFzcyBzbyB3ZSBjYW4gcmVtb3ZlIGl0IGxhdGVyLgogICAgICAgICRlbC5jc3MoInZpc2liaWxpdHkiLCAiaGlkZGVuIik7CiAgICAgICAgaWYgKGVyci5tZXNzYWdlICE9PSAiIikgewogICAgICAgICAgdmFyIGVycm9yRGl2ID0gJCgiPGRpdj4iKS5hZGRDbGFzcyhlcnJDbGFzcykuY3NzKCJwb3NpdGlvbiIsICJhYnNvbHV0ZSIpCiAgICAgICAgICAgIC5jc3MoInRvcCIsIGVsLm9mZnNldFRvcCkKICAgICAgICAgICAgLmNzcygibGVmdCIsIGVsLm9mZnNldExlZnQpCiAgICAgICAgICAgIC8vIHNldHRpbmcgd2lkdGggY2FuIHB1c2ggb3V0IHRoZSBwYWdlIHNpemUsIGZvcmNpbmcgb3RoZXJ3aXNlCiAgICAgICAgICAgIC8vIHVubmVjZXNzYXJ5IHNjcm9sbGJhcnMgdG8gYXBwZWFyIGFuZCBtYWtpbmcgaXQgaW1wb3NzaWJsZSBmb3IKICAgICAgICAgICAgLy8gdGhlIGVsZW1lbnQgdG8gc2hyaW5rOyBzbyB1c2UgbWF4LXdpZHRoIGluc3RlYWQKICAgICAgICAgICAgLmNzcygibWF4V2lkdGgiLCBlbC5vZmZzZXRXaWR0aCkKICAgICAgICAgICAgLmNzcygiaGVpZ2h0IiwgZWwub2Zmc2V0SGVpZ2h0KTsKICAgICAgICAgIGVycm9yRGl2LnRleHQoZXJyLm1lc3NhZ2UpOwogICAgICAgICAgJGVsLmFmdGVyKGVycm9yRGl2KTsKCiAgICAgICAgICAvLyBSZWFsbHkgZHVtYiB3YXkgdG8ga2VlcCB0aGUgc2l6ZS9wb3NpdGlvbiBvZiB0aGUgZXJyb3IgaW4gc3luYyB3aXRoCiAgICAgICAgICAvLyB0aGUgcGFyZW50IGVsZW1lbnQgYXMgdGhlIHdpbmRvdyBpcyByZXNpemVkIG9yIHdoYXRldmVyLgogICAgICAgICAgdmFyIGludElkID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZXJyb3JEaXZbMF0ucGFyZW50RWxlbWVudCkgewogICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50SWQpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlcnJvckRpdgogICAgICAgICAgICAgIC5jc3MoInRvcCIsIGVsLm9mZnNldFRvcCkKICAgICAgICAgICAgICAuY3NzKCJsZWZ0IiwgZWwub2Zmc2V0TGVmdCkKICAgICAgICAgICAgICAuY3NzKCJtYXhXaWR0aCIsIGVsLm9mZnNldFdpZHRoKQogICAgICAgICAgICAgIC5jc3MoImhlaWdodCIsIGVsLm9mZnNldEhlaWdodCk7CiAgICAgICAgICB9LCA1MDApOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGNsZWFyRXJyb3I6IGZ1bmN0aW9uKGVsKSB7CiAgICAgIHZhciAkZWwgPSAkKGVsKTsKICAgICAgdmFyIGRpc3BsYXkgPSAkZWwuZGF0YSgicmVzdG9yZS1kaXNwbGF5LW1vZGUiKTsKICAgICAgJGVsLmRhdGEoInJlc3RvcmUtZGlzcGxheS1tb2RlIiwgbnVsbCk7CgogICAgICBpZiAoZGlzcGxheSA9PT0gImlubGluZSIgfHwgZGlzcGxheSA9PT0gImlubGluZS1ibG9jayIpIHsKICAgICAgICBpZiAoZGlzcGxheSkKICAgICAgICAgICRlbC5jc3MoImRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICAkKGVsLm5leHRTaWJsaW5nKS5maWx0ZXIoIi5odG1sd2lkZ2V0cy1lcnJvciIpLnJlbW92ZSgpOwogICAgICB9IGVsc2UgaWYgKGRpc3BsYXkgPT09ICJibG9jayIpewogICAgICAgICRlbC5jc3MoInZpc2liaWxpdHkiLCAiaW5oZXJpdCIpOwogICAgICAgICQoZWwubmV4dFNpYmxpbmcpLmZpbHRlcigiLmh0bWx3aWRnZXRzLWVycm9yIikucmVtb3ZlKCk7CiAgICAgIH0KICAgIH0sCiAgICBzaXppbmc6IHt9CiAgfTsKCiAgLy8gQ2FsbGVkIGJ5IHdpZGdldCBiaW5kaW5ncyB0byByZWdpc3RlciBhIG5ldyB0eXBlIG9mIHdpZGdldC4gVGhlIGRlZmluaXRpb24KICAvLyBvYmplY3QgY2FuIGNvbnRhaW4gdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogIC8vIC0gbmFtZSAocmVxdWlyZWQpIC0gQSBzdHJpbmcgaW5kaWNhdGluZyB0aGUgYmluZGluZyBuYW1lLCB3aGljaCB3aWxsIGJlCiAgLy8gICB1c2VkIGJ5IGRlZmF1bHQgYXMgdGhlIENTUyBjbGFzc25hbWUgdG8gbG9vayBmb3IuCiAgLy8gLSBpbml0aWFsaXplIChvcHRpb25hbCkgLSBBIGZ1bmN0aW9uKGVsKSB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgcGVyCiAgLy8gICB3aWRnZXQgZWxlbWVudDsgaWYgYSB2YWx1ZSBpcyByZXR1cm5lZCwgaXQgd2lsbCBiZSBwYXNzZWQgYXMgdGhlIHRoaXJkCiAgLy8gICB2YWx1ZSB0byByZW5kZXJWYWx1ZS4KICAvLyAtIHJlbmRlclZhbHVlIChyZXF1aXJlZCkgLSBBIGZ1bmN0aW9uKGVsLCBkYXRhLCBpbml0VmFsdWUpIHRoYXQgd2lsbCBiZQogIC8vICAgY2FsbGVkIHdpdGggZGF0YS4gU3RhdGljIGNvbnRleHRzIHdpbGwgY2F1c2UgdGhpcyB0byBiZSBjYWxsZWQgb25jZSBwZXIKICAvLyAgIGVsZW1lbnQ7IFNoaW55IGFwcHMgd2lsbCBjYXVzZSB0aGlzIHRvIGJlIGNhbGxlZCBtdWx0aXBsZSB0aW1lcyBwZXIKICAvLyAgIGVsZW1lbnQsIGFzIHRoZSBkYXRhIGNoYW5nZXMuCiAgd2luZG93LkhUTUxXaWRnZXRzLndpZGdldCA9IGZ1bmN0aW9uKGRlZmluaXRpb24pIHsKICAgIGlmICghZGVmaW5pdGlvbi5uYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2lkZ2V0IG11c3QgaGF2ZSBhIG5hbWUiKTsKICAgIH0KICAgIGlmICghZGVmaW5pdGlvbi50eXBlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2lkZ2V0IG11c3QgaGF2ZSBhIHR5cGUiKTsKICAgIH0KICAgIC8vIEN1cnJlbnRseSB3ZSBvbmx5IHN1cHBvcnQgb3V0cHV0IHdpZGdldHMKICAgIGlmIChkZWZpbml0aW9uLnR5cGUgIT09ICJvdXRwdXQiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5yZWNvZ25pemVkIHdpZGdldCB0eXBlICciICsgZGVmaW5pdGlvbi50eXBlICsgIiciKTsKICAgIH0KICAgIC8vIFRPRE86IFZlcmlmeSB0aGF0IC5uYW1lIGlzIGEgdmFsaWQgQ1NTIGNsYXNzbmFtZQoKICAgIC8vIFN1cHBvcnQgbmV3LXN0eWxlIGluc3RhbmNlLWJvdW5kIGRlZmluaXRpb25zLiBPbGQtc3R5bGUgY2xhc3MtYm91bmQKICAgIC8vIGRlZmluaXRpb25zIGhhdmUgb25lIHdpZGdldCAib2JqZWN0IiBwZXIgd2lkZ2V0IHBlciB0eXBlL2NsYXNzIG9mCiAgICAvLyB3aWRnZXQ7IHRoZSByZW5kZXJWYWx1ZSBhbmQgcmVzaXplIG1ldGhvZHMgb24gc3VjaCB3aWRnZXQgb2JqZWN0cwogICAgLy8gdGFrZSBlbCBhbmQgaW5zdGFuY2UgYXJndW1lbnRzLCBiZWNhdXNlIHRoZSB3aWRnZXQgb2JqZWN0IGNhbid0CiAgICAvLyBzdG9yZSB0aGVtLiBOZXctc3R5bGUgaW5zdGFuY2UtYm91bmQgZGVmaW5pdGlvbnMgaGF2ZSBvbmUgd2lkZ2V0CiAgICAvLyBvYmplY3QgcGVyIHdpZGdldCBpbnN0YW5jZTsgdGhlIGRlZmluaXRpb24gdGhhdCdzIHBhc3NlZCBpbiBkb2Vzbid0CiAgICAvLyBwcm92aWRlIHJlbmRlclZhbHVlIG9yIHJlc2l6ZSBtZXRob2RzIGF0IGFsbCwganVzdCB0aGUgc2luZ2xlIG1ldGhvZAogICAgLy8gICBmYWN0b3J5KGVsLCB3aWR0aCwgaGVpZ2h0KQogICAgLy8gd2hpY2ggcmV0dXJucyBhbiBvYmplY3QgdGhhdCBoYXMgcmVuZGVyVmFsdWUoeCkgYW5kIHJlc2l6ZSh3LCBoKS4KICAgIC8vIFRoaXMgZW5hYmxlcyBhIGZhciBtb3JlIG5hdHVyYWwgcHJvZ3JhbW1pbmcgc3R5bGUgZm9yIHRoZSB3aWRnZXQKICAgIC8vIGF1dGhvciwgd2hvIGNhbiBzdG9yZSBwZXItaW5zdGFuY2Ugc3RhdGUgdXNpbmcgZWl0aGVyIE9PLXN0eWxlCiAgICAvLyBpbnN0YW5jZSBmaWVsZHMgb3IgZnVuY3Rpb25hbC1zdHlsZSBjbG9zdXJlIHZhcmlhYmxlcyAoSSBndWVzcyB0aGlzCiAgICAvLyBpcyBpbiBjb250cmFzdCB0byB3aGF0IGNhbiBvbmx5IGJlIGNhbGxlZCBDLXN0eWxlIHBzZXVkby1PTyB3aGljaCBpcwogICAgLy8gd2hhdCB3ZSByZXF1aXJlZCBiZWZvcmUpLgogICAgaWYgKGRlZmluaXRpb24uZmFjdG9yeSkgewogICAgICBkZWZpbml0aW9uID0gY3JlYXRlTGVnYWN5RGVmaW5pdGlvbkFkYXB0ZXIoZGVmaW5pdGlvbik7CiAgICB9CgogICAgaWYgKCFkZWZpbml0aW9uLnJlbmRlclZhbHVlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV2lkZ2V0IG11c3QgaGF2ZSBhIHJlbmRlclZhbHVlIGZ1bmN0aW9uIik7CiAgICB9CgogICAgLy8gRm9yIHN0YXRpYyByZW5kZXJpbmcgKG5vbi1TaGlueSksIHVzZSBhIHNpbXBsZSB3aWRnZXQgcmVnaXN0cmF0aW9uCiAgICAvLyBzY2hlbWUuIFdlIGFsc28gdXNlIHRoaXMgc2NoZW1lIGZvciBTaGlueSBhcHBzL2RvY3VtZW50cyB0aGF0IGFsc28KICAgIC8vIGNvbnRhaW4gc3RhdGljIHdpZGdldHMuCiAgICB3aW5kb3cuSFRNTFdpZGdldHMud2lkZ2V0cyA9IHdpbmRvdy5IVE1MV2lkZ2V0cy53aWRnZXRzIHx8IFtdOwogICAgLy8gTWVyZ2UgZGVmYXVsdHMgaW50byB0aGUgZGVmaW5pdGlvbjsgZG9uJ3QgbXV0YXRlIHRoZSBvcmlnaW5hbCBkZWZpbml0aW9uLgogICAgdmFyIHN0YXRpY0JpbmRpbmcgPSBleHRlbmQoe30sIGRlZmF1bHRzLCBkZWZpbml0aW9uKTsKICAgIG92ZXJyaWRlTWV0aG9kKHN0YXRpY0JpbmRpbmcsICJmaW5kIiwgZnVuY3Rpb24oc3VwZXJmdW5jKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSkgewogICAgICAgIHZhciByZXN1bHRzID0gc3VwZXJmdW5jKHNjb3BlKTsKICAgICAgICAvLyBGaWx0ZXIgb3V0IFNoaW55IG91dHB1dHMsIHdlIG9ubHkgd2FudCB0aGUgc3RhdGljIGtpbmQKICAgICAgICByZXR1cm4gZmlsdGVyQnlDbGFzcyhyZXN1bHRzLCAiaHRtbC13aWRnZXQtb3V0cHV0IiwgZmFsc2UpOwogICAgICB9OwogICAgfSk7CiAgICB3aW5kb3cuSFRNTFdpZGdldHMud2lkZ2V0cy5wdXNoKHN0YXRpY0JpbmRpbmcpOwoKICAgIGlmIChzaGlueU1vZGUpIHsKICAgICAgLy8gU2hpbnkgaXMgcnVubmluZy4gUmVnaXN0ZXIgdGhlIGRlZmluaXRpb24gd2l0aCBhbiBvdXRwdXQgYmluZGluZy4KICAgICAgLy8gVGhlIGRlZmluaXRpb24gaXRzZWxmIHdpbGwgbm90IGJlIHRoZSBvdXRwdXQgYmluZGluZywgaW5zdGVhZAogICAgICAvLyB3ZSB3aWxsIG1ha2UgYW4gb3V0cHV0IGJpbmRpbmcgb2JqZWN0IHRoYXQgZGVsZWdhdGVzIHRvIHRoZQogICAgICAvLyBkZWZpbml0aW9uLiBUaGlzIGlzIGJlY2F1c2Ugd2UgZm9vbGlzaGx5IHVzZWQgdGhlIHNhbWUgbWV0aG9kCiAgICAgIC8vIG5hbWUgKHJlbmRlclZhbHVlKSBmb3IgaHRtbHdpZGdldHMgZGVmaW5pdGlvbiBhbmQgU2hpbnkgYmluZGluZ3MKICAgICAgLy8gYnV0IHRoZXkgYWN0dWFsbHkgaGF2ZSBxdWl0ZSBkaWZmZXJlbnQgc2VtYW50aWNzICh0aGUgU2hpbnkKICAgICAgLy8gYmluZGluZ3MgcmVjZWl2ZSBkYXRhIHRoYXQgaW5jbHVkZXMgbG90cyBvZiBtZXRhZGF0YSB0aGF0IGl0CiAgICAgIC8vIHN0cmlwcyBvZmYgYmVmb3JlIGNhbGxpbmcgaHRtbHdpZGdldHMgcmVuZGVyVmFsdWUpLiBXZSBjYW4ndAogICAgICAvLyBqdXN0IGlnbm9yZSB0aGUgZGlmZmVyZW5jZSBiZWNhdXNlIGluIHNvbWUgd2lkZ2V0cyBpdCdzIGhlbHBmdWwKICAgICAgLy8gdG8gY2FsbCB0aGlzLnJlbmRlclZhbHVlKCkgZnJvbSBpbnNpZGUgb2YgcmVzaXplKCksIGFuZCBpZgogICAgICAvLyB3ZSdyZSBub3QgZGVsZWdhdGluZywgdGhlbiB0aGF0IGNhbGwgd2lsbCBnbyB0byB0aGUgU2hpbnkKICAgICAgLy8gdmVyc2lvbiBpbnN0ZWFkIG9mIHRoZSBodG1sd2lkZ2V0cyB2ZXJzaW9uLgoKICAgICAgLy8gTWVyZ2UgZGVmYXVsdHMgd2l0aCBkZWZpbml0aW9uLCB3aXRob3V0IG11dGF0aW5nIGVpdGhlci4KICAgICAgdmFyIGJpbmRpbmdEZWYgPSBleHRlbmQoe30sIGRlZmF1bHRzLCBkZWZpbml0aW9uKTsKCiAgICAgIC8vIFRoaXMgb2JqZWN0IHdpbGwgYmUgb3VyIGFjdHVhbCBTaGlueSBiaW5kaW5nLgogICAgICB2YXIgc2hpbnlCaW5kaW5nID0gbmV3IFNoaW55Lk91dHB1dEJpbmRpbmcoKTsKCiAgICAgIC8vIFdpdGggYSBmZXcgZXhjZXB0aW9ucywgd2UnbGwgd2FudCB0byBzaW1wbHkgdXNlIHRoZSBiaW5kaW5nRGVmJ3MKICAgICAgLy8gdmVyc2lvbiBvZiBtZXRob2RzIGlmIHRoZXkgYXJlIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIGZhbGwgYmFjayB0bwogICAgICAvLyBTaGlueSdzIGRlZmF1bHRzLiBOT1RFOiBJZiBTaGlueSdzIG91dHB1dCBiaW5kaW5ncyBnYWluIGFkZGl0aW9uYWwKICAgICAgLy8gbWV0aG9kcyBpbiB0aGUgZnV0dXJlLCBhbmQgd2Ugd2FudCB0aGVtIHRvIGJlIG92ZXJyaWRlYWJsZSBieQogICAgICAvLyBIVE1MV2lkZ2V0IGJpbmRpbmcgZGVmaW5pdGlvbnMsIHRoZW4gd2UnbGwgbmVlZCB0byBhZGQgdGhlbSB0byB0aGlzCiAgICAgIC8vIGxpc3QuCiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgImdldElkIik7CiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgIm9uVmFsdWVDaGFuZ2UiKTsKICAgICAgZGVsZWdhdGVNZXRob2Qoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLCAib25WYWx1ZUVycm9yIik7CiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgInJlbmRlckVycm9yIik7CiAgICAgIGRlbGVnYXRlTWV0aG9kKHNoaW55QmluZGluZywgYmluZGluZ0RlZiwgImNsZWFyRXJyb3IiKTsKICAgICAgZGVsZWdhdGVNZXRob2Qoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLCAic2hvd1Byb2dyZXNzIik7CgogICAgICAvLyBUaGUgZmluZCwgcmVuZGVyVmFsdWUsIGFuZCByZXNpemUgYXJlIGhhbmRsZWQgZGlmZmVyZW50bHksIGJlY2F1c2Ugd2UKICAgICAgLy8gd2FudCB0byBhY3R1YWxseSBkZWNvcmF0ZSB0aGUgYmVoYXZpb3Igb2YgdGhlIGJpbmRpbmdEZWYgbWV0aG9kcy4KCiAgICAgIHNoaW55QmluZGluZy5maW5kID0gZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICB2YXIgcmVzdWx0cyA9IGJpbmRpbmdEZWYuZmluZChzY29wZSk7CgogICAgICAgIC8vIE9ubHkgcmV0dXJuIGVsZW1lbnRzIHRoYXQgYXJlIFNoaW55IG91dHB1dHMsIG5vdCBzdGF0aWMgb25lcwogICAgICAgIHZhciBkeW5hbWljUmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKCIuaHRtbC13aWRnZXQtb3V0cHV0Iik7CgogICAgICAgIC8vIEl0J3MgcG9zc2libGUgdGhhdCB3aGF0ZXZlciBjYXVzZWQgU2hpbnkgdG8gdGhpbmsgdGhlcmUgbWlnaHQgYmUKICAgICAgICAvLyBuZXcgZHluYW1pYyBvdXRwdXRzLCBhbHNvIGNhdXNlZCB0aGVyZSB0byBiZSBuZXcgc3RhdGljIG91dHB1dHMuCiAgICAgICAgLy8gU2luY2UgdGhlcmUgbWlnaHQgYmUgbG90cyBvZiBkaWZmZXJlbnQgaHRtbHdpZGdldHMgYmluZGluZ3MsIHdlCiAgICAgICAgLy8gc2NoZWR1bGUgZXhlY3V0aW9uIGZvciBsYXRlci0tbm8gbmVlZCB0byBzdGF0aWNSZW5kZXIgbXVsdGlwbGUKICAgICAgICAvLyB0aW1lcy4KICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggIT09IGR5bmFtaWNSZXN1bHRzLmxlbmd0aCkKICAgICAgICAgIHNjaGVkdWxlU3RhdGljUmVuZGVyKCk7CgogICAgICAgIHJldHVybiBkeW5hbWljUmVzdWx0czsKICAgICAgfTsKCiAgICAgIC8vIFdyYXAgcmVuZGVyVmFsdWUgdG8gaGFuZGxlIGluaXRpYWxpemF0aW9uLCB3aGljaCB1bmZvcnR1bmF0ZWx5IGlzbid0CiAgICAgIC8vIHN1cHBvcnRlZCBuYXRpdmVseSBieSBTaGlueSBhdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcuCgogICAgICBzaGlueUJpbmRpbmcucmVuZGVyVmFsdWUgPSBmdW5jdGlvbihlbCwgZGF0YSkgewogICAgICAgIFNoaW55LnJlbmRlckRlcGVuZGVuY2llcyhkYXRhLmRlcHMpOwogICAgICAgIC8vIFJlc29sdmUgc3RyaW5ncyBtYXJrZWQgYXMgamF2YXNjcmlwdCBsaXRlcmFscyB0byBvYmplY3RzCiAgICAgICAgaWYgKCEoZGF0YS5ldmFscyBpbnN0YW5jZW9mIEFycmF5KSkgZGF0YS5ldmFscyA9IFtkYXRhLmV2YWxzXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgZGF0YS5ldmFscyAmJiBpIDwgZGF0YS5ldmFscy5sZW5ndGg7IGkrKykgewogICAgICAgICAgd2luZG93LkhUTUxXaWRnZXRzLmV2YWx1YXRlU3RyaW5nTWVtYmVyKGRhdGEueCwgZGF0YS5ldmFsc1tpXSk7CiAgICAgICAgfQogICAgICAgIGlmICghYmluZGluZ0RlZi5yZW5kZXJPbk51bGxWYWx1ZSkgewogICAgICAgICAgaWYgKGRhdGEueCA9PT0gbnVsbCkgewogICAgICAgICAgICBlbC5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVsLnN0eWxlLnZpc2liaWxpdHkgPSAiaW5oZXJpdCI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghZWxlbWVudERhdGEoZWwsICJpbml0aWFsaXplZCIpKSB7CiAgICAgICAgICBpbml0U2l6aW5nKGVsKTsKCiAgICAgICAgICBlbGVtZW50RGF0YShlbCwgImluaXRpYWxpemVkIiwgdHJ1ZSk7CiAgICAgICAgICBpZiAoYmluZGluZ0RlZi5pbml0aWFsaXplKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBiaW5kaW5nRGVmLmluaXRpYWxpemUoZWwsIGVsLm9mZnNldFdpZHRoLAogICAgICAgICAgICAgIGVsLm9mZnNldEhlaWdodCk7CiAgICAgICAgICAgIGVsZW1lbnREYXRhKGVsLCAiaW5pdF9yZXN1bHQiLCByZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBiaW5kaW5nRGVmLnJlbmRlclZhbHVlKGVsLCBkYXRhLngsIGVsZW1lbnREYXRhKGVsLCAiaW5pdF9yZXN1bHQiKSk7CiAgICAgICAgZXZhbEFuZFJ1bihkYXRhLmpzSG9va3MucmVuZGVyLCBlbGVtZW50RGF0YShlbCwgImluaXRfcmVzdWx0IiksIFtlbCwgZGF0YS54XSk7CiAgICAgIH07CgogICAgICAvLyBPbmx5IG92ZXJyaWRlIHJlc2l6ZSBpZiBiaW5kaW5nRGVmIGltcGxlbWVudHMgaXQKICAgICAgaWYgKGJpbmRpbmdEZWYucmVzaXplKSB7CiAgICAgICAgc2hpbnlCaW5kaW5nLnJlc2l6ZSA9IGZ1bmN0aW9uKGVsLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAvLyBTaGlueSBjYW4gY2FsbCByZXNpemUgYmVmb3JlIGluaXRpYWxpemUvcmVuZGVyVmFsdWUgaGF2ZSBiZWVuCiAgICAgICAgICAvLyBjYWxsZWQsIHdoaWNoIGRvZXNuJ3QgbWFrZSBzZW5zZSBmb3Igd2lkZ2V0cy4KICAgICAgICAgIGlmIChlbGVtZW50RGF0YShlbCwgImluaXRpYWxpemVkIikpIHsKICAgICAgICAgICAgYmluZGluZ0RlZi5yZXNpemUoZWwsIHdpZHRoLCBoZWlnaHQsIGVsZW1lbnREYXRhKGVsLCAiaW5pdF9yZXN1bHQiKSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgU2hpbnkub3V0cHV0QmluZGluZ3MucmVnaXN0ZXIoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLm5hbWUpOwogICAgfQogIH07CgogIHZhciBzY2hlZHVsZVN0YXRpY1JlbmRlclRpbWVySWQgPSBudWxsOwogIGZ1bmN0aW9uIHNjaGVkdWxlU3RhdGljUmVuZGVyKCkgewogICAgaWYgKCFzY2hlZHVsZVN0YXRpY1JlbmRlclRpbWVySWQpIHsKICAgICAgc2NoZWR1bGVTdGF0aWNSZW5kZXJUaW1lcklkID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBzY2hlZHVsZVN0YXRpY1JlbmRlclRpbWVySWQgPSBudWxsOwogICAgICAgIHdpbmRvdy5IVE1MV2lkZ2V0cy5zdGF0aWNSZW5kZXIoKTsKICAgICAgfSwgMSk7CiAgICB9CiAgfQoKICAvLyBSZW5kZXIgc3RhdGljIHdpZGdldHMgYWZ0ZXIgdGhlIGRvY3VtZW50IGZpbmlzaGVzIGxvYWRpbmcKICAvLyBTdGF0aWNhbGx5IHJlbmRlciBhbGwgZWxlbWVudHMgdGhhdCBhcmUgb2YgdGhpcyB3aWRnZXQncyBjbGFzcwogIHdpbmRvdy5IVE1MV2lkZ2V0cy5zdGF0aWNSZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgIHZhciBiaW5kaW5ncyA9IHdpbmRvdy5IVE1MV2lkZ2V0cy53aWRnZXRzIHx8IFtdOwogICAgZm9yRWFjaChiaW5kaW5ncywgZnVuY3Rpb24oYmluZGluZykgewogICAgICB2YXIgbWF0Y2hlcyA9IGJpbmRpbmcuZmluZChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpOwogICAgICBmb3JFYWNoKG1hdGNoZXMsIGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgdmFyIHNpemVPYmogPSBpbml0U2l6aW5nKGVsLCBiaW5kaW5nKTsKCiAgICAgICAgaWYgKGhhc0NsYXNzKGVsLCAiaHRtbC13aWRnZXQtc3RhdGljLWJvdW5kIikpCiAgICAgICAgICByZXR1cm47CiAgICAgICAgZWwuY2xhc3NOYW1lID0gZWwuY2xhc3NOYW1lICsgIiBodG1sLXdpZGdldC1zdGF0aWMtYm91bmQiOwoKICAgICAgICB2YXIgaW5pdFJlc3VsdDsKICAgICAgICBpZiAoYmluZGluZy5pbml0aWFsaXplKSB7CiAgICAgICAgICBpbml0UmVzdWx0ID0gYmluZGluZy5pbml0aWFsaXplKGVsLAogICAgICAgICAgICBzaXplT2JqID8gc2l6ZU9iai5nZXRXaWR0aCgpIDogZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgIHNpemVPYmogPyBzaXplT2JqLmdldEhlaWdodCgpIDogZWwub2Zmc2V0SGVpZ2h0CiAgICAgICAgICApOwogICAgICAgICAgZWxlbWVudERhdGEoZWwsICJpbml0X3Jlc3VsdCIsIGluaXRSZXN1bHQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGJpbmRpbmcucmVzaXplKSB7CiAgICAgICAgICB2YXIgbGFzdFNpemUgPSB7fTsKICAgICAgICAgIHZhciByZXNpemVIYW5kbGVyID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgc2l6ZSA9IHsKICAgICAgICAgICAgICB3OiBzaXplT2JqID8gc2l6ZU9iai5nZXRXaWR0aCgpIDogZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgaDogc2l6ZU9iaiA/IHNpemVPYmouZ2V0SGVpZ2h0KCkgOiBlbC5vZmZzZXRIZWlnaHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHNpemUudyA9PT0gMCAmJiBzaXplLmggPT09IDApCiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBpZiAoc2l6ZS53ID09PSBsYXN0U2l6ZS53ICYmIHNpemUuaCA9PT0gbGFzdFNpemUuaCkKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGxhc3RTaXplID0gc2l6ZTsKICAgICAgICAgICAgYmluZGluZy5yZXNpemUoZWwsIHNpemUudywgc2l6ZS5oLCBpbml0UmVzdWx0KTsKICAgICAgICAgIH07CgogICAgICAgICAgb24od2luZG93LCAicmVzaXplIiwgcmVzaXplSGFuZGxlcik7CgogICAgICAgICAgLy8gVGhpcyBpcyBuZWVkZWQgZm9yIGNhc2VzIHdoZXJlIHdlJ3JlIHJ1bm5pbmcgaW4gYSBTaGlueQogICAgICAgICAgLy8gYXBwLCBidXQgdGhlIHdpZGdldCBpdHNlbGYgaXMgbm90IGEgU2hpbnkgb3V0cHV0LCBidXQKICAgICAgICAgIC8vIHJhdGhlciBhIHNpbXBsZSBzdGF0aWMgd2lkZ2V0LiBPbmUgZXhhbXBsZSBvZiB0aGlzIGlzCiAgICAgICAgICAvLyBhbiBybWFya2Rvd24gZG9jdW1lbnQgdGhhdCBoYXMgcnVudGltZTpzaGlueSBhbmQgd2lkZ2V0CiAgICAgICAgICAvLyB0aGF0IGlzbid0IGluIGEgcmVuZGVyIGZ1bmN0aW9uLiBTaGlueSBvbmx5IGtub3dzIHRvCiAgICAgICAgICAvLyBjYWxsIHJlc2l6ZSBoYW5kbGVycyBmb3IgU2hpbnkgb3V0cHV0cywgbm90IGZvciBzdGF0aWMKICAgICAgICAgIC8vIHdpZGdldHMsIHNvIHdlIGRvIGl0IG91cnNlbHZlcy4KICAgICAgICAgIGlmICh3aW5kb3cualF1ZXJ5KSB7CiAgICAgICAgICAgIHdpbmRvdy5qUXVlcnkoZG9jdW1lbnQpLm9uKAogICAgICAgICAgICAgICJzaG93bi5odG1sd2lkZ2V0cyBzaG93bi5icy50YWIuaHRtbHdpZGdldHMgc2hvd24uYnMuY29sbGFwc2UuaHRtbHdpZGdldHMiLAogICAgICAgICAgICAgIHJlc2l6ZUhhbmRsZXIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgd2luZG93LmpRdWVyeShkb2N1bWVudCkub24oCiAgICAgICAgICAgICAgImhpZGRlbi5odG1sd2lkZ2V0cyBoaWRkZW4uYnMudGFiLmh0bWx3aWRnZXRzIGhpZGRlbi5icy5jb2xsYXBzZS5odG1sd2lkZ2V0cyIsCiAgICAgICAgICAgICAgcmVzaXplSGFuZGxlcgogICAgICAgICAgICApOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFRoaXMgaXMgbmVlZGVkIGZvciB0aGUgc3BlY2lmaWMgY2FzZSBvZiBpb3NsaWRlcywgd2hpY2gKICAgICAgICAgIC8vIGZsaXBzIHNsaWRlcyBiZXR3ZWVuIGRpc3BsYXk6bm9uZSBhbmQgZGlzcGxheTpibG9jay4KICAgICAgICAgIC8vIElkZWFsbHkgd2Ugd291bGQgbm90IGhhdmUgdG8gaGF2ZSBpb3NsaWRlLXNwZWNpZmljIGNvZGUKICAgICAgICAgIC8vIGhlcmUsIGJ1dCByYXRoZXIgaGF2ZSBpb3NsaWRlcyByYWlzZSBhIGdlbmVyaWMgZXZlbnQsCiAgICAgICAgICAvLyBidXQgdGhlIHJtYXJrZG93biBwYWNrYWdlIGp1c3Qgd2VudCB0byBDUkFOIHNvIHRoZQogICAgICAgICAgLy8gd2luZG93IHRvIGdldHRpbmcgdGhhdCBmaXhlZCBtYXkgYmUgbG9uZy4KICAgICAgICAgIGlmICh3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAvLyBJdCdzIE9LIHRvIGxpbWl0IHRoaXMgdG8gd2luZG93LmFkZEV2ZW50TGlzdGVuZXIKICAgICAgICAgICAgLy8gYnJvd3NlcnMgYmVjYXVzZSBpb3NsaWRlcyBpdHNlbGYgb25seSBzdXBwb3J0cwogICAgICAgICAgICAvLyBzdWNoIGJyb3dzZXJzLgogICAgICAgICAgICBvbihkb2N1bWVudCwgInNsaWRlZW50ZXIiLCByZXNpemVIYW5kbGVyKTsKICAgICAgICAgICAgb24oZG9jdW1lbnQsICJzbGlkZWxlYXZlIiwgcmVzaXplSGFuZGxlcik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgc2NyaXB0RGF0YSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoInNjcmlwdFtkYXRhLWZvcj0nIiArIGVsLmlkICsgIiddW3R5cGU9J2FwcGxpY2F0aW9uL2pzb24nXSIpOwogICAgICAgIGlmIChzY3JpcHREYXRhKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IEpTT04ucGFyc2Uoc2NyaXB0RGF0YS50ZXh0Q29udGVudCB8fCBzY3JpcHREYXRhLnRleHQpOwogICAgICAgICAgLy8gUmVzb2x2ZSBzdHJpbmdzIG1hcmtlZCBhcyBqYXZhc2NyaXB0IGxpdGVyYWxzIHRvIG9iamVjdHMKICAgICAgICAgIGlmICghKGRhdGEuZXZhbHMgaW5zdGFuY2VvZiBBcnJheSkpIGRhdGEuZXZhbHMgPSBbZGF0YS5ldmFsc107CiAgICAgICAgICBmb3IgKHZhciBrID0gMDsgZGF0YS5ldmFscyAmJiBrIDwgZGF0YS5ldmFscy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICB3aW5kb3cuSFRNTFdpZGdldHMuZXZhbHVhdGVTdHJpbmdNZW1iZXIoZGF0YS54LCBkYXRhLmV2YWxzW2tdKTsKICAgICAgICAgIH0KICAgICAgICAgIGJpbmRpbmcucmVuZGVyVmFsdWUoZWwsIGRhdGEueCwgaW5pdFJlc3VsdCk7CiAgICAgICAgICBldmFsQW5kUnVuKGRhdGEuanNIb29rcy5yZW5kZXIsIGluaXRSZXN1bHQsIFtlbCwgZGF0YS54XSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwoKICAgIGludm9rZVBvc3RSZW5kZXJIYW5kbGVycygpOwogIH0KCiAgLy8gV2FpdCB1bnRpbCBhZnRlciB0aGUgZG9jdW1lbnQgaGFzIGxvYWRlZCB0byByZW5kZXIgdGhlIHdpZGdldHMuCiAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBmdW5jdGlvbigpIHsKICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGFyZ3VtZW50cy5jYWxsZWUsIGZhbHNlKTsKICAgICAgd2luZG93LkhUTUxXaWRnZXRzLnN0YXRpY1JlbmRlcigpOwogICAgfSwgZmFsc2UpOwogIH0gZWxzZSBpZiAoZG9jdW1lbnQuYXR0YWNoRXZlbnQpIHsKICAgIGRvY3VtZW50LmF0dGFjaEV2ZW50KCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgICBkb2N1bWVudC5kZXRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgYXJndW1lbnRzLmNhbGxlZSk7CiAgICAgICAgd2luZG93LkhUTUxXaWRnZXRzLnN0YXRpY1JlbmRlcigpOwogICAgICB9CiAgICB9KTsKICB9CgoKICB3aW5kb3cuSFRNTFdpZGdldHMuZ2V0QXR0YWNobWVudFVybCA9IGZ1bmN0aW9uKGRlcG5hbWUsIGtleSkgewogICAgLy8gSWYgbm8ga2V5LCBkZWZhdWx0IHRvIHRoZSBmaXJzdCBpdGVtCiAgICBpZiAodHlwZW9mKGtleSkgPT09ICJ1bmRlZmluZWQiKQogICAgICBrZXkgPSAxOwoKICAgIHZhciBsaW5rID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZGVwbmFtZSArICItIiArIGtleSArICItYXR0YWNobWVudCIpOwogICAgaWYgKCFsaW5rKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQXR0YWNobWVudCAiICsgZGVwbmFtZSArICIvIiArIGtleSArICIgbm90IGZvdW5kIGluIGRvY3VtZW50Iik7CiAgICB9CiAgICByZXR1cm4gbGluay5nZXRBdHRyaWJ1dGUoImhyZWYiKTsKICB9OwoKICB3aW5kb3cuSFRNTFdpZGdldHMuZGF0YWZyYW1lVG9EMyA9IGZ1bmN0aW9uKGRmKSB7CiAgICB2YXIgbmFtZXMgPSBbXTsKICAgIHZhciBsZW5ndGg7CiAgICBmb3IgKHZhciBuYW1lIGluIGRmKSB7CiAgICAgICAgaWYgKGRmLmhhc093blByb3BlcnR5KG5hbWUpKQogICAgICAgICAgICBuYW1lcy5wdXNoKG5hbWUpOwogICAgICAgIGlmICh0eXBlb2YoZGZbbmFtZV0pICE9PSAib2JqZWN0IiB8fCB0eXBlb2YoZGZbbmFtZV0ubGVuZ3RoKSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbGwgZmllbGRzIG11c3QgYmUgYXJyYXlzIik7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YobGVuZ3RoKSAhPT0gInVuZGVmaW5lZCIgJiYgbGVuZ3RoICE9PSBkZltuYW1lXS5sZW5ndGgpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbGwgZmllbGRzIG11c3QgYmUgYXJyYXlzIG9mIHRoZSBzYW1lIGxlbmd0aCIpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBkZltuYW1lXS5sZW5ndGg7CiAgICB9CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIGl0ZW07CiAgICBmb3IgKHZhciByb3cgPSAwOyByb3cgPCBsZW5ndGg7IHJvdysrKSB7CiAgICAgICAgaXRlbSA9IHt9OwogICAgICAgIGZvciAodmFyIGNvbCA9IDA7IGNvbCA8IG5hbWVzLmxlbmd0aDsgY29sKyspIHsKICAgICAgICAgICAgaXRlbVtuYW1lc1tjb2xdXSA9IGRmW25hbWVzW2NvbF1dW3Jvd107CiAgICAgICAgfQogICAgICAgIHJlc3VsdHMucHVzaChpdGVtKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIHdpbmRvdy5IVE1MV2lkZ2V0cy50cmFuc3Bvc2VBcnJheTJEID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgICAgaWYgKGFycmF5Lmxlbmd0aCA9PT0gMCkgcmV0dXJuIGFycmF5OwogICAgICB2YXIgbmV3QXJyYXkgPSBhcnJheVswXS5tYXAoZnVuY3Rpb24oY29sLCBpKSB7CiAgICAgICAgICByZXR1cm4gYXJyYXkubWFwKGZ1bmN0aW9uKHJvdykgewogICAgICAgICAgICAgIHJldHVybiByb3dbaV0KICAgICAgICAgIH0pCiAgICAgIH0pOwogICAgICByZXR1cm4gbmV3QXJyYXk7CiAgfTsKICAvLyBTcGxpdCB2YWx1ZSBhdCBzcGxpdENoYXIsIGJ1dCBhbGxvdyBzcGxpdENoYXIgdG8gYmUgZXNjYXBlZAogIC8vIHVzaW5nIGVzY2FwZUNoYXIuIEFueSBvdGhlciBjaGFyYWN0ZXJzIGVzY2FwZWQgYnkgZXNjYXBlQ2hhcgogIC8vIHdpbGwgYmUgaW5jbHVkZWQgYXMgdXN1YWwgKGluY2x1ZGluZyBlc2NhcGVDaGFyIGl0c2VsZikuCiAgZnVuY3Rpb24gc3BsaXRXaXRoRXNjYXBlKHZhbHVlLCBzcGxpdENoYXIsIGVzY2FwZUNoYXIpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICB2YXIgZXNjYXBlTW9kZSA9IGZhbHNlOwogICAgdmFyIGN1cnJlbnRSZXN1bHQgPSAiIjsKICAgIGZvciAodmFyIHBvcyA9IDA7IHBvcyA8IHZhbHVlLmxlbmd0aDsgcG9zKyspIHsKICAgICAgaWYgKCFlc2NhcGVNb2RlKSB7CiAgICAgICAgaWYgKHZhbHVlW3Bvc10gPT09IHNwbGl0Q2hhcikgewogICAgICAgICAgcmVzdWx0cy5wdXNoKGN1cnJlbnRSZXN1bHQpOwogICAgICAgICAgY3VycmVudFJlc3VsdCA9ICIiOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWVbcG9zXSA9PT0gZXNjYXBlQ2hhcikgewogICAgICAgICAgZXNjYXBlTW9kZSA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRSZXN1bHQgKz0gdmFsdWVbcG9zXTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3VycmVudFJlc3VsdCArPSB2YWx1ZVtwb3NdOwogICAgICAgIGVzY2FwZU1vZGUgPSBmYWxzZTsKICAgICAgfQogICAgfQogICAgaWYgKGN1cnJlbnRSZXN1bHQgIT09ICIiKSB7CiAgICAgIHJlc3VsdHMucHVzaChjdXJyZW50UmVzdWx0KTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvLyBGdW5jdGlvbiBhdXRob3JlZCBieSBZaWh1aS9KSiBBbGxhaXJlCiAgd2luZG93LkhUTUxXaWRnZXRzLmV2YWx1YXRlU3RyaW5nTWVtYmVyID0gZnVuY3Rpb24obywgbWVtYmVyKSB7CiAgICB2YXIgcGFydHMgPSBzcGxpdFdpdGhFc2NhcGUobWVtYmVyLCAnLicsICdcXCcpOwogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBwYXJ0cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTsKICAgICAgLy8gcGFydCBtYXkgYmUgYSBjaGFyYWN0ZXIgb3IgJ251bWVyaWMnIG1lbWJlciBuYW1lCiAgICAgIGlmIChvICE9PSBudWxsICYmIHR5cGVvZiBvID09PSAib2JqZWN0IiAmJiBwYXJ0IGluIG8pIHsKICAgICAgICBpZiAoaSA9PSAobCAtIDEpKSB7IC8vIGlmIHdlIGFyZSBhdCB0aGUgZW5kIG9mIHRoZSBsaW5lIHRoZW4gZXZhbHVsYXRlCiAgICAgICAgICBpZiAodHlwZW9mIG9bcGFydF0gPT09ICJzdHJpbmciKQogICAgICAgICAgICBvW3BhcnRdID0gZXZhbCgiKCIgKyBvW3BhcnRdICsgIikiKTsKICAgICAgICB9IGVsc2UgeyAvLyBvdGhlcndpc2UgY29udGludWUgdG8gbmV4dCBlbWJlZGRlZCBvYmplY3QKICAgICAgICAgIG8gPSBvW3BhcnRdOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CgogIC8vIFJldHJpZXZlIHRoZSBIVE1MV2lkZ2V0IGluc3RhbmNlIChpLmUuIHRoZSByZXR1cm4gdmFsdWUgb2YgYW4KICAvLyBIVE1MV2lkZ2V0IGJpbmRpbmcncyBpbml0aWFsaXplKCkgb3IgZmFjdG9yeSgpIGZ1bmN0aW9uKQogIC8vIGFzc29jaWF0ZWQgd2l0aCBhbiBlbGVtZW50LCBvciBudWxsIGlmIG5vbmUuCiAgd2luZG93LkhUTUxXaWRnZXRzLmdldEluc3RhbmNlID0gZnVuY3Rpb24oZWwpIHsKICAgIHJldHVybiBlbGVtZW50RGF0YShlbCwgImluaXRfcmVzdWx0Iik7CiAgfTsKCiAgLy8gRmluZHMgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIHNjb3BlIHRoYXQgbWF0Y2hlcyB0aGUgc2VsZWN0b3IsCiAgLy8gYW5kIHJldHVybnMgdGhlIEhUTUxXaWRnZXQgaW5zdGFuY2UgKGkuZS4gdGhlIHJldHVybiB2YWx1ZSBvZgogIC8vIGFuIEhUTUxXaWRnZXQgYmluZGluZydzIGluaXRpYWxpemUoKSBvciBmYWN0b3J5KCkgZnVuY3Rpb24pCiAgLy8gYXNzb2NpYXRlZCB3aXRoIHRoYXQgZWxlbWVudCwgaWYgYW55LiBJZiBubyBlbGVtZW50IG1hdGNoZXMgdGhlCiAgLy8gc2VsZWN0b3IsIG9yIHRoZSBmaXJzdCBtYXRjaGluZyBlbGVtZW50IGhhcyBubyBIVE1MV2lkZ2V0CiAgLy8gaW5zdGFuY2UgYXNzb2NpYXRlZCB3aXRoIGl0LCB0aGVuIG51bGwgaXMgcmV0dXJuZWQuCiAgLy8KICAvLyBUaGUgc2NvcGUgYXJndW1lbnQgaXMgb3B0aW9uYWwsIGFuZCBkZWZhdWx0cyB0byB3aW5kb3cuZG9jdW1lbnQuCiAgd2luZG93LkhUTUxXaWRnZXRzLmZpbmQgPSBmdW5jdGlvbihzY29wZSwgc2VsZWN0b3IpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgc2VsZWN0b3IgPSBzY29wZTsKICAgICAgc2NvcGUgPSBkb2N1bWVudDsKICAgIH0KCiAgICB2YXIgZWwgPSBzY29wZS5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTsKICAgIGlmIChlbCA9PT0gbnVsbCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB3aW5kb3cuSFRNTFdpZGdldHMuZ2V0SW5zdGFuY2UoZWwpOwogICAgfQogIH07CgogIC8vIEZpbmRzIGFsbCBlbGVtZW50cyBpbiB0aGUgc2NvcGUgdGhhdCBtYXRjaCB0aGUgc2VsZWN0b3IsIGFuZAogIC8vIHJldHVybnMgdGhlIEhUTUxXaWRnZXQgaW5zdGFuY2VzIChpLmUuIHRoZSByZXR1cm4gdmFsdWVzIG9mCiAgLy8gYW4gSFRNTFdpZGdldCBiaW5kaW5nJ3MgaW5pdGlhbGl6ZSgpIG9yIGZhY3RvcnkoKSBmdW5jdGlvbikKICAvLyBhc3NvY2lhdGVkIHdpdGggdGhlIGVsZW1lbnRzLCBpbiBhbiBhcnJheS4gSWYgZWxlbWVudHMgdGhhdAogIC8vIG1hdGNoIHRoZSBzZWxlY3RvciBkb24ndCBoYXZlIGFuIGFzc29jaWF0ZWQgSFRNTFdpZGdldAogIC8vIGluc3RhbmNlLCB0aGUgcmV0dXJuZWQgYXJyYXkgd2lsbCBjb250YWluIG51bGxzLgogIC8vCiAgLy8gVGhlIHNjb3BlIGFyZ3VtZW50IGlzIG9wdGlvbmFsLCBhbmQgZGVmYXVsdHMgdG8gd2luZG93LmRvY3VtZW50LgogIHdpbmRvdy5IVE1MV2lkZ2V0cy5maW5kQWxsID0gZnVuY3Rpb24oc2NvcGUsIHNlbGVjdG9yKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgIHNlbGVjdG9yID0gc2NvcGU7CiAgICAgIHNjb3BlID0gZG9jdW1lbnQ7CiAgICB9CgogICAgdmFyIG5vZGVzID0gc2NvcGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICByZXN1bHRzLnB1c2god2luZG93LkhUTUxXaWRnZXRzLmdldEluc3RhbmNlKG5vZGVzW2ldKSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICB2YXIgcG9zdFJlbmRlckhhbmRsZXJzID0gW107CiAgZnVuY3Rpb24gaW52b2tlUG9zdFJlbmRlckhhbmRsZXJzKCkgewogICAgd2hpbGUgKHBvc3RSZW5kZXJIYW5kbGVycy5sZW5ndGgpIHsKICAgICAgdmFyIGhhbmRsZXIgPSBwb3N0UmVuZGVySGFuZGxlcnMuc2hpZnQoKTsKICAgICAgaWYgKGhhbmRsZXIpIHsKICAgICAgICBoYW5kbGVyKCk7CiAgICAgIH0KICAgIH0KICB9CgogIC8vIFJlZ2lzdGVyIHRoZSBnaXZlbiBjYWxsYmFjayBmdW5jdGlvbiB0byBiZSBpbnZva2VkIGFmdGVyIHRoZQogIC8vIG5leHQgdGltZSBzdGF0aWMgd2lkZ2V0cyBhcmUgcmVuZGVyZWQuCiAgd2luZG93LkhUTUxXaWRnZXRzLmFkZFBvc3RSZW5kZXJIYW5kbGVyID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgIHBvc3RSZW5kZXJIYW5kbGVycy5wdXNoKGNhbGxiYWNrKTsKICB9OwoKICAvLyBUYWtlcyBhIG5ldy1zdHlsZSBpbnN0YW5jZS1ib3VuZCBkZWZpbml0aW9uLCBhbmQgcmV0dXJucyBhbgogIC8vIG9sZC1zdHlsZSBjbGFzcy1ib3VuZCBkZWZpbml0aW9uLiBUaGlzIHNhdmVzIHVzIGZyb20gaGF2aW5nCiAgLy8gdG8gcmV3cml0ZSBhbGwgdGhlIGxvZ2ljIGluIHRoaXMgZmlsZSB0byBhY2NvbW9kYXRlIGJvdGgKICAvLyB0eXBlcyBvZiBkZWZpbml0aW9ucy4KICBmdW5jdGlvbiBjcmVhdGVMZWdhY3lEZWZpbml0aW9uQWRhcHRlcihkZWZuKSB7CiAgICB2YXIgcmVzdWx0ID0gewogICAgICBuYW1lOiBkZWZuLm5hbWUsCiAgICAgIHR5cGU6IGRlZm4udHlwZSwKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICByZXR1cm4gZGVmbi5mYWN0b3J5KGVsLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgfSwKICAgICAgcmVuZGVyVmFsdWU6IGZ1bmN0aW9uKGVsLCB4LCBpbnN0YW5jZSkgewogICAgICAgIHJldHVybiBpbnN0YW5jZS5yZW5kZXJWYWx1ZSh4KTsKICAgICAgfSwKICAgICAgcmVzaXplOiBmdW5jdGlvbihlbCwgd2lkdGgsIGhlaWdodCwgaW5zdGFuY2UpIHsKICAgICAgICByZXR1cm4gaW5zdGFuY2UucmVzaXplKHdpZHRoLCBoZWlnaHQpOwogICAgICB9CiAgICB9OwoKICAgIGlmIChkZWZuLmZpbmQpCiAgICAgIHJlc3VsdC5maW5kID0gZGVmbi5maW5kOwogICAgaWYgKGRlZm4ucmVuZGVyRXJyb3IpCiAgICAgIHJlc3VsdC5yZW5kZXJFcnJvciA9IGRlZm4ucmVuZGVyRXJyb3I7CiAgICBpZiAoZGVmbi5jbGVhckVycm9yKQogICAgICByZXN1bHQuY2xlYXJFcnJvciA9IGRlZm4uY2xlYXJFcnJvcjsKCiAgICByZXR1cm4gcmVzdWx0OwogIH0KfSkoKTsKCg=="></script>
<script src="data:application/x-javascript;base64,LyohIHB5bS5qcyAtIHYxLjMuMSAtIDIwMTctMDgtMDYgKi8KLyoKKiBQeW0uanMgaXMgbGlicmFyeSB0aGF0IHJlc2l6ZXMgYW4gaWZyYW1lIGJhc2VkIG9uIHRoZSB3aWR0aCBvZiB0aGUgcGFyZW50IGFuZCB0aGUgcmVzdWx0aW5nIGhlaWdodCBvZiB0aGUgY2hpbGQuCiogQ2hlY2sgb3V0IHRoZSBkb2NzIGF0IGh0dHA6Ly9ibG9nLmFwcHMubnByLm9yZy9weW0uanMvIG9yIHRoZSByZWFkbWUgYXQgUkVBRE1FLm1kIGZvciB1c2FnZS4KKi8KCi8qKiBAbW9kdWxlIHB5bSAqLwooZnVuY3Rpb24oZmFjdG9yeSkgewogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIGRlZmluZShmYWN0b3J5KTsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7CiAgICB9IGVsc2UgewogICAgICAgIHdpbmRvdy5weW0gPSBmYWN0b3J5LmNhbGwodGhpcyk7CiAgICB9Cn0pKGZ1bmN0aW9uKCkgewogICAgdmFyIE1FU1NBR0VfREVMSU1JVEVSID0gJ3hQWU14JzsKCiAgICB2YXIgbGliID0ge307CgogICAgLyoqCiAgICAqIENyZWF0ZSBhbmQgZGlzcGF0Y2ggYSBjdXN0b20gcHltIGV2ZW50CiAgICAqCiAgICAqIEBtZXRob2QgX3JhaXNlQ3VzdG9tRXZlbnQKICAgICogQGlubmVyCiAgICAqCiAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudE5hbWUKICAgICovCiAgIHZhciBfcmFpc2VDdXN0b21FdmVudCA9IGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogICAgIHZhciBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdFdmVudCcpOwogICAgIGV2ZW50LmluaXRFdmVudCgncHltOicgKyBldmVudE5hbWUsIHRydWUsIHRydWUpOwogICAgIGRvY3VtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICB9OwoKICAgIC8qKgogICAgKiBHZW5lcmljIGZ1bmN0aW9uIGZvciBwYXJzaW5nIFVSTCBwYXJhbXMuCiAgICAqIFZpYSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzkwMTExNS9ob3ctY2FuLWktZ2V0LXF1ZXJ5LXN0cmluZy12YWx1ZXMtaW4tamF2YXNjcmlwdAogICAgKgogICAgKiBAbWV0aG9kIF9nZXRQYXJhbWV0ZXJCeU5hbWUKICAgICogQGlubmVyCiAgICAqCiAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBwYXJhbXRlciB0byBnZXQgZnJvbSB0aGUgVVJMLgogICAgKi8KICAgIHZhciBfZ2V0UGFyYW1ldGVyQnlOYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciByZWdleCA9IG5ldyBSZWdFeHAoIltcXD8mXSIgKyBuYW1lLnJlcGxhY2UoL1tcW10vLCAnXFxbJykucmVwbGFjZSgvW1xdXS8sICdcXF0nKSArICc9KFteJiNdKiknKTsKICAgICAgICB2YXIgcmVzdWx0cyA9IHJlZ2V4LmV4ZWMobG9jYXRpb24uc2VhcmNoKTsKCiAgICAgICAgaWYgKHJlc3VsdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChyZXN1bHRzWzFdLnJlcGxhY2UoL1wrL2csICIgIikpOwogICAgfTsKCiAgICAvKioKICAgICAqIENoZWNrIHRoZSBtZXNzYWdlIHRvIG1ha2Ugc3VyZSBpdCBjb21lcyBmcm9tIGFuIGFjY2VwdGFibGUgeGRvbWFpbi4KICAgICAqIERlZmF1bHRzIHRvICcqJyBidXQgY2FuIGJlIG92ZXJyaWRlbiBpbiBjb25maWcuCiAgICAgKgogICAgICogQG1ldGhvZCBfaXNTYWZlTWVzc2FnZQogICAgICogQGlubmVyCiAgICAgKgogICAgICogQHBhcmFtIHtFdmVudH0gZSBUaGUgbWVzc2FnZSBldmVudC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBDb25maWd1cmF0aW9uLgogICAgICovCiAgICB2YXIgX2lzU2FmZU1lc3NhZ2UgPSBmdW5jdGlvbihlLCBzZXR0aW5ncykgewogICAgICAgIGlmIChzZXR0aW5ncy54ZG9tYWluICE9PSAnKicpIHsKICAgICAgICAgICAgLy8gSWYgb3JpZ2luIGRvZXNuJ3QgbWF0Y2ggb3VyIHhkb21haW4sIHJldHVybi4KICAgICAgICAgICAgaWYgKCFlLm9yaWdpbi5tYXRjaChuZXcgUmVnRXhwKHNldHRpbmdzLnhkb21haW4gKyAnJCcpKSkgeyByZXR1cm47IH0KICAgICAgICB9CgogICAgICAgIC8vIElnbm9yZSBldmVudHMgdGhhdCBkbyBub3QgY2Fycnkgc3RyaW5nIGRhdGEgIzE1MQogICAgICAgIGlmICh0eXBlb2YgZS5kYXRhICE9PSAnc3RyaW5nJykgeyByZXR1cm47IH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwoKICAgIC8qKgogICAgICogQ29uc3RydWN0IGEgbWVzc2FnZSB0byBzZW5kIGJldHdlZW4gZnJhbWVzLgogICAgICoKICAgICAqIE5COiBXZSB1c2Ugc3RyaW5nLWJ1aWxkaW5nIGhlcmUgYmVjYXVzZSBKU09OIG1lc3NhZ2UgcGFzc2luZyBpcwogICAgICogbm90IHN1cHBvcnRlZCBpbiBhbGwgYnJvd3NlcnMuCiAgICAgKgogICAgICogQG1ldGhvZCBfbWFrZU1lc3NhZ2UKICAgICAqIEBpbm5lcgogICAgICoKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgdW5pcXVlIGlkIG9mIHRoZSBtZXNzYWdlIHJlY2lwaWVudC4KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlVHlwZSBUaGUgdHlwZSBvZiBtZXNzYWdlIHRvIHNlbmQuCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzZW5kLgogICAgICovCiAgICB2YXIgX21ha2VNZXNzYWdlID0gZnVuY3Rpb24oaWQsIG1lc3NhZ2VUeXBlLCBtZXNzYWdlKSB7CiAgICAgICAgdmFyIGJpdHMgPSBbJ3B5bScsIGlkLCBtZXNzYWdlVHlwZSwgbWVzc2FnZV07CgogICAgICAgIHJldHVybiBiaXRzLmpvaW4oTUVTU0FHRV9ERUxJTUlURVIpOwogICAgfTsKCiAgICAvKioKICAgICAqIENvbnN0cnVjdCBhIHJlZ2V4IHRvIHZhbGlkYXRlIGFuZCBwYXJzZSBtZXNzYWdlcy4KICAgICAqCiAgICAgKiBAbWV0aG9kIF9tYWtlTWVzc2FnZVJlZ2V4CiAgICAgKiBAaW5uZXIKICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIHVuaXF1ZSBpZCBvZiB0aGUgbWVzc2FnZSByZWNpcGllbnQuCiAgICAgKi8KICAgIHZhciBfbWFrZU1lc3NhZ2VSZWdleCA9IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgdmFyIGJpdHMgPSBbJ3B5bScsIGlkLCAnKFxcUyspJywgJyguKiknXTsKCiAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgYml0cy5qb2luKE1FU1NBR0VfREVMSU1JVEVSKSArICckJyk7CiAgICB9OwoKICAgIC8qKgogICAgKiBVbmRlcnNjb3JlIGltcGxlbWVudGF0aW9uIG9mIGdldE5vdwogICAgKgogICAgKiBAbWV0aG9kIF9nZXROb3cKICAgICogQGlubmVyCiAgICAqCiAgICAqLwogICAgdmFyIF9nZXROb3cgPSBEYXRlLm5vdyB8fCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB9OwoKICAgIC8qKgogICAgKiBVbmRlcnNjb3JlIGltcGxlbWVudGF0aW9uIG9mIHRocm90dGxlCiAgICAqCiAgICAqIEBtZXRob2QgX3Rocm90dGxlCiAgICAqIEBpbm5lcgogICAgKgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmdW5jIFRocm90dGxlZCBmdW5jdGlvbgogICAgKiBAcGFyYW0ge251bWJlcn0gd2FpdCBUaHJvdHRsZSB3YWl0IHRpbWUKICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgVGhyb3R0bGUgc2V0dGluZ3MKICAgICovCgogICAgdmFyIF90aHJvdHRsZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgY29udGV4dCwgYXJncywgcmVzdWx0OwogICAgICAgIHZhciB0aW1lb3V0ID0gbnVsbDsKICAgICAgICB2YXIgcHJldmlvdXMgPSAwOwogICAgICAgIGlmICghb3B0aW9ucykge29wdGlvbnMgPSB7fTt9CiAgICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHByZXZpb3VzID0gb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSA/IDAgOiBfZ2V0Tm93KCk7CiAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICBpZiAoIXRpbWVvdXQpIHtjb250ZXh0ID0gYXJncyA9IG51bGw7fQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbm93ID0gX2dldE5vdygpOwogICAgICAgICAgICBpZiAoIXByZXZpb3VzICYmIG9wdGlvbnMubGVhZGluZyA9PT0gZmFsc2UpIHtwcmV2aW91cyA9IG5vdzt9CiAgICAgICAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKICAgICAgICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgICAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIGlmIChyZW1haW5pbmcgPD0gMCB8fCByZW1haW5pbmcgPiB3YWl0KSB7CiAgICAgICAgICAgICAgICBpZiAodGltZW91dCkgewogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgICAgIGlmICghdGltZW91dCkge2NvbnRleHQgPSBhcmdzID0gbnVsbDt9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRpbWVvdXQgJiYgb3B0aW9ucy50cmFpbGluZyAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDbGVhbiBhdXRvSW5pdCBJbnN0YW5jZXM6IHRob3NlIHRoYXQgcG9pbnQgdG8gY29udGVudGxlc3MgaWZyYW1lcwogICAgICogQG1ldGhvZCBfY2xlYW5BdXRvSW5pdEluc3RhbmNlcwogICAgICogQGlubmVyCiAgICAgKi8KICAgIHZhciBfY2xlYW5BdXRvSW5pdEluc3RhbmNlcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBsZW5ndGggPSBsaWIuYXV0b0luaXRJbnN0YW5jZXMubGVuZ3RoOwoKICAgICAgICAvLyBMb29wIGJhY2t3YXJkcyB0byBhdm9pZCBpbmRleCBpc3N1ZXMKICAgICAgICBmb3IgKHZhciBpZHggPSBsZW5ndGggLSAxOyBpZHggPj0gMDsgaWR4LS0pIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbGliLmF1dG9Jbml0SW5zdGFuY2VzW2lkeF07CiAgICAgICAgICAgIC8vIElmIGluc3RhbmNlIGhhcyBiZWVuIHJlbW92ZWQgb3IgaXMgY29udGVudGxlc3MgdGhlbiByZW1vdmUgaXQKICAgICAgICAgICAgaWYgKGluc3RhbmNlLmVsLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKS5sZW5ndGggJiYKICAgICAgICAgICAgICAgIGluc3RhbmNlLmVsLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKVswXS5jb250ZW50V2luZG93KSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgcmVmZXJlbmNlIHRvIHRoZSByZW1vdmVkIG9yIG9ycGhhbiBpbnN0YW5jZQogICAgICAgICAgICAgICAgbGliLmF1dG9Jbml0SW5zdGFuY2VzLnNwbGljZShpZHgsMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogU3RvcmUgYXV0byBpbml0aWFsaXplZCBQeW0gaW5zdGFuY2VzIGZvciBmdXJ0aGVyIHJlZmVyZW5jZQogICAgICogQG5hbWUgbW9kdWxlOnB5bSNhdXRvSW5pdEluc3RhbmNlcwogICAgICogQHR5cGUgQXJyYXkKICAgICAqIEBkZWZhdWx0IFtdCiAgICAgKi8KICAgIGxpYi5hdXRvSW5pdEluc3RhbmNlcyA9IFtdOwoKICAgIC8qKgogICAgICogSW5pdGlhbGl6ZSBQeW0gZm9yIGVsZW1lbnRzIG9uIHBhZ2UgdGhhdCBoYXZlIGRhdGEtcHltIGF0dHJpYnV0ZXMuCiAgICAgKiBFeHBvc2UgYXV0b2luaXQgaW4gY2FzZSB3ZSBuZWVkIHRvIGNhbGwgaXQgZnJvbSB0aGUgb3V0c2lkZQogICAgICogQGluc3RhbmNlCiAgICAgKiBAbWV0aG9kIGF1dG9Jbml0CiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGRvTm90UmFpc2VFdmVudHMgZmxhZyB0byBhdm9pZCBzZW5kaW5nIGN1c3RvbSBldmVudHMKICAgICAqLwogICAgbGliLmF1dG9Jbml0ID0gZnVuY3Rpb24oZG9Ob3RSYWlzZUV2ZW50cykgewogICAgICAgIHZhciBlbGVtZW50cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLXB5bS1zcmNdOm5vdChbZGF0YS1weW0tYXV0by1pbml0aWFsaXplZF0pJyk7CiAgICAgICAgdmFyIGxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsKCiAgICAgICAgLy8gQ2xlYW4gc3RvcmVkIGluc3RhbmNlcyBpbiBjYXNlIG5lZWRlZAogICAgICAgIF9jbGVhbkF1dG9Jbml0SW5zdGFuY2VzKCk7CiAgICAgICAgZm9yICh2YXIgaWR4ID0gMDsgaWR4IDwgbGVuZ3RoOyArK2lkeCkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGVsZW1lbnRzW2lkeF07CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICogTWFyayBhdXRvbWF0aWNhbGx5LWluaXRpYWxpemVkIGVsZW1lbnRzIHNvIHRoZXkgYXJlIG5vdAogICAgICAgICAgICAqIHJlLWluaXRpYWxpemVkIGlmIHRoZSB1c2VyIGluY2x1ZGVzIHB5bS5qcyBtb3JlIHRoYW4gb25jZSBpbiB0aGUKICAgICAgICAgICAgKiBzYW1lIGRvY3VtZW50LgogICAgICAgICAgICAqLwogICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnZGF0YS1weW0tYXV0by1pbml0aWFsaXplZCcsICcnKTsKCiAgICAgICAgICAgIC8vIEVuc3VyZSBlbGVtZW50cyBoYXZlIGFuIGlkCiAgICAgICAgICAgIGlmIChlbGVtZW50LmlkID09PSAnJykgewogICAgICAgICAgICAgICAgZWxlbWVudC5pZCA9ICdweW0tJyArIGlkeCArICItIiArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLDUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgc3JjID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcHltLXNyYycpOwoKICAgICAgICAgICAgLy8gTGlzdCBvZiBkYXRhIGF0dHJpYnV0ZXMgdG8gY29uZmlndXJlIHRoZSBjb21wb25lbnQKICAgICAgICAgICAgLy8gc3RydWN0dXJlOiB7J2F0dHJpYnV0ZSBuYW1lJzogJ3R5cGUnfQogICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSB7J3hkb21haW4nOiAnc3RyaW5nJywgJ3RpdGxlJzogJ3N0cmluZycsICduYW1lJzogJ3N0cmluZycsICdpZCc6ICdzdHJpbmcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NhbmRib3gnOiAnc3RyaW5nJywgJ2FsbG93ZnVsbHNjcmVlbic6ICdib29sZWFuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwYXJlbnR1cmxwYXJhbSc6ICdzdHJpbmcnLCAncGFyZW50dXJsdmFsdWUnOiAnc3RyaW5nJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvcHRpb25hbHBhcmFtcyc6ICdib29sZWFuJywgJ3RyYWNrc2Nyb2xsJzogJ2Jvb2xlYW4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Njcm9sbHdhaXQnOiAnbnVtYmVyJywgJ2xhenlsb2FkJzogJ2Jvb2xlYW4nfTsKCiAgICAgICAgICAgIHZhciBjb25maWcgPSB7fTsKCiAgICAgICAgICAgIGZvciAodmFyIGF0dHJpYnV0ZSBpbiBzZXR0aW5ncykgewogICAgICAgICAgICAgICAgLy8gdmlhIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9FbGVtZW50L2dldEF0dHJpYnV0ZSNOb3RlcwogICAgICAgICAgICAgICBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcHltLScrYXR0cmlidXRlKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKHNldHRpbmdzW2F0dHJpYnV0ZV0pIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICAgICAgICAgICAgICAgICBjb25maWdbYXR0cmlidXRlXSA9ICEoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcHltLScrYXR0cmlidXRlKSA9PT0gJ2ZhbHNlJyk7IC8vIGpzaGludCBpZ25vcmU6bGluZQogICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnW2F0dHJpYnV0ZV0gPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS1weW0tJythdHRyaWJ1dGUpOwogICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuID0gTnVtYmVyKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXB5bS0nK2F0dHJpYnV0ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKG4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWdbYXR0cmlidXRlXSA9IG47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycigndW5yZWNvZ25pemVkIGF0dHJpYnV0ZSB0eXBlJyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2VzIHRvIGF1dG9pbml0aWFsaXplZCBweW0gaW5zdGFuY2VzCiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBuZXcgbGliLlBhcmVudChlbGVtZW50LmlkLCBzcmMsIGNvbmZpZyk7CiAgICAgICAgICAgIGxpYi5hdXRvSW5pdEluc3RhbmNlcy5wdXNoKHBhcmVudCk7CiAgICAgICAgfQoKICAgICAgICAvLyBGaXJlIGN1c3RvbUV2ZW50CiAgICAgICAgaWYgKCFkb05vdFJhaXNlRXZlbnRzKSB7CiAgICAgICAgICAgIF9yYWlzZUN1c3RvbUV2ZW50KCJweW0taW5pdGlhbGl6ZWQiKTsKICAgICAgICB9CiAgICAgICAgLy8gUmV0dXJuIHN0b3JlZCBhdXRvaW5pdGFsaXplZCBweW0gaW5zdGFuY2VzCiAgICAgICAgcmV0dXJuIGxpYi5hdXRvSW5pdEluc3RhbmNlczsKICAgIH07CgogICAgLyoqCiAgICAgKiBUaGUgUGFyZW50IGhhbGYgb2YgYSByZXNwb25zZSBpZnJhbWUuCiAgICAgKgogICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0KICAgICAqIEBjbGFzcyBQYXJlbnQKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIGRpdiBpbnRvIHdoaWNoIHRoZSBpZnJhbWUgd2lsbCBiZSByZW5kZXJlZC4gc2V0cyB7QGxpbmsgbW9kdWxlOnB5bS5QYXJlbnR+aWR9CiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgb2YgdGhlIGlmcmFtZSBzb3VyY2UuIHNldHMge0BsaW5rIG1vZHVsZTpweW0uUGFyZW50fnVybH0KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbY29uZmlnXSBDb25maWd1cmF0aW9uIGZvciB0aGUgcGFyZW50IGluc3RhbmNlLiBzZXRzIHtAbGluayBtb2R1bGU6cHltLlBhcmVudH5zZXR0aW5nc30KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29uZmlnLnhkb21haW49JyonXSAtIHhkb21haW4gdG8gdmFsaWRhdGUgbWVzc2FnZXMgcmVjZWl2ZWQKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29uZmlnLnRpdGxlXSAtIGlmIHBhc3NlZCBpdCB3aWxsIGJlIGFzc2lnbmVkIHRvIHRoZSBpZnJhbWUgdGl0bGUgYXR0cmlidXRlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbmZpZy5uYW1lXSAtIGlmIHBhc3NlZCBpdCB3aWxsIGJlIGFzc2lnbmVkIHRvIHRoZSBpZnJhbWUgbmFtZSBhdHRyaWJ1dGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29uZmlnLmlkXSAtIGlmIHBhc3NlZCBpdCB3aWxsIGJlIGFzc2lnbmVkIHRvIHRoZSBpZnJhbWUgaWQgYXR0cmlidXRlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjb25maWcuYWxsb3dmdWxsc2NyZWVuXSAtIGlmIHBhc3NlZCBhbmQgZGlmZmVyZW50IHRoYW4gZmFsc2UgaXQgd2lsbCBiZSBhc3NpZ25lZCB0byB0aGUgaWZyYW1lIGFsbG93ZnVsbHNjcmVlbiBhdHRyaWJ1dGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29uZmlnLnNhbmRib3hdIC0gaWYgcGFzc2VkIGl0IHdpbGwgYmUgYXNzaWduZWQgdG8gdGhlIGlmcmFtZSBzYW5kYm94IGF0dHJpYnV0ZSAod2UgZG8gbm90IHZhbGlkYXRlIHRoZSBzeW50YXggc28gYmUgY2FyZWZ1bCEhKQogICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb25maWcucGFyZW50dXJscGFyYW1dIC0gaWYgcGFzc2VkIGl0IHdpbGwgYmUgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgcGFyZW50VXJsIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXIgbmFtZSBwYXNzZWQgdG8gdGhlIGlmcmFtZSBzcmMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29uZmlnLnBhcmVudHVybHZhbHVlXSAtIGlmIHBhc3NlZCBpdCB3aWxsIGJlIG92ZXJyaWRlIHRoZSBkZWZhdWx0IHBhcmVudFVybCBxdWVyeSBzdHJpbmcgcGFyYW1ldGVyIHZhbHVlIHBhc3NlZCB0byB0aGUgaWZyYW1lIHNyYwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb25maWcub3B0aW9uYWxwYXJhbXNdIC0gaWYgcGFzc2VkIGFuZCBkaWZmZXJlbnQgdGhhbiBmYWxzZSBpdCB3aWxsIHN0cmlwIHRoZSBxdWVyeXN0cmluZyBwYXJhbXMgcGFyZW50VXJsIGFuZCBwYXJlbnRUaXRsZSBwYXNzZWQgdG8gdGhlIGlmcmFtZSBzcmMKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2NvbmZpZy50cmFja3Njcm9sbF0gLSBpZiBwYXNzZWQgaXQgd2lsbCBhY3RpdmF0ZSBzY3JvbGwgdHJhY2tpbmcgb24gdGhlIHBhcmVudAogICAgICogQHBhcmFtIHtudW1iZXJ9IFtjb25maWcuc2Nyb2xsd2FpdF0gLSBpZiBwYXNzZWQgaXQgd2lsbCBzZXQgdGhlIHRocm90dGxlIHdhaXQgaW4gb3JkZXIgdG8gZmlyZSBzY3JvbGwgbWVzc2FnaW5nLiBEZWZhdWx0cyB0byAxMDAgbXMuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjb25maWcubGF6eWxvYWRdIC0gaWYgcGFzc2VkIGFuZCBkaWZmZXJlbnQgdGhhbiBmYWxzZSBjb25zdHJ1Y3QgYSBpZnJhbWUgdGhhdCBjYW4gYmUgbGF6eSBsb2FkZWQgYWxvbmcgd2l0aCB7QGxpbmsgaHR0cDovL2RpbmJyb3IuZGsvYmxvZy9ibGF6eS8/cmVmPWdpdGh1YiNpZnJhbWUgYmxhenktaWZyYW1lfQogICAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSFRNTC9FbGVtZW50L2lmcmFtZSBpRnJhbWV9CiAgICAgKi8KICAgIGxpYi5QYXJlbnQgPSBmdW5jdGlvbihpZCwgdXJsLCBjb25maWcpIHsKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgaWQgb2YgdGhlIGNvbnRhaW5lciBlbGVtZW50CiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9IGlkCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5pZCA9IGlkOwogICAgICAgIC8qKgogICAgICAgICAqIFRoZSB1cmwgdGhhdCB3aWxsIGJlIHNldCBhcyB0aGUgaWZyYW1lJ3Mgc3JjCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWVtYmVyIHtTdHJpbmd9IHVybAogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMudXJsID0gdXJsOwoKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgY29udGFpbmVyIERPTSBvYmplY3QKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZW1iZXIge0hUTUxFbGVtZW50fSBlbAogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGNvbnRhaW5lZCBjaGlsZCBpZnJhbWUKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZW1iZXIge0hUTUxFbGVtZW50fSBpZnJhbWUKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKiBAZGVmYXVsdCBudWxsCiAgICAgICAgICovCiAgICAgICAgdGhpcy5pZnJhbWUgPSBudWxsOwogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBwYXJlbnQgaW5zdGFuY2Ugc2V0dGluZ3MsIHVwZGF0ZWQgYnkgdGhlIHZhbHVlcyBwYXNzZWQgaW4gdGhlIGNvbmZpZyBvYmplY3QKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZW1iZXIge09iamVjdH0gc2V0dGluZ3MKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLnNldHRpbmdzID0gewogICAgICAgICAgICB4ZG9tYWluOiAnKicsCiAgICAgICAgICAgIG9wdGlvbmFscGFyYW1zOiB0cnVlLAogICAgICAgICAgICBwYXJlbnR1cmxwYXJhbTogJ3BhcmVudFVybCcsCiAgICAgICAgICAgIHBhcmVudHVybHZhbHVlOiB3aW5kb3cubG9jYXRpb24uaHJlZiwKICAgICAgICAgICAgdHJhY2tzY3JvbGw6IGZhbHNlLAogICAgICAgICAgICBzY3JvbGx3YWl0OiAxMDAsCiAgICAgICAgfTsKICAgICAgICAvKioKICAgICAgICAgKiBSZWd1bGFyRXhwcmVzc2lvbiB0byB2YWxpZGF0ZSB0aGUgcmVjZWl2ZWQgbWVzc2FnZXMKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZW1iZXIge1N0cmluZ30gbWVzc2FnZVJlZ2V4CiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5tZXNzYWdlUmVnZXggPSBfbWFrZU1lc3NhZ2VSZWdleCh0aGlzLmlkKTsKICAgICAgICAvKioKICAgICAgICAgKiBTdG9yZXMgdGhlIHJlZ2lzdGVyZWQgbWVzc2FnZUhhbmRsZXJzIGZvciBlYWNoIG1lc3NhZ2VUeXBlCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWVtYmVyIHtPYmplY3R9IG1lc3NhZ2VIYW5kbGVycwogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMubWVzc2FnZUhhbmRsZXJzID0ge307CgogICAgICAgIC8vIGVuc3VyZSBhIGNvbmZpZyBvYmplY3QKICAgICAgICBjb25maWcgPSAoY29uZmlnIHx8IHt9KTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29uc3RydWN0IHRoZSBpZnJhbWUuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWV0aG9kIF9jb25zdHJ1Y3RJZnJhbWUKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLl9jb25zdHJ1Y3RJZnJhbWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIHRoZSB3aWR0aCBvZiB0aGlzIGVsZW1lbnQuCiAgICAgICAgICAgIHZhciB3aWR0aCA9IHRoaXMuZWwub2Zmc2V0V2lkdGgudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIC8vIENyZWF0ZSBhbiBpZnJhbWUgZWxlbWVudCBhdHRhY2hlZCB0byB0aGUgZG9jdW1lbnQuCiAgICAgICAgICAgIHRoaXMuaWZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CgogICAgICAgICAgICAvLyBTYXZlIGZyYWdtZW50IGlkCiAgICAgICAgICAgIHZhciBoYXNoID0gJyc7CiAgICAgICAgICAgIHZhciBoYXNoSW5kZXggPSB0aGlzLnVybC5pbmRleE9mKCcjJyk7CgogICAgICAgICAgICBpZiAoaGFzaEluZGV4ID4gLTEpIHsKICAgICAgICAgICAgICAgIGhhc2ggPSB0aGlzLnVybC5zdWJzdHJpbmcoaGFzaEluZGV4LCB0aGlzLnVybC5sZW5ndGgpOwogICAgICAgICAgICAgICAgdGhpcy51cmwgPSB0aGlzLnVybC5zdWJzdHJpbmcoMCwgaGFzaEluZGV4KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgdGhlIFVSTCBjb250YWlucyBxdWVyeXN0cmluZyBiaXRzLCB1c2UgdGhlbS4KICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBqdXN0IGNyZWF0ZSBhIHNldCBvZiB2YWxpZCBwYXJhbXMuCiAgICAgICAgICAgIGlmICh0aGlzLnVybC5pbmRleE9mKCc/JykgPCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVybCArPSAnPyc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnVybCArPSAnJic7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFwcGVuZCB0aGUgaW5pdGlhbCB3aWR0aCBhcyBhIHF1ZXJ5c3RyaW5nIHBhcmFtZXRlcgogICAgICAgICAgICAvLyBhbmQgb3B0aW9uYWwgcGFyYW1zIGlmIGNvbmZpZ3VyZWQgdG8gZG8gc28KICAgICAgICAgICAgdGhpcy5pZnJhbWUuc3JjID0gdGhpcy51cmwgKyAnaW5pdGlhbFdpZHRoPScgKyB3aWR0aCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZjaGlsZElkPScgKyB0aGlzLmlkOwoKICAgICAgICAgICAgaWYgKHRoaXMuc2V0dGluZ3Mub3B0aW9uYWxwYXJhbXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNyYyArPSAnJnBhcmVudFRpdGxlPScgKyBlbmNvZGVVUklDb21wb25lbnQoZG9jdW1lbnQudGl0bGUpOwogICAgICAgICAgICAgICAgdGhpcy5pZnJhbWUuc3JjICs9ICcmJysgdGhpcy5zZXR0aW5ncy5wYXJlbnR1cmxwYXJhbSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLnNldHRpbmdzLnBhcmVudHVybHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlmcmFtZS5zcmMgKz1oYXNoOwoKICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5sYXp5bG9hZCkgewogICAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnZGF0YS1zcmMnLCB0aGlzLmlmcmFtZS5zcmMpOwogICAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnYi1sYXp5Jyk7CiAgICAgICAgICAgICAgdGhpcy5pZnJhbWUuc3JjID0gJ2Fib3V0OmJsYW5rJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2V0IHNvbWUgYXR0cmlidXRlcyB0byB0aGlzIHByb3RvLWlmcmFtZS4KICAgICAgICAgICAgdGhpcy5pZnJhbWUuc2V0QXR0cmlidXRlKCd3aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnc2Nyb2xsaW5nJywgJ25vJyk7CiAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnbWFyZ2luaGVpZ2h0JywgJzAnKTsKICAgICAgICAgICAgdGhpcy5pZnJhbWUuc2V0QXR0cmlidXRlKCdmcmFtZWJvcmRlcicsICcwJyk7CgogICAgICAgICAgICBpZiAodGhpcy5zZXR0aW5ncy50aXRsZSkgewogICAgICAgICAgICAgICAgdGhpcy5pZnJhbWUuc2V0QXR0cmlidXRlKCd0aXRsZScsIHRoaXMuc2V0dGluZ3MudGl0bGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zZXR0aW5ncy5hbGxvd2Z1bGxzY3JlZW4gIT09IHVuZGVmaW5lZCAmJiB0aGlzLnNldHRpbmdzLmFsbG93ZnVsbHNjcmVlbiAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnYWxsb3dmdWxsc2NyZWVuJywnJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnNldHRpbmdzLnNhbmRib3ggIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdGhpcy5zZXR0aW5ncy5zYW5kYm94ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgdGhpcy5pZnJhbWUuc2V0QXR0cmlidXRlKCdzYW5kYm94JywgdGhpcy5zZXR0aW5ncy5zYW5kYm94KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc2V0dGluZ3MuaWQpIHsKICAgICAgICAgICAgICAgIGlmICghZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5zZXR0aW5ncy5pZCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlmcmFtZS5zZXRBdHRyaWJ1dGUoJ2lkJywgdGhpcy5zZXR0aW5ncy5pZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnNldHRpbmdzLm5hbWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnbmFtZScsIHRoaXMuc2V0dGluZ3MubmFtZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJlcGxhY2UgdGhlIGNoaWxkIGNvbnRlbnQgaWYgbmVlZGVkCiAgICAgICAgICAgIC8vIChzb21lIENNU3MgbWlnaHQgc3RyaXAgb3V0IGVtcHR5IGVsZW1lbnRzKQogICAgICAgICAgICB3aGlsZSh0aGlzLmVsLmZpcnN0Q2hpbGQpIHsgdGhpcy5lbC5yZW1vdmVDaGlsZCh0aGlzLmVsLmZpcnN0Q2hpbGQpOyB9CiAgICAgICAgICAgIC8vIEFwcGVuZCB0aGUgaWZyYW1lIHRvIG91ciBlbGVtZW50LgogICAgICAgICAgICB0aGlzLmVsLmFwcGVuZENoaWxkKHRoaXMuaWZyYW1lKTsKCiAgICAgICAgICAgIC8vIEFkZCBhbiBldmVudCBsaXN0ZW5lciB0aGF0IHdpbGwgaGFuZGxlIHJlZHJhd2luZyB0aGUgY2hpbGQgb24gcmVzaXplLgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5fb25SZXNpemUpOwoKICAgICAgICAgICAgLy8gQWRkIGFuIGV2ZW50IGxpc3RlbmVyIHRoYXQgd2lsbCBzZW5kIHRoZSBjaGlsZCB0aGUgdmlld3BvcnQuCiAgICAgICAgICAgIGlmICh0aGlzLnNldHRpbmdzLnRyYWNrc2Nyb2xsKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5fdGhyb3R0bGVPblNjcm9sbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBTZW5kIHdpZHRoIG9uIHJlc2l6ZS4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZXRob2QgX29uUmVzaXplCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fb25SZXNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5zZW5kV2lkdGgoKTsKICAgICAgICAgICAgaWYgKHRoaXMuc2V0dGluZ3MudHJhY2tzY3JvbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VuZFZpZXdwb3J0QW5kSUZyYW1lUG9zaXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0uYmluZCh0aGlzKTsKCiAgICAgICAgLyoqCiAgICAgICAgICogU2VuZCB2aWV3cG9ydCBhbmQgaWZyYW1lIGluZm8gb24gc2Nyb2xsLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uUGFyZW50CiAgICAgICAgICogQG1ldGhvZCBfb25TY3JvbGwKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLl9vblNjcm9sbCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnNlbmRWaWV3cG9ydEFuZElGcmFtZVBvc2l0aW9uKCk7CiAgICAgICAgfS5iaW5kKHRoaXMpOwoKICAgICAgICAvKioKICAgICAgICAgKiBGaXJlIGFsbCBldmVudCBoYW5kbGVycyBmb3IgYSBnaXZlbiBtZXNzYWdlIHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWV0aG9kIF9maXJlCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZVR5cGUgVGhlIHR5cGUgb2YgbWVzc2FnZS4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbWVzc2FnZSBkYXRhLgogICAgICAgICAqLwogICAgICAgIHRoaXMuX2ZpcmUgPSBmdW5jdGlvbihtZXNzYWdlVHlwZSwgbWVzc2FnZSkgewogICAgICAgICAgICBpZiAobWVzc2FnZVR5cGUgaW4gdGhpcy5tZXNzYWdlSGFuZGxlcnMpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5tZXNzYWdlSGFuZGxlcnNbbWVzc2FnZVR5cGVdLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyc1ttZXNzYWdlVHlwZV1baV0uY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFJlbW92ZSB0aGlzIHBhcmVudCBmcm9tIHRoZSBwYWdlIGFuZCB1bmJpbmQgaXQncyBldmVudCBoYW5kbGVycy4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZXRob2QgcmVtb3ZlCiAgICAgICAgICogQGluc3RhbmNlCiAgICAgICAgICovCiAgICAgICAgdGhpcy5yZW1vdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCB0aGlzLl9wcm9jZXNzTWVzc2FnZSk7CiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLl9vblJlc2l6ZSk7CgogICAgICAgICAgICB0aGlzLmVsLnJlbW92ZUNoaWxkKHRoaXMuaWZyYW1lKTsKICAgICAgICAgICAgLy8gX2NsZWFuQXV0b0luaXRJbnN0YW5jZXMgaW4gY2FzZSB0aGlzIHBhcmVudCB3YXMgYXV0b0luaXRpYWxpemVkCiAgICAgICAgICAgIF9jbGVhbkF1dG9Jbml0SW5zdGFuY2VzKCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogUHJvY2VzcyBhIG5ldyBtZXNzYWdlIGZyb20gdGhlIGNoaWxkLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uUGFyZW50CiAgICAgICAgICogQG1ldGhvZCBfcHJvY2Vzc01lc3NhZ2UKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RXZlbnR9IGUgQSBtZXNzYWdlIGV2ZW50LgogICAgICAgICAqLwogICAgICAgIHRoaXMuX3Byb2Nlc3NNZXNzYWdlID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAvLyBGaXJzdCwgcHVudCBpZiB0aGlzIGlzbid0IGZyb20gYW4gYWNjZXB0YWJsZSB4ZG9tYWluLgogICAgICAgICAgICBpZiAoIV9pc1NhZmVNZXNzYWdlKGUsIHRoaXMuc2V0dGluZ3MpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERpc2NhcmQgb2JqZWN0IG1lc3NhZ2VzLCB3ZSBvbmx5IGNhcmUgYWJvdXQgc3RyaW5ncwogICAgICAgICAgICBpZiAodHlwZW9mIGUuZGF0YSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR3JhYiB0aGUgbWVzc2FnZSBmcm9tIHRoZSBjaGlsZCBhbmQgcGFyc2UgaXQuCiAgICAgICAgICAgIHZhciBtYXRjaCA9IGUuZGF0YS5tYXRjaCh0aGlzLm1lc3NhZ2VSZWdleCk7CgogICAgICAgICAgICAvLyBJZiB0aGVyZSdzIG5vIG1hdGNoIG9yIHRvbyBtYW55IG1hdGNoZXMgaW4gdGhlIG1lc3NhZ2UsIHB1bnQuCiAgICAgICAgICAgIGlmICghbWF0Y2ggfHwgbWF0Y2gubGVuZ3RoICE9PSAzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBtZXNzYWdlVHlwZSA9IG1hdGNoWzFdOwogICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG1hdGNoWzJdOwoKICAgICAgICAgICAgdGhpcy5fZmlyZShtZXNzYWdlVHlwZSwgbWVzc2FnZSk7CiAgICAgICAgfS5iaW5kKHRoaXMpOwoKICAgICAgICAvKioKICAgICAgICAgKiBSZXNpemUgaWZyYW1lIGluIHJlc3BvbnNlIHRvIG5ldyBoZWlnaHQgbWVzc2FnZSBmcm9tIGNoaWxkLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uUGFyZW50CiAgICAgICAgICogQG1ldGhvZCBfb25IZWlnaHRNZXNzYWdlCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbmV3IGhlaWdodC4KICAgICAgICAgKi8KICAgICAgICB0aGlzLl9vbkhlaWdodE1lc3NhZ2UgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAqIEhhbmRsZSBwYXJlbnQgaGVpZ2h0IG1lc3NhZ2UgZnJvbSBjaGlsZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHZhciBoZWlnaHQgPSBwYXJzZUludChtZXNzYWdlKTsKCiAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnaGVpZ2h0JywgaGVpZ2h0ICsgJ3B4Jyk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogTmF2aWdhdGUgcGFyZW50IHRvIGEgbmV3IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZXRob2QgX29uTmF2aWdhdGVUb01lc3NhZ2UKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlIFRoZSB1cmwgdG8gbmF2aWdhdGUgdG8uCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fb25OYXZpZ2F0ZVRvTWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICogSGFuZGxlIHBhcmVudCBzY3JvbGwgbWVzc2FnZSBmcm9tIGNoaWxkLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IG1lc3NhZ2U7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogU2Nyb2xsIHBhcmVudCB0byBhIGdpdmVuIGNoaWxkIHBvc2l0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uUGFyZW50CiAgICAgICAgICogQG1ldGhvZCBfb25TY3JvbGxUb0NoaWxkUG9zTWVzc2FnZQogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG9mZnNldCBpbnNpZGUgdGhlIGNoaWxkIHBhZ2UuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fb25TY3JvbGxUb0NoaWxkUG9zTWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICAgICAgLy8gR2V0IHRoZSBjaGlsZCBjb250YWluZXIgcG9zaXRpb24gdXNpbmcgZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICsgcGFnZVlPZmZzZXQKICAgICAgICAgICAgLy8gdmlhIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9FbGVtZW50L2dldEJvdW5kaW5nQ2xpZW50UmVjdAogICAgICAgICAgICB2YXIgaWZyYW1lUG9zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5pZCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wICsgd2luZG93LnBhZ2VZT2Zmc2V0OwoKICAgICAgICAgICAgdmFyIHRvdGFsT2Zmc2V0ID0gaWZyYW1lUG9zICsgcGFyc2VJbnQobWVzc2FnZSk7CiAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCB0b3RhbE9mZnNldCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQmluZCBhIGNhbGxiYWNrIHRvIGEgZ2l2ZW4gbWVzc2FnZVR5cGUgZnJvbSB0aGUgY2hpbGQuCiAgICAgICAgICoKICAgICAgICAgKiBSZXNlcnZlZCBtZXNzYWdlIG5hbWVzIGFyZTogImhlaWdodCIsICJzY3JvbGxUbyIgYW5kICJuYXZpZ2F0ZVRvIi4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZXRob2Qgb25NZXNzYWdlCiAgICAgICAgICogQGluc3RhbmNlCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZVR5cGUgVGhlIHR5cGUgb2YgbWVzc2FnZSBiZWluZyBsaXN0ZW5lZCBmb3IuCiAgICAgICAgICogQHBhcmFtIHttb2R1bGU6cHltLlBhcmVudH5vbk1lc3NhZ2VDYWxsYmFja30gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIHRvIGludm9rZSB3aGVuIGEgbWVzc2FnZSBvZiB0aGUgZ2l2ZW4gdHlwZSBpcyByZWNlaXZlZC4KICAgICAgICAgKi8KICAgICAgICB0aGlzLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2VUeXBlLCBjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoIShtZXNzYWdlVHlwZSBpbiB0aGlzLm1lc3NhZ2VIYW5kbGVycykpIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZUhhbmRsZXJzW21lc3NhZ2VUeXBlXSA9IFtdOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyc1ttZXNzYWdlVHlwZV0ucHVzaChjYWxsYmFjayk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQGNhbGxiYWNrIG1vZHVsZTpweW0uUGFyZW50fm9uTWVzc2FnZUNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG1lc3NhZ2UgZGF0YS4KICAgICAgICAgKi8KCiAgICAgICAgLyoqCiAgICAgICAgICogU2VuZCBhIG1lc3NhZ2UgdG8gdGhlIHRoZSBjaGlsZC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZXRob2Qgc2VuZE1lc3NhZ2UKICAgICAgICAgKiBAaW5zdGFuY2UKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlVHlwZSBUaGUgdHlwZSBvZiBtZXNzYWdlIHRvIHNlbmQuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG1lc3NhZ2UgZGF0YSB0byBzZW5kLgogICAgICAgICAqLwogICAgICAgIHRoaXMuc2VuZE1lc3NhZ2UgPSBmdW5jdGlvbihtZXNzYWdlVHlwZSwgbWVzc2FnZSkgewogICAgICAgICAgICAvLyBXaGVuIHVzZWQgYWxvbmdzaWRlIHdpdGggcGpheCBzb21lIHJlZmVyZW5jZXMgYXJlIGxvc3QKICAgICAgICAgICAgaWYgKHRoaXMuZWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lmcmFtZScpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lmcmFtZScpWzBdLmNvbnRlbnRXaW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKVswXS5jb250ZW50V2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgIC5wb3N0TWVzc2FnZShfbWFrZU1lc3NhZ2UodGhpcy5pZCwgbWVzc2FnZVR5cGUsIG1lc3NhZ2UpLCAnKicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29udGVudGxlc3MgY2hpbGQgZGV0ZWN0ZWQgcmVtb3ZlIGxpc3RlbmVycyBhbmQgaWZyYW1lCiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFRyYW5zbWl0IHRoZSBjdXJyZW50IGlmcmFtZSB3aWR0aCB0byB0aGUgY2hpbGQuCiAgICAgICAgICoKICAgICAgICAgKiBZb3Ugc2hvdWxkbid0IG5lZWQgdG8gY2FsbCB0aGlzIGRpcmVjdGx5LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uUGFyZW50CiAgICAgICAgICogQG1ldGhvZCBzZW5kV2lkdGgKICAgICAgICAgKiBAaW5zdGFuY2UKICAgICAgICAgKi8KICAgICAgICB0aGlzLnNlbmRXaWR0aCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgd2lkdGggPSB0aGlzLmVsLm9mZnNldFdpZHRoLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIHRoaXMuc2VuZE1lc3NhZ2UoJ3dpZHRoJywgd2lkdGgpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFRyYW5zbWl0IHRoZSBjdXJyZW50IHZpZXdwb3J0IGFuZCBpZnJhbWUgcG9zaXRpb24gdG8gdGhlIGNoaWxkLgogICAgICAgICAqIFNlbmRzIHZpZXdwb3J0IHdpZHRoLCB2aWV3cG9ydCBoZWlnaHQKICAgICAgICAgKiBhbmQgaWZyYW1lIGJvdW5kaW5nIHJlY3QgdG9wLWxlZnQtYm90dG9tLXJpZ2h0CiAgICAgICAgICogYWxsIHNlcGFyYXRlZCBieSBzcGFjZXMKICAgICAgICAgKgogICAgICAgICAqIFlvdSBzaG91bGRuJ3QgbmVlZCB0byBjYWxsIHRoaXMgZGlyZWN0bHkuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWV0aG9kIHNlbmRWaWV3cG9ydEFuZElGcmFtZVBvc2l0aW9uCiAgICAgICAgICogQGluc3RhbmNlCiAgICAgICAgICovCiAgICAgICAgdGhpcy5zZW5kVmlld3BvcnRBbmRJRnJhbWVQb3NpdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaWZyYW1lUmVjdCA9IHRoaXMuaWZyYW1lLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICB2YXIgdldpZHRoICAgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGg7CiAgICAgICAgICAgIHZhciB2SGVpZ2h0ICA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICB2YXIgcGF5bG9hZCA9IHZXaWR0aCArICcgJyArIHZIZWlnaHQ7CiAgICAgICAgICAgIHBheWxvYWQgKz0gJyAnICsgaWZyYW1lUmVjdC50b3AgKyAnICcgKyBpZnJhbWVSZWN0LmxlZnQ7CiAgICAgICAgICAgIHBheWxvYWQgKz0gJyAnICsgaWZyYW1lUmVjdC5ib3R0b20gKyAnICcgKyBpZnJhbWVSZWN0LnJpZ2h0OwogICAgICAgICAgICB0aGlzLnNlbmRNZXNzYWdlKCd2aWV3cG9ydC1pZnJhbWUtcG9zaXRpb24nLCBwYXlsb2FkKTsKICAgICAgICB9OwoKICAgICAgICAvLyBBZGQgYW55IG92ZXJyaWRlcyB0byBzZXR0aW5ncyBjb21pbmcgZnJvbSBjb25maWcuCiAgICAgICAgZm9yICh2YXIga2V5IGluIGNvbmZpZykgewogICAgICAgICAgICB0aGlzLnNldHRpbmdzW2tleV0gPSBjb25maWdba2V5XTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIFRocm90dGxlZCBzY3JvbGwgZnVuY3Rpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWV0aG9kIF90aHJvdHRsZU9uU2Nyb2xsCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fdGhyb3R0bGVPblNjcm9sbCA9IF90aHJvdHRsZSh0aGlzLl9vblNjcm9sbC5iaW5kKHRoaXMpLCB0aGlzLnNldHRpbmdzLnNjcm9sbHdhaXQpOwoKICAgICAgICAvLyBCaW5kIHJlcXVpcmVkIG1lc3NhZ2UgaGFuZGxlcnMKICAgICAgICB0aGlzLm9uTWVzc2FnZSgnaGVpZ2h0JywgdGhpcy5fb25IZWlnaHRNZXNzYWdlKTsKICAgICAgICB0aGlzLm9uTWVzc2FnZSgnbmF2aWdhdGVUbycsIHRoaXMuX29uTmF2aWdhdGVUb01lc3NhZ2UpOwogICAgICAgIHRoaXMub25NZXNzYWdlKCdzY3JvbGxUb0NoaWxkUG9zJywgdGhpcy5fb25TY3JvbGxUb0NoaWxkUG9zTWVzc2FnZSk7CiAgICAgICAgdGhpcy5vbk1lc3NhZ2UoJ3BhcmVudFBvc2l0aW9uSW5mbycsIHRoaXMuc2VuZFZpZXdwb3J0QW5kSUZyYW1lUG9zaXRpb24pOwoKICAgICAgICAvLyBBZGQgYSBsaXN0ZW5lciBmb3IgcHJvY2Vzc2luZyBtZXNzYWdlcyBmcm9tIHRoZSBjaGlsZC4KICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIHRoaXMuX3Byb2Nlc3NNZXNzYWdlLCBmYWxzZSk7CgogICAgICAgIC8vIENvbnN0cnVjdCB0aGUgaWZyYW1lIGluIHRoZSBjb250YWluZXIgZWxlbWVudC4KICAgICAgICB0aGlzLl9jb25zdHJ1Y3RJZnJhbWUoKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIC8qKgogICAgICogVGhlIENoaWxkIGhhbGYgb2YgYSByZXNwb25zaXZlIGlmcmFtZS4KICAgICAqCiAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bQogICAgICogQGNsYXNzIENoaWxkCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW2NvbmZpZ10gQ29uZmlndXJhdGlvbiBmb3IgdGhlIGNoaWxkIGluc3RhbmNlLiBzZXRzIHtAbGluayBtb2R1bGU6cHltLkNoaWxkfnNldHRpbmdzfQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gW2NvbmZpZy5yZW5kZXJDYWxsYmFjaz1udWxsXSBDYWxsYmFjayBpbnZva2VkIGFmdGVyIHJlY2VpdmluZyBhIHJlc2l6ZSBldmVudCBmcm9tIHRoZSBwYXJlbnQsIHNldHMge0BsaW5rIG1vZHVsZTpweW0uQ2hpbGQjc2V0dGluZ3MucmVuZGVyQ2FsbGJhY2t9CiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbmZpZy54ZG9tYWluPScqJ10gLSB4ZG9tYWluIHRvIHZhbGlkYXRlIG1lc3NhZ2VzIHJlY2VpdmVkCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2NvbmZpZy5wb2xsaW5nPTBdIC0gcG9sbGluZyBmcmVxdWVuY3kgaW4gbWlsbGlzZWNvbmRzIHRvIHNlbmQgaGVpZ2h0IHRvIHBhcmVudAogICAgICogQHBhcmFtIHtudW1iZXJ9IFtjb25maWcuaWRdIC0gcGFyZW50IGNvbnRhaW5lciBpZCB1c2VkIHdoZW4gbmF2aWdhdGluZyB0aGUgY2hpbGQgaWZyYW1lIHRvIGEgbmV3IHBhZ2UgYnV0IHdlIHdhbnQgdG8ga2VlcCBpdCByZXNwb25zaXZlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb25maWcucGFyZW50dXJscGFyYW1dIC0gaWYgcGFzc2VkIGl0IHdpbGwgYmUgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgcGFyZW50VXJsIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXIgbmFtZSBleHBlY3RlZCBvbiB0aGUgaWZyYW1lIHNyYwogICAgICovCiAgICBsaWIuQ2hpbGQgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgaW5pdGlhbCB3aWR0aCBvZiB0aGUgcGFyZW50IHBhZ2UKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSBwYXJlbnRXaWR0aAogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMucGFyZW50V2lkdGggPSBudWxsOwogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBpZCBvZiB0aGUgcGFyZW50IGNvbnRhaW5lcgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWVtYmVyIHtTdHJpbmd9IGlkCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5pZCA9IG51bGw7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHRpdGxlIG9mIHRoZSBwYXJlbnQgcGFnZSBmcm9tIGRvY3VtZW50LnRpdGxlLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWVtYmVyIHtTdHJpbmd9IHBhcmVudFRpdGxlCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5wYXJlbnRUaXRsZSA9IG51bGw7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIFVSTCBvZiB0aGUgcGFyZW50IHBhZ2UgZnJvbSB3aW5kb3cubG9jYXRpb24uaHJlZi4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1lbWJlciB7U3RyaW5nfSBwYXJlbnRVcmwKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLnBhcmVudFVybCA9IG51bGw7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHNldHRpbmdzIGZvciB0aGUgY2hpbGQgaW5zdGFuY2UuIENhbiBiZSBvdmVycmlkZW4gYnkgcGFzc2luZyBhIGNvbmZpZyBvYmplY3QgdG8gdGhlIGNoaWxkIGNvbnN0cnVjdG9yCiAgICAgICAgICogaS5lLjogdmFyIHB5bUNoaWxkID0gbmV3IHB5bS5DaGlsZCh7cmVuZGVyQ2FsbGJhY2s6IHJlbmRlciwgeGRvbWFpbjogIlxcKlwubnByXC5vcmcifSkKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkLnNldHRpbmdzCiAgICAgICAgICogQG1lbWJlciB7T2JqZWN0fSBzZXR0aW5ncyAtIGRlZmF1bHQgc2V0dGluZ3MgZm9yIHRoZSBjaGlsZCBpbnN0YW5jZQogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMuc2V0dGluZ3MgPSB7CiAgICAgICAgICAgIHJlbmRlckNhbGxiYWNrOiBudWxsLAogICAgICAgICAgICB4ZG9tYWluOiAnKicsCiAgICAgICAgICAgIHBvbGxpbmc6IDAsCiAgICAgICAgICAgIHBhcmVudHVybHBhcmFtOiAncGFyZW50VXJsJwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFRoZSB0aW1lcklkIGluIG9yZGVyIHRvIGJlIGFibGUgdG8gc3RvcCB3aGVuIHBvbGxpbmcgaXMgZW5hYmxlZAogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWVtYmVyIHtTdHJpbmd9IHRpbWVySWQKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLnRpbWVySWQgPSBudWxsOwogICAgICAgIC8qKgogICAgICAgICAqIFJlZ3VsYXJFeHByZXNzaW9uIHRvIHZhbGlkYXRlIHRoZSByZWNlaXZlZCBtZXNzYWdlcwogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWVtYmVyIHtTdHJpbmd9IG1lc3NhZ2VSZWdleAogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMubWVzc2FnZVJlZ2V4ID0gbnVsbDsKICAgICAgICAvKioKICAgICAgICAgKiBTdG9yZXMgdGhlIHJlZ2lzdGVyZWQgbWVzc2FnZUhhbmRsZXJzIGZvciBlYWNoIG1lc3NhZ2VUeXBlCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZW1iZXIge09iamVjdH0gbWVzc2FnZUhhbmRsZXJzCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5tZXNzYWdlSGFuZGxlcnMgPSB7fTsKCiAgICAgICAgLy8gRW5zdXJlIGEgY29uZmlnIG9iamVjdAogICAgICAgIGNvbmZpZyA9IChjb25maWcgfHwge30pOwoKICAgICAgICAvKioKICAgICAgICAgKiBCaW5kIGEgY2FsbGJhY2sgdG8gYSBnaXZlbiBtZXNzYWdlVHlwZSBmcm9tIHRoZSBjaGlsZC4KICAgICAgICAgKgogICAgICAgICAqIFJlc2VydmVkIG1lc3NhZ2UgbmFtZXMgYXJlOiAid2lkdGgiLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWV0aG9kIG9uTWVzc2FnZQogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2VUeXBlIFRoZSB0eXBlIG9mIG1lc3NhZ2UgYmVpbmcgbGlzdGVuZWQgZm9yLgogICAgICAgICAqIEBwYXJhbSB7bW9kdWxlOnB5bS5DaGlsZH5vbk1lc3NhZ2VDYWxsYmFja30gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIHRvIGludm9rZSB3aGVuIGEgbWVzc2FnZSBvZiB0aGUgZ2l2ZW4gdHlwZSBpcyByZWNlaXZlZC4KICAgICAgICAgKi8KICAgICAgICB0aGlzLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2VUeXBlLCBjYWxsYmFjaykgewoKICAgICAgICAgICAgaWYgKCEobWVzc2FnZVR5cGUgaW4gdGhpcy5tZXNzYWdlSGFuZGxlcnMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyc1ttZXNzYWdlVHlwZV0gPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNzYWdlSGFuZGxlcnNbbWVzc2FnZVR5cGVdLnB1c2goY2FsbGJhY2spOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBjYWxsYmFjayBtb2R1bGU6cHltLkNoaWxkfm9uTWVzc2FnZUNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG1lc3NhZ2UgZGF0YS4KICAgICAgICAgKi8KCgogICAgICAgIC8qKgogICAgICAgICAqIEZpcmUgYWxsIGV2ZW50IGhhbmRsZXJzIGZvciBhIGdpdmVuIG1lc3NhZ2UgdHlwZS4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1ldGhvZCBfZmlyZQogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2VUeXBlIFRoZSB0eXBlIG9mIG1lc3NhZ2UuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG1lc3NhZ2UgZGF0YS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLl9maXJlID0gZnVuY3Rpb24obWVzc2FnZVR5cGUsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICogRmlyZSBhbGwgZXZlbnQgaGFuZGxlcnMgZm9yIGEgZ2l2ZW4gbWVzc2FnZSB0eXBlLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaWYgKG1lc3NhZ2VUeXBlIGluIHRoaXMubWVzc2FnZUhhbmRsZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubWVzc2FnZUhhbmRsZXJzW21lc3NhZ2VUeXBlXS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgdGhpcy5tZXNzYWdlSGFuZGxlcnNbbWVzc2FnZVR5cGVdW2ldLmNhbGwodGhpcywgbWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBQcm9jZXNzIGEgbmV3IG1lc3NhZ2UgZnJvbSB0aGUgcGFyZW50LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWV0aG9kIF9wcm9jZXNzTWVzc2FnZQogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtFdmVudH0gZSBBIG1lc3NhZ2UgZXZlbnQuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fcHJvY2Vzc01lc3NhZ2UgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICogUHJvY2VzcyBhIG5ldyBtZXNzYWdlIGZyb20gcGFyZW50IGZyYW1lLgogICAgICAgICAgICAqLwogICAgICAgICAgICAvLyBGaXJzdCwgcHVudCBpZiB0aGlzIGlzbid0IGZyb20gYW4gYWNjZXB0YWJsZSB4ZG9tYWluLgogICAgICAgICAgICBpZiAoIV9pc1NhZmVNZXNzYWdlKGUsIHRoaXMuc2V0dGluZ3MpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERpc2NhcmQgb2JqZWN0IG1lc3NhZ2VzLCB3ZSBvbmx5IGNhcmUgYWJvdXQgc3RyaW5ncwogICAgICAgICAgICBpZiAodHlwZW9mIGUuZGF0YSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR2V0IHRoZSBtZXNzYWdlIGZyb20gdGhlIHBhcmVudC4KICAgICAgICAgICAgdmFyIG1hdGNoID0gZS5kYXRhLm1hdGNoKHRoaXMubWVzc2FnZVJlZ2V4KTsKCiAgICAgICAgICAgIC8vIElmIHRoZXJlJ3Mgbm8gbWF0Y2ggb3IgaXQncyBhIGJhZCBmb3JtYXQsIHB1bnQuCiAgICAgICAgICAgIGlmICghbWF0Y2ggfHwgbWF0Y2gubGVuZ3RoICE9PSAzKSB7IHJldHVybjsgfQoKICAgICAgICAgICAgdmFyIG1lc3NhZ2VUeXBlID0gbWF0Y2hbMV07CiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gbWF0Y2hbMl07CgogICAgICAgICAgICB0aGlzLl9maXJlKG1lc3NhZ2VUeXBlLCBtZXNzYWdlKTsKICAgICAgICB9LmJpbmQodGhpcyk7CgogICAgICAgIC8qKgogICAgICAgICAqIFJlc2l6ZSBpZnJhbWUgaW4gcmVzcG9uc2UgdG8gbmV3IHdpZHRoIG1lc3NhZ2UgZnJvbSBwYXJlbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZXRob2QgX29uV2lkdGhNZXNzYWdlCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbmV3IHdpZHRoLgogICAgICAgICAqLwogICAgICAgIHRoaXMuX29uV2lkdGhNZXNzYWdlID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICAvKgogICAgICAgICAgICAgKiBIYW5kbGUgd2lkdGggbWVzc2FnZSBmcm9tIHRoZSBjaGlsZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHZhciB3aWR0aCA9IHBhcnNlSW50KG1lc3NhZ2UpOwoKICAgICAgICAgICAgLy8gQ2hhbmdlIHRoZSB3aWR0aCBpZiBpdCdzIGRpZmZlcmVudC4KICAgICAgICAgICAgaWYgKHdpZHRoICE9PSB0aGlzLnBhcmVudFdpZHRoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudFdpZHRoID0gd2lkdGg7CgogICAgICAgICAgICAgICAgLy8gQ2FsbCB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gaWYgaXQgZXhpc3RzLgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2V0dGluZ3MucmVuZGVyQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldHRpbmdzLnJlbmRlckNhbGxiYWNrKHdpZHRoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTZW5kIHRoZSBoZWlnaHQgYmFjayB0byB0aGUgcGFyZW50LgogICAgICAgICAgICAgICAgdGhpcy5zZW5kSGVpZ2h0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBTZW5kIGEgbWVzc2FnZSB0byB0aGUgdGhlIFBhcmVudC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1ldGhvZCBzZW5kTWVzc2FnZQogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2VUeXBlIFRoZSB0eXBlIG9mIG1lc3NhZ2UgdG8gc2VuZC4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbWVzc2FnZSBkYXRhIHRvIHNlbmQuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5zZW5kTWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2VUeXBlLCBtZXNzYWdlKSB7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAqIFNlbmQgYSBtZXNzYWdlIHRvIHRoZSBwYXJlbnQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKF9tYWtlTWVzc2FnZSh0aGlzLmlkLCBtZXNzYWdlVHlwZSwgbWVzc2FnZSksICcqJyk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogVHJhbnNtaXQgdGhlIGN1cnJlbnQgaWZyYW1lIGhlaWdodCB0byB0aGUgcGFyZW50LgogICAgICAgICAqCiAgICAgICAgICogQ2FsbCB0aGlzIGRpcmVjdGx5IGluIGNhc2VzIHdoZXJlIHlvdSBtYW51YWxseSBhbHRlciB0aGUgaGVpZ2h0IG9mIHRoZSBpZnJhbWUgY29udGVudHMuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZXRob2Qgc2VuZEhlaWdodAogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqLwogICAgICAgIHRoaXMuc2VuZEhlaWdodCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBHZXQgdGhlIGNoaWxkJ3MgaGVpZ2h0LgogICAgICAgICAgICB2YXIgaGVpZ2h0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXS5vZmZzZXRIZWlnaHQudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIC8vIFNlbmQgdGhlIGhlaWdodCB0byB0aGUgcGFyZW50LgogICAgICAgICAgICB0aGlzLnNlbmRNZXNzYWdlKCdoZWlnaHQnLCBoZWlnaHQpOwoKICAgICAgICAgICAgcmV0dXJuIGhlaWdodDsKICAgICAgICB9LmJpbmQodGhpcyk7CgogICAgICAgIC8qKgogICAgICAgICAqIEFzayBwYXJlbnQgdG8gc2VuZCB0aGUgY3VycmVudCB2aWV3cG9ydCBhbmQgaWZyYW1lIHBvc2l0aW9uIGluZm9ybWF0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZXRob2Qgc2VuZEhlaWdodAogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqLwogICAgICAgIHRoaXMuZ2V0UGFyZW50UG9zaXRpb25JbmZvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIFNlbmQgdGhlIGhlaWdodCB0byB0aGUgcGFyZW50LgogICAgICAgICAgICB0aGlzLnNlbmRNZXNzYWdlKCdwYXJlbnRQb3NpdGlvbkluZm8nKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBTY3JvbGwgcGFyZW50IHRvIGEgZ2l2ZW4gZWxlbWVudCBpZC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1ldGhvZCBzY3JvbGxQYXJlbnRUbwogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGhhc2ggVGhlIGlkIG9mIHRoZSBlbGVtZW50IHRvIHNjcm9sbCB0by4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnNjcm9sbFBhcmVudFRvID0gZnVuY3Rpb24oaGFzaCkgewogICAgICAgICAgICB0aGlzLnNlbmRNZXNzYWdlKCduYXZpZ2F0ZVRvJywgJyMnICsgaGFzaCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogTmF2aWdhdGUgcGFyZW50IHRvIGEgZ2l2ZW4gdXJsLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWV0aG9kIG5hdmlnYXRlUGFyZW50VG8KICAgICAgICAgKiBAaW5zdGFuY2UKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBuYXZpZ2F0ZSB0by4KICAgICAgICAgKi8KICAgICAgICB0aGlzLm5hdmlnYXRlUGFyZW50VG8gPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgdGhpcy5zZW5kTWVzc2FnZSgnbmF2aWdhdGVUbycsIHVybCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogU2Nyb2xsIHBhcmVudCB0byBhIGdpdmVuIGNoaWxkIGVsZW1lbnQgaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZXRob2Qgc2Nyb2xsUGFyZW50VG9DaGlsZEVsCiAgICAgICAgICogQGluc3RhbmNlCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIG9mIHRoZSBjaGlsZCBlbGVtZW50IHRvIHNjcm9sbCB0by4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnNjcm9sbFBhcmVudFRvQ2hpbGRFbCA9IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIC8vIEdldCB0aGUgY2hpbGQgZWxlbWVudCBwb3NpdGlvbiB1c2luZyBnZXRCb3VuZGluZ0NsaWVudFJlY3QgKyBwYWdlWU9mZnNldAogICAgICAgICAgICAvLyB2aWEgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0VsZW1lbnQvZ2V0Qm91bmRpbmdDbGllbnRSZWN0CiAgICAgICAgICAgIHZhciB0b3BQb3MgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wICsgd2luZG93LnBhZ2VZT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnNjcm9sbFBhcmVudFRvQ2hpbGRQb3ModG9wUG9zKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBTY3JvbGwgcGFyZW50IHRvIGEgcGFydGljdWxhciBjaGlsZCBvZmZzZXQuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZXRob2Qgc2Nyb2xsUGFyZW50VG9DaGlsZFBvcwogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IHBvcyBUaGUgb2Zmc2V0IG9mIHRoZSBjaGlsZCBlbGVtZW50IHRvIHNjcm9sbCB0by4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnNjcm9sbFBhcmVudFRvQ2hpbGRQb3MgPSBmdW5jdGlvbihwb3MpIHsKICAgICAgICAgICAgdGhpcy5zZW5kTWVzc2FnZSgnc2Nyb2xsVG9DaGlsZFBvcycsIHBvcy50b1N0cmluZygpKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBNYXJrIFdoZXRoZXIgdGhlIGNoaWxkIGlzIGVtYmVkZGVkIG9yIG5vdAogICAgICAgICAqIGV4ZWN1dGVzIGEgY2FsbGJhY2sgaW4gY2FzZSBpdCB3YXMgcGFzc2VkIHRvIHRoZSBjb25maWcKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1ldGhvZCBfbWFya1doZXRoZXJFbWJlZGRlZAogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHttb2R1bGU6cHltLkNoaWxkfm9uTWFya2VkRW1iZWRkZWRTdGF0dXN9IFRoZSBjYWxsYmFjayB0byBleGVjdXRlIGFmdGVyIGRldGVybWluaW5nIHdoZXRoZXIgZW1iZWRkZWQgb3Igbm90LgogICAgICAgICAqLwogICAgICAgIHZhciBfbWFya1doZXRoZXJFbWJlZGRlZCA9IGZ1bmN0aW9uKG9uTWFya2VkRW1iZWRkZWRTdGF0dXMpIHsKICAgICAgICAgIHZhciBodG1sRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdodG1sJylbMF0sCiAgICAgICAgICAgICAgbmV3Q2xhc3NGb3JIdG1sLAogICAgICAgICAgICAgIG9yaWdpbmFsSHRtbENsYXNzZXMgPSBodG1sRWxlbWVudC5jbGFzc05hbWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZih3aW5kb3cuc2VsZiAhPT0gd2luZG93LnRvcCkgewogICAgICAgICAgICAgIG5ld0NsYXNzRm9ySHRtbCA9ICJlbWJlZGRlZCI7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgIG5ld0NsYXNzRm9ySHRtbCA9ICJub3QtZW1iZWRkZWQiOwogICAgICAgICAgICB9CiAgICAgICAgICB9Y2F0Y2goZSkgewogICAgICAgICAgICBuZXdDbGFzc0Zvckh0bWwgPSAiZW1iZWRkZWQiOwogICAgICAgICAgfQogICAgICAgICAgaWYob3JpZ2luYWxIdG1sQ2xhc3Nlcy5pbmRleE9mKG5ld0NsYXNzRm9ySHRtbCkgPCAwKSB7CiAgICAgICAgICAgIGh0bWxFbGVtZW50LmNsYXNzTmFtZSA9IG9yaWdpbmFsSHRtbENsYXNzZXMgPyBvcmlnaW5hbEh0bWxDbGFzc2VzICsgJyAnICsgbmV3Q2xhc3NGb3JIdG1sIDogbmV3Q2xhc3NGb3JIdG1sOwogICAgICAgICAgICBpZihvbk1hcmtlZEVtYmVkZGVkU3RhdHVzKXsKICAgICAgICAgICAgICBvbk1hcmtlZEVtYmVkZGVkU3RhdHVzKG5ld0NsYXNzRm9ySHRtbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3JhaXNlQ3VzdG9tRXZlbnQoIm1hcmtlZC1lbWJlZGRlZCIpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBjYWxsYmFjayBtb2R1bGU6cHltLkNoaWxkfm9uTWFya2VkRW1iZWRkZWRTdGF0dXMKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gY2xhc3NuYW1lICJlbWJlZGRlZCIgb3IgIm5vdC1lbWJlZGRlZCIuCiAgICAgICAgICovCgogICAgICAgIC8qKgogICAgICAgICAqIFVuYmluZCBjaGlsZCBldmVudCBoYW5kbGVycyBhbmQgdGltZXJzLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWV0aG9kIHJlbW92ZQogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqLwogICAgICAgIHRoaXMucmVtb3ZlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgdGhpcy5fcHJvY2Vzc01lc3NhZ2UpOwogICAgICAgICAgICBpZiAodGhpcy50aW1lcklkKSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMudGltZXJJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBJbml0aWFsaXplIHNldHRpbmdzIHdpdGggb3ZlcnJpZGVzLgogICAgICAgIGZvciAodmFyIGtleSBpbiBjb25maWcpIHsKICAgICAgICAgICAgdGhpcy5zZXR0aW5nc1trZXldID0gY29uZmlnW2tleV07CiAgICAgICAgfQoKICAgICAgICAvLyBJZGVudGlmeSB3aGF0IElEIHRoZSBwYXJlbnQga25vd3MgdGhpcyBjaGlsZCBhcy4KICAgICAgICB0aGlzLmlkID0gX2dldFBhcmFtZXRlckJ5TmFtZSgnY2hpbGRJZCcpIHx8IGNvbmZpZy5pZDsKICAgICAgICB0aGlzLm1lc3NhZ2VSZWdleCA9IG5ldyBSZWdFeHAoJ15weW0nICsgTUVTU0FHRV9ERUxJTUlURVIgKyB0aGlzLmlkICsgTUVTU0FHRV9ERUxJTUlURVIgKyAnKFxcUyspJyArIE1FU1NBR0VfREVMSU1JVEVSICsgJyguKikkJyk7CgogICAgICAgIC8vIEdldCB0aGUgaW5pdGlhbCB3aWR0aCBmcm9tIGEgVVJMIHBhcmFtZXRlci4KICAgICAgICB2YXIgd2lkdGggPSBwYXJzZUludChfZ2V0UGFyYW1ldGVyQnlOYW1lKCdpbml0aWFsV2lkdGgnKSk7CgogICAgICAgIC8vIEdldCB0aGUgdXJsIG9mIHRoZSBwYXJlbnQgZnJhbWUKICAgICAgICB0aGlzLnBhcmVudFVybCA9IF9nZXRQYXJhbWV0ZXJCeU5hbWUodGhpcy5zZXR0aW5ncy5wYXJlbnR1cmxwYXJhbSk7CgogICAgICAgIC8vIEdldCB0aGUgdGl0bGUgb2YgdGhlIHBhcmVudCBmcmFtZQogICAgICAgIHRoaXMucGFyZW50VGl0bGUgPSBfZ2V0UGFyYW1ldGVyQnlOYW1lKCdwYXJlbnRUaXRsZScpOwoKICAgICAgICAvLyBCaW5kIHRoZSByZXF1aXJlZCBtZXNzYWdlIGhhbmRsZXJzCiAgICAgICAgdGhpcy5vbk1lc3NhZ2UoJ3dpZHRoJywgdGhpcy5fb25XaWR0aE1lc3NhZ2UpOwoKICAgICAgICAvLyBTZXQgdXAgYSBsaXN0ZW5lciB0byBoYW5kbGUgYW55IGluY29taW5nIG1lc3NhZ2VzLgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgdGhpcy5fcHJvY2Vzc01lc3NhZ2UsIGZhbHNlKTsKCiAgICAgICAgLy8gSWYgdGhlcmUncyBhIGNhbGxiYWNrIGZ1bmN0aW9uLCBjYWxsIGl0LgogICAgICAgIGlmICh0aGlzLnNldHRpbmdzLnJlbmRlckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MucmVuZGVyQ2FsbGJhY2sod2lkdGgpOwogICAgICAgIH0KCiAgICAgICAgLy8gU2VuZCB0aGUgaW5pdGlhbCBoZWlnaHQgdG8gdGhlIHBhcmVudC4KICAgICAgICB0aGlzLnNlbmRIZWlnaHQoKTsKCiAgICAgICAgLy8gSWYgd2UncmUgY29uZmlndXJlZCB0byBwb2xsLCBjcmVhdGUgYSBzZXRJbnRlcnZhbCB0byBoYW5kbGUgdGhhdC4KICAgICAgICBpZiAodGhpcy5zZXR0aW5ncy5wb2xsaW5nKSB7CiAgICAgICAgICAgIHRoaXMudGltZXJJZCA9IHdpbmRvdy5zZXRJbnRlcnZhbCh0aGlzLnNlbmRIZWlnaHQsIHRoaXMuc2V0dGluZ3MucG9sbGluZyk7CiAgICAgICAgfQoKICAgICAgICBfbWFya1doZXRoZXJFbWJlZGRlZChjb25maWcub25NYXJrZWRFbWJlZGRlZFN0YXR1cyk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICAvLyBJbml0aWFsaXplIGVsZW1lbnRzIHdpdGggcHltIGRhdGEgYXR0cmlidXRlcwogICAgLy8gaWYgd2UgYXJlIG5vdCBpbiBzZXJ2ZXIgY29uZmlndXJhdGlvbgogICAgaWYodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgIGxpYi5hdXRvSW5pdCh0cnVlKTsKICAgIH0KCiAgICByZXR1cm4gbGliOwp9KTsKCg=="></script>
<script src="data:application/x-javascript;base64,SFRNTFdpZGdldHMud2lkZ2V0KHsKCiAgbmFtZTogJ3dpZGdldGZyYW1lJywKCiAgdHlwZTogJ291dHB1dCcsCgogIGZhY3Rvcnk6IGZ1bmN0aW9uKGVsLCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgcmV0dXJuIHsKCiAgICAgIHJlbmRlclZhbHVlOiBmdW5jdGlvbih4KSB7CiAgICAgICAgIEhUTUxXaWRnZXRzLnB5bVBhcmVudCA9ICBuZXcgcHltLlBhcmVudChlbC5pZCwgeC51cmwsIHgub3B0aW9ucyB8fCB7fSk7CiAgICAgIH0sCgogICAgICByZXNpemU6IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgIH0KCiAgICB9OwogIH0KfSk7"></script>
</head>
<body style="background-color: white;">
<div id="htmlwidget_container">
<div id="htmlwidget-be12f890a846493dde71" class="widgetframe html-widget" style="width:100%;height:500px;">

</div>
</div>
<script type="application/json" data-for="htmlwidget-be12f890a846493dde71">{"x":{"url":"about:blank","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<script type="application/htmlwidget-sizing" data-for="htmlwidget-be12f890a846493dde71">{"viewer":{"width":"100%","height":350,"padding":15,"fill":false},"browser":{"width":"100%","height":500,"padding":40,"fill":false}}</script>
</body>
</html>
