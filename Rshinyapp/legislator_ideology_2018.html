<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>widgetframe</title>
<script src="data:application/x-javascript;base64,KGZ1bmN0aW9uKCkgewogIC8vIElmIHdpbmRvdy5IVE1MV2lkZ2V0cyBpcyBhbHJlYWR5IGRlZmluZWQsIHRoZW4gdXNlIGl0OyBvdGhlcndpc2UgY3JlYXRlIGEKICAvLyBuZXcgb2JqZWN0LiBUaGlzIGFsbG93cyBwcmVjZWRpbmcgY29kZSB0byBzZXQgb3B0aW9ucyB0aGF0IGFmZmVjdCB0aGUKICAvLyBpbml0aWFsaXphdGlvbiBwcm9jZXNzICh0aG91Z2ggbm9uZSBjdXJyZW50bHkgZXhpc3QpLgogIHdpbmRvdy5IVE1MV2lkZ2V0cyA9IHdpbmRvdy5IVE1MV2lkZ2V0cyB8fCB7fTsKCiAgLy8gU2VlIGlmIHdlJ3JlIHJ1bm5pbmcgaW4gYSB2aWV3ZXIgcGFuZS4gSWYgbm90LCB3ZSdyZSBpbiBhIHdlYiBicm93c2VyLgogIHZhciB2aWV3ZXJNb2RlID0gd2luZG93LkhUTUxXaWRnZXRzLnZpZXdlck1vZGUgPQogICAgICAvXGJ2aWV3ZXJfcGFuZT0xXGIvLnRlc3Qod2luZG93LmxvY2F0aW9uKTsKCiAgLy8gU2VlIGlmIHdlJ3JlIHJ1bm5pbmcgaW4gU2hpbnkgbW9kZS4gSWYgbm90LCBpdCdzIGEgc3RhdGljIGRvY3VtZW50LgogIC8vIE5vdGUgdGhhdCBzdGF0aWMgd2lkZ2V0cyBjYW4gYXBwZWFyIGluIGJvdGggU2hpbnkgYW5kIHN0YXRpYyBtb2RlcywgYnV0CiAgLy8gb2J2aW91c2x5LCBTaGlueSB3aWRnZXRzIGNhbiBvbmx5IGFwcGVhciBpbiBTaGlueSBhcHBzL2RvY3VtZW50cy4KICB2YXIgc2hpbnlNb2RlID0gd2luZG93LkhUTUxXaWRnZXRzLnNoaW55TW9kZSA9CiAgICAgIHR5cGVvZih3aW5kb3cuU2hpbnkpICE9PSAidW5kZWZpbmVkIiAmJiAhIXdpbmRvdy5TaGlueS5vdXRwdXRCaW5kaW5nczsKCiAgLy8gV2UgY2FuJ3QgY291bnQgb24galF1ZXJ5IGJlaW5nIGF2YWlsYWJsZSwgc28gd2UgaW1wbGVtZW50IG91ciBvd24KICAvLyB2ZXJzaW9uIGlmIG5lY2Vzc2FyeS4KICBmdW5jdGlvbiBxdWVyeVNlbGVjdG9yQWxsKHNjb3BlLCBzZWxlY3RvcikgewogICAgaWYgKHR5cGVvZihqUXVlcnkpICE9PSAidW5kZWZpbmVkIiAmJiBzY29wZSBpbnN0YW5jZW9mIGpRdWVyeSkgewogICAgICByZXR1cm4gc2NvcGUuZmluZChzZWxlY3Rvcik7CiAgICB9CiAgICBpZiAoc2NvcGUucXVlcnlTZWxlY3RvckFsbCkgewogICAgICByZXR1cm4gc2NvcGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhc0FycmF5KHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwpCiAgICAgIHJldHVybiBbXTsKICAgIGlmICgkLmlzQXJyYXkodmFsdWUpKQogICAgICByZXR1cm4gdmFsdWU7CiAgICByZXR1cm4gW3ZhbHVlXTsKICB9CgogIC8vIEltcGxlbWVudCBqUXVlcnkncyBleHRlbmQKICBmdW5jdGlvbiBleHRlbmQodGFyZ2V0IC8qLCAuLi4gKi8pIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV07CiAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgdGFyZ2V0W3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHRhcmdldDsKICB9CgogIC8vIElFOCBkb2Vzbid0IHN1cHBvcnQgQXJyYXkuZm9yRWFjaC4KICBmdW5jdGlvbiBmb3JFYWNoKHZhbHVlcywgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgIGlmICh2YWx1ZXMuZm9yRWFjaCkgewogICAgICB2YWx1ZXMuZm9yRWFjaChjYWxsYmFjaywgdGhpc0FyZyk7CiAgICB9IGVsc2UgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc0FyZywgdmFsdWVzW2ldLCBpLCB2YWx1ZXMpOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBSZXBsYWNlcyB0aGUgc3BlY2lmaWVkIG1ldGhvZCB3aXRoIHRoZSByZXR1cm4gdmFsdWUgb2YgZnVuY1NvdXJjZS4KICAvLwogIC8vIE5vdGUgdGhhdCBmdW5jU291cmNlIHNob3VsZCBub3QgQkUgdGhlIG5ldyBtZXRob2QsIGl0IHNob3VsZCBiZSBhIGZ1bmN0aW9uCiAgLy8gdGhhdCBSRVRVUk5TIHRoZSBuZXcgbWV0aG9kLiBmdW5jU291cmNlIHJlY2VpdmVzIGEgc2luZ2xlIGFyZ3VtZW50IHRoYXQgaXMKICAvLyB0aGUgb3ZlcnJpZGRlbiBtZXRob2QsIGl0IGNhbiBiZSBjYWxsZWQgZnJvbSB0aGUgbmV3IG1ldGhvZC4gVGhlIG92ZXJyaWRkZW4KICAvLyBtZXRob2QgY2FuIGJlIGNhbGxlZCBsaWtlIGEgcmVndWxhciBmdW5jdGlvbiwgaXQgaGFzIHRoZSB0YXJnZXQgcGVybWFuZW50bHkKICAvLyBib3VuZCB0byBpdCBzbyAidGhpcyIgd2lsbCB3b3JrIGNvcnJlY3RseS4KICBmdW5jdGlvbiBvdmVycmlkZU1ldGhvZCh0YXJnZXQsIG1ldGhvZE5hbWUsIGZ1bmNTb3VyY2UpIHsKICAgIHZhciBzdXBlckZ1bmMgPSB0YXJnZXRbbWV0aG9kTmFtZV0gfHwgZnVuY3Rpb24oKSB7fTsKICAgIHZhciBzdXBlckZ1bmNCb3VuZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3VwZXJGdW5jLmFwcGx5KHRhcmdldCwgYXJndW1lbnRzKTsKICAgIH07CiAgICB0YXJnZXRbbWV0aG9kTmFtZV0gPSBmdW5jU291cmNlKHN1cGVyRnVuY0JvdW5kKTsKICB9CgogIC8vIEFkZCBhIG1ldGhvZCB0byBkZWxlZ2F0b3IgdGhhdCwgd2hlbiBpbnZva2VkLCBjYWxscwogIC8vIGRlbGVnYXRlZS5tZXRob2ROYW1lLiBJZiB0aGVyZSBpcyBubyBzdWNoIG1ldGhvZCBvbgogIC8vIHRoZSBkZWxlZ2F0ZWUsIGJ1dCB0aGVyZSB3YXMgb25lIG9uIGRlbGVnYXRvciBiZWZvcmUKICAvLyBkZWxlZ2F0ZU1ldGhvZCB3YXMgY2FsbGVkLCB0aGVuIHRoZSBvcmlnaW5hbCB2ZXJzaW9uCiAgLy8gaXMgaW52b2tlZCBpbnN0ZWFkLgogIC8vIEZvciBleGFtcGxlOgogIC8vCiAgLy8gdmFyIGEgPSB7CiAgLy8gICBtZXRob2QxOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2ExJyk7IH0KICAvLyAgIG1ldGhvZDI6IGZ1bmN0aW9uKCkgeyBjb25zb2xlLmxvZygnYTInKTsgfQogIC8vIH07CiAgLy8gdmFyIGIgPSB7CiAgLy8gICBtZXRob2QxOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2IxJyk7IH0KICAvLyB9OwogIC8vIGRlbGVnYXRlTWV0aG9kKGEsIGIsICJtZXRob2QxIik7CiAgLy8gZGVsZWdhdGVNZXRob2QoYSwgYiwgIm1ldGhvZDIiKTsKICAvLyBhLm1ldGhvZDEoKTsKICAvLyBhLm1ldGhvZDIoKTsKICAvLwogIC8vIFRoZSBvdXRwdXQgd291bGQgYmUgImIxIiwgImEyIi4KICBmdW5jdGlvbiBkZWxlZ2F0ZU1ldGhvZChkZWxlZ2F0b3IsIGRlbGVnYXRlZSwgbWV0aG9kTmFtZSkgewogICAgdmFyIGluaGVyaXRlZCA9IGRlbGVnYXRvclttZXRob2ROYW1lXTsKICAgIGRlbGVnYXRvclttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGFyZ2V0ID0gZGVsZWdhdGVlOwogICAgICB2YXIgbWV0aG9kID0gZGVsZWdhdGVlW21ldGhvZE5hbWVdOwoKICAgICAgLy8gVGhlIG1ldGhvZCBkb2Vzbid0IGV4aXN0IG9uIHRoZSBkZWxlZ2F0ZWUuIEluc3RlYWQsCiAgICAgIC8vIGNhbGwgdGhlIG1ldGhvZCBvbiB0aGUgZGVsZWdhdG9yLCBpZiBpdCBleGlzdHMuCiAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgdGFyZ2V0ID0gZGVsZWdhdG9yOwogICAgICAgIG1ldGhvZCA9IGluaGVyaXRlZDsKICAgICAgfQoKICAgICAgaWYgKG1ldGhvZCkgewogICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGFyZ2V0LCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KCiAgLy8gSW1wbGVtZW50IGEgdmFndWUgZmFjc2ltaWxpZSBvZiBqUXVlcnkncyBkYXRhIG1ldGhvZAogIGZ1bmN0aW9uIGVsZW1lbnREYXRhKGVsLCBuYW1lLCB2YWx1ZSkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikgewogICAgICByZXR1cm4gZWxbImh0bWx3aWRnZXRfZGF0YV8iICsgbmFtZV07CiAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMykgewogICAgICBlbFsiaHRtbHdpZGdldF9kYXRhXyIgKyBuYW1lXSA9IHZhbHVlOwogICAgICByZXR1cm4gZWw7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIldyb25nIG51bWJlciBvZiBhcmd1bWVudHMgZm9yIGVsZW1lbnREYXRhOiAiICsKICAgICAgICBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0KICB9CgogIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzQ0NjE3MC9lc2NhcGUtc3RyaW5nLWZvci11c2UtaW4tamF2YXNjcmlwdC1yZWdleAogIGZ1bmN0aW9uIGVzY2FwZVJlZ0V4cChzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZSgvW1wtXFtcXVwvXHtcfVwoXClcKlwrXD9cLlxcXF5cJFx8XS9nLCAiXFwkJiIpOwogIH0KCiAgZnVuY3Rpb24gaGFzQ2xhc3MoZWwsIGNsYXNzTmFtZSkgewogICAgdmFyIHJlID0gbmV3IFJlZ0V4cCgiXFxiIiArIGVzY2FwZVJlZ0V4cChjbGFzc05hbWUpICsgIlxcYiIpOwogICAgcmV0dXJuIHJlLnRlc3QoZWwuY2xhc3NOYW1lKTsKICB9CgogIC8vIGVsZW1lbnRzIC0gYXJyYXkgKG9yIGFycmF5LWxpa2Ugb2JqZWN0KSBvZiBIVE1MIGVsZW1lbnRzCiAgLy8gY2xhc3NOYW1lIC0gY2xhc3MgbmFtZSB0byB0ZXN0IGZvcgogIC8vIGluY2x1ZGUgLSBpZiB0cnVlLCBvbmx5IHJldHVybiBlbGVtZW50cyB3aXRoIGdpdmVuIGNsYXNzTmFtZTsKICAvLyAgIGlmIGZhbHNlLCBvbmx5IHJldHVybiBlbGVtZW50cyAqd2l0aG91dCogZ2l2ZW4gY2xhc3NOYW1lCiAgZnVuY3Rpb24gZmlsdGVyQnlDbGFzcyhlbGVtZW50cywgY2xhc3NOYW1lLCBpbmNsdWRlKSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoaGFzQ2xhc3MoZWxlbWVudHNbaV0sIGNsYXNzTmFtZSkgPT0gaW5jbHVkZSkKICAgICAgICByZXN1bHRzLnB1c2goZWxlbWVudHNbaV0pOwogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfQoKICBmdW5jdGlvbiBvbihvYmosIGV2ZW50TmFtZSwgZnVuYykgewogICAgaWYgKG9iai5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgIG9iai5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgZnVuYywgZmFsc2UpOwogICAgfSBlbHNlIGlmIChvYmouYXR0YWNoRXZlbnQpIHsKICAgICAgb2JqLmF0dGFjaEV2ZW50KGV2ZW50TmFtZSwgZnVuYyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBvZmYob2JqLCBldmVudE5hbWUsIGZ1bmMpIHsKICAgIGlmIChvYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcikKICAgICAgb2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBmdW5jLCBmYWxzZSk7CiAgICBlbHNlIGlmIChvYmouZGV0YWNoRXZlbnQpIHsKICAgICAgb2JqLmRldGFjaEV2ZW50KGV2ZW50TmFtZSwgZnVuYyk7CiAgICB9CiAgfQoKICAvLyBUcmFuc2xhdGUgYXJyYXkgb2YgdmFsdWVzIHRvIHRvcC9yaWdodC9ib3R0b20vbGVmdCwgYXMgdXN1YWwgd2l0aAogIC8vIHRoZSAicGFkZGluZyIgQ1NTIHByb3BlcnR5CiAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQ1NTL3BhZGRpbmcKICBmdW5jdGlvbiB1bnBhY2tQYWRkaW5nKHZhbHVlKSB7CiAgICBpZiAodHlwZW9mKHZhbHVlKSA9PT0gIm51bWJlciIpCiAgICAgIHZhbHVlID0gW3ZhbHVlXTsKICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDEpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMF0sIGJvdHRvbTogdmFsdWVbMF0sIGxlZnQ6IHZhbHVlWzBdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDIpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMF0sIGxlZnQ6IHZhbHVlWzFdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDMpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMl0sIGxlZnQ6IHZhbHVlWzFdfTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDQpIHsKICAgICAgcmV0dXJuIHt0b3A6IHZhbHVlWzBdLCByaWdodDogdmFsdWVbMV0sIGJvdHRvbTogdmFsdWVbMl0sIGxlZnQ6IHZhbHVlWzNdfTsKICAgIH0KICB9CgogIC8vIENvbnZlcnQgYW4gdW5wYWNrZWQgcGFkZGluZyBvYmplY3QgdG8gYSBDU1MgdmFsdWUKICBmdW5jdGlvbiBwYWRkaW5nVG9Dc3MocGFkZGluZ09iaikgewogICAgcmV0dXJuIHBhZGRpbmdPYmoudG9wICsgInB4ICIgKyBwYWRkaW5nT2JqLnJpZ2h0ICsgInB4ICIgKyBwYWRkaW5nT2JqLmJvdHRvbSArICJweCAiICsgcGFkZGluZ09iai5sZWZ0ICsgInB4IjsKICB9CgogIC8vIE1ha2VzIGEgbnVtYmVyIHN1aXRhYmxlIGZvciBDU1MKICBmdW5jdGlvbiBweCh4KSB7CiAgICBpZiAodHlwZW9mKHgpID09PSAibnVtYmVyIikKICAgICAgcmV0dXJuIHggKyAicHgiOwogICAgZWxzZQogICAgICByZXR1cm4geDsKICB9CgogIC8vIFJldHJpZXZlcyBydW50aW1lIHdpZGdldCBzaXppbmcgaW5mb3JtYXRpb24gZm9yIGFuIGVsZW1lbnQuCiAgLy8gVGhlIHJldHVybiB2YWx1ZSBpcyBlaXRoZXIgbnVsbCwgb3IgYW4gb2JqZWN0IHdpdGggZmlsbCwgcGFkZGluZywKICAvLyBkZWZhdWx0V2lkdGgsIGRlZmF1bHRIZWlnaHQgZmllbGRzLgogIGZ1bmN0aW9uIHNpemluZ1BvbGljeShlbCkgewogICAgdmFyIHNpemluZ0VsID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcigic2NyaXB0W2RhdGEtZm9yPSciICsgZWwuaWQgKyAiJ11bdHlwZT0nYXBwbGljYXRpb24vaHRtbHdpZGdldC1zaXppbmcnXSIpOwogICAgaWYgKCFzaXppbmdFbCkKICAgICAgcmV0dXJuIG51bGw7CiAgICB2YXIgc3AgPSBKU09OLnBhcnNlKHNpemluZ0VsLnRleHRDb250ZW50IHx8IHNpemluZ0VsLnRleHQgfHwgInt9Iik7CiAgICBpZiAodmlld2VyTW9kZSkgewogICAgICByZXR1cm4gc3Audmlld2VyOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHNwLmJyb3dzZXI7CiAgICB9CiAgfQoKICAvLyBAcGFyYW0gdGFza3MgQXJyYXkgb2Ygc3RyaW5ncyAob3IgZmFsc3kgdmFsdWUsIGluIHdoaWNoIGNhc2Ugbm8tb3ApLgogIC8vICAgRWFjaCBlbGVtZW50IG11c3QgYmUgYSB2YWxpZCBKYXZhU2NyaXB0IGV4cHJlc3Npb24gdGhhdCB5aWVsZHMgYQogIC8vICAgZnVuY3Rpb24uIE9yLCBjYW4gYmUgYW4gYXJyYXkgb2Ygb2JqZWN0cyB3aXRoICJjb2RlIiBhbmQgImRhdGEiCiAgLy8gICBwcm9wZXJ0aWVzOyBpbiB0aGlzIGNhc2UsIHRoZSAiY29kZSIgcHJvcGVydHkgc2hvdWxkIGJlIGEgc3RyaW5nCiAgLy8gICBvZiBKUyB0aGF0J3MgYW4gZXhwciB0aGF0IHlpZWxkcyBhIGZ1bmN0aW9uLCBhbmQgImRhdGEiIHNob3VsZCBiZQogIC8vICAgYW4gb2JqZWN0IHRoYXQgd2lsbCBiZSBhZGRlZCBhcyBhbiBhZGRpdGlvbmFsIGFyZ3VtZW50IHdoZW4gdGhhdAogIC8vICAgZnVuY3Rpb24gaXMgY2FsbGVkLgogIC8vIEBwYXJhbSB0YXJnZXQgVGhlIG9iamVjdCB0aGF0IHdpbGwgYmUgInRoaXMiIGZvciBlYWNoIGZ1bmN0aW9uCiAgLy8gICBleGVjdXRpb24uCiAgLy8gQHBhcmFtIGFyZ3MgQXJyYXkgb2YgYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byB0aGUgZnVuY3Rpb25zLiAoVGhlCiAgLy8gICBzYW1lIGFyZ3VtZW50cyB3aWxsIGJlIHBhc3NlZCB0byBhbGwgZnVuY3Rpb25zLikKICBmdW5jdGlvbiBldmFsQW5kUnVuKHRhc2tzLCB0YXJnZXQsIGFyZ3MpIHsKICAgIGlmICh0YXNrcykgewogICAgICBmb3JFYWNoKHRhc2tzLCBmdW5jdGlvbih0YXNrKSB7CiAgICAgICAgdmFyIHRoZXNlQXJncyA9IGFyZ3M7CiAgICAgICAgaWYgKHR5cGVvZih0YXNrKSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHRoZXNlQXJncyA9IHRoZXNlQXJncy5jb25jYXQoW3Rhc2suZGF0YV0pOwogICAgICAgICAgdGFzayA9IHRhc2suY29kZTsKICAgICAgICB9CiAgICAgICAgdmFyIHRhc2tGdW5jID0gdHJ5RXZhbCh0YXNrKTsKICAgICAgICBpZiAodHlwZW9mKHRhc2tGdW5jKSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXNrIG11c3QgYmUgYSBmdW5jdGlvbiEgU291cmNlOlxuIiArIHRhc2spOwogICAgICAgIH0KICAgICAgICB0YXNrRnVuYy5hcHBseSh0YXJnZXQsIHRoZXNlQXJncyk7CiAgICAgIH0pOwogICAgfQogIH0KCiAgLy8gQXR0ZW1wdCBldmFsKCkgYm90aCB3aXRoIGFuZCB3aXRob3V0IGVuY2xvc2luZyBpbiBwYXJlbnRoZXNlcy4KICAvLyBOb3RlIHRoYXQgZW5jbG9zaW5nIGNvZXJjZXMgYSBmdW5jdGlvbiBkZWNsYXJhdGlvbiBpbnRvCiAgLy8gYW4gZXhwcmVzc2lvbiB0aGF0IGV2YWwoKSBjYW4gcGFyc2UKICAvLyAob3RoZXJ3aXNlLCBhIFN5bnRheEVycm9yIGlzIHRocm93bikKICBmdW5jdGlvbiB0cnlFdmFsKGNvZGUpIHsKICAgIHZhciByZXN1bHQgPSBudWxsOwogICAgdHJ5IHsKICAgICAgcmVzdWx0ID0gZXZhbChjb2RlKTsKICAgIH0gY2F0Y2goZXJyb3IpIHsKICAgICAgaWYgKCFlcnJvciBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICByZXN1bHQgPSBldmFsKCIoIiArIGNvZGUgKyAiKSIpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiBpbml0U2l6aW5nKGVsKSB7CiAgICB2YXIgc2l6aW5nID0gc2l6aW5nUG9saWN5KGVsKTsKICAgIGlmICghc2l6aW5nKQogICAgICByZXR1cm47CgogICAgdmFyIGNlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJodG1sd2lkZ2V0X2NvbnRhaW5lciIpOwogICAgaWYgKCFjZWwpCiAgICAgIHJldHVybjsKCiAgICBpZiAodHlwZW9mKHNpemluZy5wYWRkaW5nKSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5tYXJnaW4gPSAiMCI7CiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUucGFkZGluZyA9IHBhZGRpbmdUb0Nzcyh1bnBhY2tQYWRkaW5nKHNpemluZy5wYWRkaW5nKSk7CiAgICB9CgogICAgaWYgKHNpemluZy5maWxsKSB7CiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUub3ZlcmZsb3cgPSAiaGlkZGVuIjsKICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS53aWR0aCA9ICIxMDAlIjsKICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5oZWlnaHQgPSAiMTAwJSI7CiAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS53aWR0aCA9ICIxMDAlIjsKICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlLmhlaWdodCA9ICIxMDAlIjsKICAgICAgaWYgKGNlbCkgewogICAgICAgIGNlbC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICAgICAgdmFyIHBhZCA9IHVucGFja1BhZGRpbmcoc2l6aW5nLnBhZGRpbmcpOwogICAgICAgIGNlbC5zdHlsZS50b3AgPSBwYWQudG9wICsgInB4IjsKICAgICAgICBjZWwuc3R5bGUucmlnaHQgPSBwYWQucmlnaHQgKyAicHgiOwogICAgICAgIGNlbC5zdHlsZS5ib3R0b20gPSBwYWQuYm90dG9tICsgInB4IjsKICAgICAgICBjZWwuc3R5bGUubGVmdCA9IHBhZC5sZWZ0ICsgInB4IjsKICAgICAgICBlbC5zdHlsZS53aWR0aCA9ICIxMDAlIjsKICAgICAgICBlbC5zdHlsZS5oZWlnaHQgPSAiMTAwJSI7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgZ2V0V2lkdGg6IGZ1bmN0aW9uKCkgeyByZXR1cm4gY2VsLm9mZnNldFdpZHRoOyB9LAogICAgICAgIGdldEhlaWdodDogZnVuY3Rpb24oKSB7IHJldHVybiBjZWwub2Zmc2V0SGVpZ2h0OyB9CiAgICAgIH07CgogICAgfSBlbHNlIHsKICAgICAgZWwuc3R5bGUud2lkdGggPSBweChzaXppbmcud2lkdGgpOwogICAgICBlbC5zdHlsZS5oZWlnaHQgPSBweChzaXppbmcuaGVpZ2h0KTsKCiAgICAgIHJldHVybiB7CiAgICAgICAgZ2V0V2lkdGg6IGZ1bmN0aW9uKCkgeyByZXR1cm4gZWwub2Zmc2V0V2lkdGg7IH0sCiAgICAgICAgZ2V0SGVpZ2h0OiBmdW5jdGlvbigpIHsgcmV0dXJuIGVsLm9mZnNldEhlaWdodDsgfQogICAgICB9OwogICAgfQogIH0KCiAgLy8gRGVmYXVsdCBpbXBsZW1lbnRhdGlvbnMgZm9yIG1ldGhvZHMKICB2YXIgZGVmYXVsdHMgPSB7CiAgICBmaW5kOiBmdW5jdGlvbihzY29wZSkgewogICAgICByZXR1cm4gcXVlcnlTZWxlY3RvckFsbChzY29wZSwgIi4iICsgdGhpcy5uYW1lKTsKICAgIH0sCiAgICByZW5kZXJFcnJvcjogZnVuY3Rpb24oZWwsIGVycikgewogICAgICB2YXIgJGVsID0gJChlbCk7CgogICAgICB0aGlzLmNsZWFyRXJyb3IoZWwpOwoKICAgICAgLy8gQWRkIGFsbCB0aGVzZSBlcnJvciBjbGFzc2VzLCBhcyBTaGlueSBkb2VzCiAgICAgIHZhciBlcnJDbGFzcyA9ICJzaGlueS1vdXRwdXQtZXJyb3IiOwogICAgICBpZiAoZXJyLnR5cGUgIT09IG51bGwpIHsKICAgICAgICAvLyB1c2UgdGhlIGNsYXNzZXMgb2YgdGhlIGVycm9yIGNvbmRpdGlvbiBhcyBDU1MgY2xhc3MgbmFtZXMKICAgICAgICBlcnJDbGFzcyA9IGVyckNsYXNzICsgIiAiICsgJC5tYXAoYXNBcnJheShlcnIudHlwZSksIGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICAgIHJldHVybiBlcnJDbGFzcyArICItIiArIHR5cGU7CiAgICAgICAgfSkuam9pbigiICIpOwogICAgICB9CiAgICAgIGVyckNsYXNzID0gZXJyQ2xhc3MgKyAiIGh0bWx3aWRnZXRzLWVycm9yIjsKCiAgICAgIC8vIElzIGVsIGlubGluZSBvciBibG9jaz8gSWYgaW5saW5lIG9yIGlubGluZS1ibG9jaywganVzdCBkaXNwbGF5Om5vbmUgaXQKICAgICAgLy8gYW5kIGFkZCBhbiBpbmxpbmUgZXJyb3IuCiAgICAgIHZhciBkaXNwbGF5ID0gJGVsLmNzcygiZGlzcGxheSIpOwogICAgICAkZWwuZGF0YSgicmVzdG9yZS1kaXNwbGF5LW1vZGUiLCBkaXNwbGF5KTsKCiAgICAgIGlmIChkaXNwbGF5ID09PSAiaW5saW5lIiB8fCBkaXNwbGF5ID09PSAiaW5saW5lLWJsb2NrIikgewogICAgICAgICRlbC5oaWRlKCk7CiAgICAgICAgaWYgKGVyci5tZXNzYWdlICE9PSAiIikgewogICAgICAgICAgdmFyIGVycm9yU3BhbiA9ICQoIjxzcGFuPiIpLmFkZENsYXNzKGVyckNsYXNzKTsKICAgICAgICAgIGVycm9yU3Bhbi50ZXh0KGVyci5tZXNzYWdlKTsKICAgICAgICAgICRlbC5hZnRlcihlcnJvclNwYW4pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChkaXNwbGF5ID09PSAiYmxvY2siKSB7CiAgICAgICAgLy8gSWYgYmxvY2ssIGFkZCBhbiBlcnJvciBqdXN0IGFmdGVyIHRoZSBlbCwgc2V0IHZpc2liaWxpdHk6bm9uZSBvbiB0aGUKICAgICAgICAvLyBlbCwgYW5kIHBvc2l0aW9uIHRoZSBlcnJvciB0byBiZSBvbiB0b3Agb2YgdGhlIGVsLgogICAgICAgIC8vIE1hcmsgaXQgd2l0aCBhIHVuaXF1ZSBJRCBhbmQgQ1NTIGNsYXNzIHNvIHdlIGNhbiByZW1vdmUgaXQgbGF0ZXIuCiAgICAgICAgJGVsLmNzcygidmlzaWJpbGl0eSIsICJoaWRkZW4iKTsKICAgICAgICBpZiAoZXJyLm1lc3NhZ2UgIT09ICIiKSB7CiAgICAgICAgICB2YXIgZXJyb3JEaXYgPSAkKCI8ZGl2PiIpLmFkZENsYXNzKGVyckNsYXNzKS5jc3MoInBvc2l0aW9uIiwgImFic29sdXRlIikKICAgICAgICAgICAgLmNzcygidG9wIiwgZWwub2Zmc2V0VG9wKQogICAgICAgICAgICAuY3NzKCJsZWZ0IiwgZWwub2Zmc2V0TGVmdCkKICAgICAgICAgICAgLy8gc2V0dGluZyB3aWR0aCBjYW4gcHVzaCBvdXQgdGhlIHBhZ2Ugc2l6ZSwgZm9yY2luZyBvdGhlcndpc2UKICAgICAgICAgICAgLy8gdW5uZWNlc3Nhcnkgc2Nyb2xsYmFycyB0byBhcHBlYXIgYW5kIG1ha2luZyBpdCBpbXBvc3NpYmxlIGZvcgogICAgICAgICAgICAvLyB0aGUgZWxlbWVudCB0byBzaHJpbms7IHNvIHVzZSBtYXgtd2lkdGggaW5zdGVhZAogICAgICAgICAgICAuY3NzKCJtYXhXaWR0aCIsIGVsLm9mZnNldFdpZHRoKQogICAgICAgICAgICAuY3NzKCJoZWlnaHQiLCBlbC5vZmZzZXRIZWlnaHQpOwogICAgICAgICAgZXJyb3JEaXYudGV4dChlcnIubWVzc2FnZSk7CiAgICAgICAgICAkZWwuYWZ0ZXIoZXJyb3JEaXYpOwoKICAgICAgICAgIC8vIFJlYWxseSBkdW1iIHdheSB0byBrZWVwIHRoZSBzaXplL3Bvc2l0aW9uIG9mIHRoZSBlcnJvciBpbiBzeW5jIHdpdGgKICAgICAgICAgIC8vIHRoZSBwYXJlbnQgZWxlbWVudCBhcyB0aGUgd2luZG93IGlzIHJlc2l6ZWQgb3Igd2hhdGV2ZXIuCiAgICAgICAgICB2YXIgaW50SWQgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFlcnJvckRpdlswXS5wYXJlbnRFbGVtZW50KSB7CiAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRJZCk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVycm9yRGl2CiAgICAgICAgICAgICAgLmNzcygidG9wIiwgZWwub2Zmc2V0VG9wKQogICAgICAgICAgICAgIC5jc3MoImxlZnQiLCBlbC5vZmZzZXRMZWZ0KQogICAgICAgICAgICAgIC5jc3MoIm1heFdpZHRoIiwgZWwub2Zmc2V0V2lkdGgpCiAgICAgICAgICAgICAgLmNzcygiaGVpZ2h0IiwgZWwub2Zmc2V0SGVpZ2h0KTsKICAgICAgICAgIH0sIDUwMCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgY2xlYXJFcnJvcjogZnVuY3Rpb24oZWwpIHsKICAgICAgdmFyICRlbCA9ICQoZWwpOwogICAgICB2YXIgZGlzcGxheSA9ICRlbC5kYXRhKCJyZXN0b3JlLWRpc3BsYXktbW9kZSIpOwogICAgICAkZWwuZGF0YSgicmVzdG9yZS1kaXNwbGF5LW1vZGUiLCBudWxsKTsKCiAgICAgIGlmIChkaXNwbGF5ID09PSAiaW5saW5lIiB8fCBkaXNwbGF5ID09PSAiaW5saW5lLWJsb2NrIikgewogICAgICAgIGlmIChkaXNwbGF5KQogICAgICAgICAgJGVsLmNzcygiZGlzcGxheSIsIGRpc3BsYXkpOwogICAgICAgICQoZWwubmV4dFNpYmxpbmcpLmZpbHRlcigiLmh0bWx3aWRnZXRzLWVycm9yIikucmVtb3ZlKCk7CiAgICAgIH0gZWxzZSBpZiAoZGlzcGxheSA9PT0gImJsb2NrIil7CiAgICAgICAgJGVsLmNzcygidmlzaWJpbGl0eSIsICJpbmhlcml0Iik7CiAgICAgICAgJChlbC5uZXh0U2libGluZykuZmlsdGVyKCIuaHRtbHdpZGdldHMtZXJyb3IiKS5yZW1vdmUoKTsKICAgICAgfQogICAgfSwKICAgIHNpemluZzoge30KICB9OwoKICAvLyBDYWxsZWQgYnkgd2lkZ2V0IGJpbmRpbmdzIHRvIHJlZ2lzdGVyIGEgbmV3IHR5cGUgb2Ygd2lkZ2V0LiBUaGUgZGVmaW5pdGlvbgogIC8vIG9iamVjdCBjYW4gY29udGFpbiB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgLy8gLSBuYW1lIChyZXF1aXJlZCkgLSBBIHN0cmluZyBpbmRpY2F0aW5nIHRoZSBiaW5kaW5nIG5hbWUsIHdoaWNoIHdpbGwgYmUKICAvLyAgIHVzZWQgYnkgZGVmYXVsdCBhcyB0aGUgQ1NTIGNsYXNzbmFtZSB0byBsb29rIGZvci4KICAvLyAtIGluaXRpYWxpemUgKG9wdGlvbmFsKSAtIEEgZnVuY3Rpb24oZWwpIHRoYXQgd2lsbCBiZSBjYWxsZWQgb25jZSBwZXIKICAvLyAgIHdpZGdldCBlbGVtZW50OyBpZiBhIHZhbHVlIGlzIHJldHVybmVkLCBpdCB3aWxsIGJlIHBhc3NlZCBhcyB0aGUgdGhpcmQKICAvLyAgIHZhbHVlIHRvIHJlbmRlclZhbHVlLgogIC8vIC0gcmVuZGVyVmFsdWUgKHJlcXVpcmVkKSAtIEEgZnVuY3Rpb24oZWwsIGRhdGEsIGluaXRWYWx1ZSkgdGhhdCB3aWxsIGJlCiAgLy8gICBjYWxsZWQgd2l0aCBkYXRhLiBTdGF0aWMgY29udGV4dHMgd2lsbCBjYXVzZSB0aGlzIHRvIGJlIGNhbGxlZCBvbmNlIHBlcgogIC8vICAgZWxlbWVudDsgU2hpbnkgYXBwcyB3aWxsIGNhdXNlIHRoaXMgdG8gYmUgY2FsbGVkIG11bHRpcGxlIHRpbWVzIHBlcgogIC8vICAgZWxlbWVudCwgYXMgdGhlIGRhdGEgY2hhbmdlcy4KICB3aW5kb3cuSFRNTFdpZGdldHMud2lkZ2V0ID0gZnVuY3Rpb24oZGVmaW5pdGlvbikgewogICAgaWYgKCFkZWZpbml0aW9uLm5hbWUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaWRnZXQgbXVzdCBoYXZlIGEgbmFtZSIpOwogICAgfQogICAgaWYgKCFkZWZpbml0aW9uLnR5cGUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaWRnZXQgbXVzdCBoYXZlIGEgdHlwZSIpOwogICAgfQogICAgLy8gQ3VycmVudGx5IHdlIG9ubHkgc3VwcG9ydCBvdXRwdXQgd2lkZ2V0cwogICAgaWYgKGRlZmluaXRpb24udHlwZSAhPT0gIm91dHB1dCIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbnJlY29nbml6ZWQgd2lkZ2V0IHR5cGUgJyIgKyBkZWZpbml0aW9uLnR5cGUgKyAiJyIpOwogICAgfQogICAgLy8gVE9ETzogVmVyaWZ5IHRoYXQgLm5hbWUgaXMgYSB2YWxpZCBDU1MgY2xhc3NuYW1lCgogICAgLy8gU3VwcG9ydCBuZXctc3R5bGUgaW5zdGFuY2UtYm91bmQgZGVmaW5pdGlvbnMuIE9sZC1zdHlsZSBjbGFzcy1ib3VuZAogICAgLy8gZGVmaW5pdGlvbnMgaGF2ZSBvbmUgd2lkZ2V0ICJvYmplY3QiIHBlciB3aWRnZXQgcGVyIHR5cGUvY2xhc3Mgb2YKICAgIC8vIHdpZGdldDsgdGhlIHJlbmRlclZhbHVlIGFuZCByZXNpemUgbWV0aG9kcyBvbiBzdWNoIHdpZGdldCBvYmplY3RzCiAgICAvLyB0YWtlIGVsIGFuZCBpbnN0YW5jZSBhcmd1bWVudHMsIGJlY2F1c2UgdGhlIHdpZGdldCBvYmplY3QgY2FuJ3QKICAgIC8vIHN0b3JlIHRoZW0uIE5ldy1zdHlsZSBpbnN0YW5jZS1ib3VuZCBkZWZpbml0aW9ucyBoYXZlIG9uZSB3aWRnZXQKICAgIC8vIG9iamVjdCBwZXIgd2lkZ2V0IGluc3RhbmNlOyB0aGUgZGVmaW5pdGlvbiB0aGF0J3MgcGFzc2VkIGluIGRvZXNuJ3QKICAgIC8vIHByb3ZpZGUgcmVuZGVyVmFsdWUgb3IgcmVzaXplIG1ldGhvZHMgYXQgYWxsLCBqdXN0IHRoZSBzaW5nbGUgbWV0aG9kCiAgICAvLyAgIGZhY3RvcnkoZWwsIHdpZHRoLCBoZWlnaHQpCiAgICAvLyB3aGljaCByZXR1cm5zIGFuIG9iamVjdCB0aGF0IGhhcyByZW5kZXJWYWx1ZSh4KSBhbmQgcmVzaXplKHcsIGgpLgogICAgLy8gVGhpcyBlbmFibGVzIGEgZmFyIG1vcmUgbmF0dXJhbCBwcm9ncmFtbWluZyBzdHlsZSBmb3IgdGhlIHdpZGdldAogICAgLy8gYXV0aG9yLCB3aG8gY2FuIHN0b3JlIHBlci1pbnN0YW5jZSBzdGF0ZSB1c2luZyBlaXRoZXIgT08tc3R5bGUKICAgIC8vIGluc3RhbmNlIGZpZWxkcyBvciBmdW5jdGlvbmFsLXN0eWxlIGNsb3N1cmUgdmFyaWFibGVzIChJIGd1ZXNzIHRoaXMKICAgIC8vIGlzIGluIGNvbnRyYXN0IHRvIHdoYXQgY2FuIG9ubHkgYmUgY2FsbGVkIEMtc3R5bGUgcHNldWRvLU9PIHdoaWNoIGlzCiAgICAvLyB3aGF0IHdlIHJlcXVpcmVkIGJlZm9yZSkuCiAgICBpZiAoZGVmaW5pdGlvbi5mYWN0b3J5KSB7CiAgICAgIGRlZmluaXRpb24gPSBjcmVhdGVMZWdhY3lEZWZpbml0aW9uQWRhcHRlcihkZWZpbml0aW9uKTsKICAgIH0KCiAgICBpZiAoIWRlZmluaXRpb24ucmVuZGVyVmFsdWUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaWRnZXQgbXVzdCBoYXZlIGEgcmVuZGVyVmFsdWUgZnVuY3Rpb24iKTsKICAgIH0KCiAgICAvLyBGb3Igc3RhdGljIHJlbmRlcmluZyAobm9uLVNoaW55KSwgdXNlIGEgc2ltcGxlIHdpZGdldCByZWdpc3RyYXRpb24KICAgIC8vIHNjaGVtZS4gV2UgYWxzbyB1c2UgdGhpcyBzY2hlbWUgZm9yIFNoaW55IGFwcHMvZG9jdW1lbnRzIHRoYXQgYWxzbwogICAgLy8gY29udGFpbiBzdGF0aWMgd2lkZ2V0cy4KICAgIHdpbmRvdy5IVE1MV2lkZ2V0cy53aWRnZXRzID0gd2luZG93LkhUTUxXaWRnZXRzLndpZGdldHMgfHwgW107CiAgICAvLyBNZXJnZSBkZWZhdWx0cyBpbnRvIHRoZSBkZWZpbml0aW9uOyBkb24ndCBtdXRhdGUgdGhlIG9yaWdpbmFsIGRlZmluaXRpb24uCiAgICB2YXIgc3RhdGljQmluZGluZyA9IGV4dGVuZCh7fSwgZGVmYXVsdHMsIGRlZmluaXRpb24pOwogICAgb3ZlcnJpZGVNZXRob2Qoc3RhdGljQmluZGluZywgImZpbmQiLCBmdW5jdGlvbihzdXBlcmZ1bmMpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlKSB7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBzdXBlcmZ1bmMoc2NvcGUpOwogICAgICAgIC8vIEZpbHRlciBvdXQgU2hpbnkgb3V0cHV0cywgd2Ugb25seSB3YW50IHRoZSBzdGF0aWMga2luZAogICAgICAgIHJldHVybiBmaWx0ZXJCeUNsYXNzKHJlc3VsdHMsICJodG1sLXdpZGdldC1vdXRwdXQiLCBmYWxzZSk7CiAgICAgIH07CiAgICB9KTsKICAgIHdpbmRvdy5IVE1MV2lkZ2V0cy53aWRnZXRzLnB1c2goc3RhdGljQmluZGluZyk7CgogICAgaWYgKHNoaW55TW9kZSkgewogICAgICAvLyBTaGlueSBpcyBydW5uaW5nLiBSZWdpc3RlciB0aGUgZGVmaW5pdGlvbiB3aXRoIGFuIG91dHB1dCBiaW5kaW5nLgogICAgICAvLyBUaGUgZGVmaW5pdGlvbiBpdHNlbGYgd2lsbCBub3QgYmUgdGhlIG91dHB1dCBiaW5kaW5nLCBpbnN0ZWFkCiAgICAgIC8vIHdlIHdpbGwgbWFrZSBhbiBvdXRwdXQgYmluZGluZyBvYmplY3QgdGhhdCBkZWxlZ2F0ZXMgdG8gdGhlCiAgICAgIC8vIGRlZmluaXRpb24uIFRoaXMgaXMgYmVjYXVzZSB3ZSBmb29saXNobHkgdXNlZCB0aGUgc2FtZSBtZXRob2QKICAgICAgLy8gbmFtZSAocmVuZGVyVmFsdWUpIGZvciBodG1sd2lkZ2V0cyBkZWZpbml0aW9uIGFuZCBTaGlueSBiaW5kaW5ncwogICAgICAvLyBidXQgdGhleSBhY3R1YWxseSBoYXZlIHF1aXRlIGRpZmZlcmVudCBzZW1hbnRpY3MgKHRoZSBTaGlueQogICAgICAvLyBiaW5kaW5ncyByZWNlaXZlIGRhdGEgdGhhdCBpbmNsdWRlcyBsb3RzIG9mIG1ldGFkYXRhIHRoYXQgaXQKICAgICAgLy8gc3RyaXBzIG9mZiBiZWZvcmUgY2FsbGluZyBodG1sd2lkZ2V0cyByZW5kZXJWYWx1ZSkuIFdlIGNhbid0CiAgICAgIC8vIGp1c3QgaWdub3JlIHRoZSBkaWZmZXJlbmNlIGJlY2F1c2UgaW4gc29tZSB3aWRnZXRzIGl0J3MgaGVscGZ1bAogICAgICAvLyB0byBjYWxsIHRoaXMucmVuZGVyVmFsdWUoKSBmcm9tIGluc2lkZSBvZiByZXNpemUoKSwgYW5kIGlmCiAgICAgIC8vIHdlJ3JlIG5vdCBkZWxlZ2F0aW5nLCB0aGVuIHRoYXQgY2FsbCB3aWxsIGdvIHRvIHRoZSBTaGlueQogICAgICAvLyB2ZXJzaW9uIGluc3RlYWQgb2YgdGhlIGh0bWx3aWRnZXRzIHZlcnNpb24uCgogICAgICAvLyBNZXJnZSBkZWZhdWx0cyB3aXRoIGRlZmluaXRpb24sIHdpdGhvdXQgbXV0YXRpbmcgZWl0aGVyLgogICAgICB2YXIgYmluZGluZ0RlZiA9IGV4dGVuZCh7fSwgZGVmYXVsdHMsIGRlZmluaXRpb24pOwoKICAgICAgLy8gVGhpcyBvYmplY3Qgd2lsbCBiZSBvdXIgYWN0dWFsIFNoaW55IGJpbmRpbmcuCiAgICAgIHZhciBzaGlueUJpbmRpbmcgPSBuZXcgU2hpbnkuT3V0cHV0QmluZGluZygpOwoKICAgICAgLy8gV2l0aCBhIGZldyBleGNlcHRpb25zLCB3ZSdsbCB3YW50IHRvIHNpbXBseSB1c2UgdGhlIGJpbmRpbmdEZWYncwogICAgICAvLyB2ZXJzaW9uIG9mIG1ldGhvZHMgaWYgdGhleSBhcmUgYXZhaWxhYmxlLCBvdGhlcndpc2UgZmFsbCBiYWNrIHRvCiAgICAgIC8vIFNoaW55J3MgZGVmYXVsdHMuIE5PVEU6IElmIFNoaW55J3Mgb3V0cHV0IGJpbmRpbmdzIGdhaW4gYWRkaXRpb25hbAogICAgICAvLyBtZXRob2RzIGluIHRoZSBmdXR1cmUsIGFuZCB3ZSB3YW50IHRoZW0gdG8gYmUgb3ZlcnJpZGVhYmxlIGJ5CiAgICAgIC8vIEhUTUxXaWRnZXQgYmluZGluZyBkZWZpbml0aW9ucywgdGhlbiB3ZSdsbCBuZWVkIHRvIGFkZCB0aGVtIHRvIHRoaXMKICAgICAgLy8gbGlzdC4KICAgICAgZGVsZWdhdGVNZXRob2Qoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLCAiZ2V0SWQiKTsKICAgICAgZGVsZWdhdGVNZXRob2Qoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLCAib25WYWx1ZUNoYW5nZSIpOwogICAgICBkZWxlZ2F0ZU1ldGhvZChzaGlueUJpbmRpbmcsIGJpbmRpbmdEZWYsICJvblZhbHVlRXJyb3IiKTsKICAgICAgZGVsZWdhdGVNZXRob2Qoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLCAicmVuZGVyRXJyb3IiKTsKICAgICAgZGVsZWdhdGVNZXRob2Qoc2hpbnlCaW5kaW5nLCBiaW5kaW5nRGVmLCAiY2xlYXJFcnJvciIpOwogICAgICBkZWxlZ2F0ZU1ldGhvZChzaGlueUJpbmRpbmcsIGJpbmRpbmdEZWYsICJzaG93UHJvZ3Jlc3MiKTsKCiAgICAgIC8vIFRoZSBmaW5kLCByZW5kZXJWYWx1ZSwgYW5kIHJlc2l6ZSBhcmUgaGFuZGxlZCBkaWZmZXJlbnRseSwgYmVjYXVzZSB3ZQogICAgICAvLyB3YW50IHRvIGFjdHVhbGx5IGRlY29yYXRlIHRoZSBiZWhhdmlvciBvZiB0aGUgYmluZGluZ0RlZiBtZXRob2RzLgoKICAgICAgc2hpbnlCaW5kaW5nLmZpbmQgPSBmdW5jdGlvbihzY29wZSkgewogICAgICAgIHZhciByZXN1bHRzID0gYmluZGluZ0RlZi5maW5kKHNjb3BlKTsKCiAgICAgICAgLy8gT25seSByZXR1cm4gZWxlbWVudHMgdGhhdCBhcmUgU2hpbnkgb3V0cHV0cywgbm90IHN0YXRpYyBvbmVzCiAgICAgICAgdmFyIGR5bmFtaWNSZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIoIi5odG1sLXdpZGdldC1vdXRwdXQiKTsKCiAgICAgICAgLy8gSXQncyBwb3NzaWJsZSB0aGF0IHdoYXRldmVyIGNhdXNlZCBTaGlueSB0byB0aGluayB0aGVyZSBtaWdodCBiZQogICAgICAgIC8vIG5ldyBkeW5hbWljIG91dHB1dHMsIGFsc28gY2F1c2VkIHRoZXJlIHRvIGJlIG5ldyBzdGF0aWMgb3V0cHV0cy4KICAgICAgICAvLyBTaW5jZSB0aGVyZSBtaWdodCBiZSBsb3RzIG9mIGRpZmZlcmVudCBodG1sd2lkZ2V0cyBiaW5kaW5ncywgd2UKICAgICAgICAvLyBzY2hlZHVsZSBleGVjdXRpb24gZm9yIGxhdGVyLS1ubyBuZWVkIHRvIHN0YXRpY1JlbmRlciBtdWx0aXBsZQogICAgICAgIC8vIHRpbWVzLgogICAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCAhPT0gZHluYW1pY1Jlc3VsdHMubGVuZ3RoKQogICAgICAgICAgc2NoZWR1bGVTdGF0aWNSZW5kZXIoKTsKCiAgICAgICAgcmV0dXJuIGR5bmFtaWNSZXN1bHRzOwogICAgICB9OwoKICAgICAgLy8gV3JhcCByZW5kZXJWYWx1ZSB0byBoYW5kbGUgaW5pdGlhbGl6YXRpb24sIHdoaWNoIHVuZm9ydHVuYXRlbHkgaXNuJ3QKICAgICAgLy8gc3VwcG9ydGVkIG5hdGl2ZWx5IGJ5IFNoaW55IGF0IHRoZSB0aW1lIG9mIHRoaXMgd3JpdGluZy4KCiAgICAgIHNoaW55QmluZGluZy5yZW5kZXJWYWx1ZSA9IGZ1bmN0aW9uKGVsLCBkYXRhKSB7CiAgICAgICAgU2hpbnkucmVuZGVyRGVwZW5kZW5jaWVzKGRhdGEuZGVwcyk7CiAgICAgICAgLy8gUmVzb2x2ZSBzdHJpbmdzIG1hcmtlZCBhcyBqYXZhc2NyaXB0IGxpdGVyYWxzIHRvIG9iamVjdHMKICAgICAgICBpZiAoIShkYXRhLmV2YWxzIGluc3RhbmNlb2YgQXJyYXkpKSBkYXRhLmV2YWxzID0gW2RhdGEuZXZhbHNdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBkYXRhLmV2YWxzICYmIGkgPCBkYXRhLmV2YWxzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB3aW5kb3cuSFRNTFdpZGdldHMuZXZhbHVhdGVTdHJpbmdNZW1iZXIoZGF0YS54LCBkYXRhLmV2YWxzW2ldKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFiaW5kaW5nRGVmLnJlbmRlck9uTnVsbFZhbHVlKSB7CiAgICAgICAgICBpZiAoZGF0YS54ID09PSBudWxsKSB7CiAgICAgICAgICAgIGVsLnN0eWxlLnZpc2liaWxpdHkgPSAiaGlkZGVuIjsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWwuc3R5bGUudmlzaWJpbGl0eSA9ICJpbmhlcml0IjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFlbGVtZW50RGF0YShlbCwgImluaXRpYWxpemVkIikpIHsKICAgICAgICAgIGluaXRTaXppbmcoZWwpOwoKICAgICAgICAgIGVsZW1lbnREYXRhKGVsLCAiaW5pdGlhbGl6ZWQiLCB0cnVlKTsKICAgICAgICAgIGlmIChiaW5kaW5nRGVmLmluaXRpYWxpemUpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGJpbmRpbmdEZWYuaW5pdGlhbGl6ZShlbCwgZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgZWwub2Zmc2V0SGVpZ2h0KTsKICAgICAgICAgICAgZWxlbWVudERhdGEoZWwsICJpbml0X3Jlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGJpbmRpbmdEZWYucmVuZGVyVmFsdWUoZWwsIGRhdGEueCwgZWxlbWVudERhdGEoZWwsICJpbml0X3Jlc3VsdCIpKTsKICAgICAgICBldmFsQW5kUnVuKGRhdGEuanNIb29rcy5yZW5kZXIsIGVsZW1lbnREYXRhKGVsLCAiaW5pdF9yZXN1bHQiKSwgW2VsLCBkYXRhLnhdKTsKICAgICAgfTsKCiAgICAgIC8vIE9ubHkgb3ZlcnJpZGUgcmVzaXplIGlmIGJpbmRpbmdEZWYgaW1wbGVtZW50cyBpdAogICAgICBpZiAoYmluZGluZ0RlZi5yZXNpemUpIHsKICAgICAgICBzaGlueUJpbmRpbmcucmVzaXplID0gZnVuY3Rpb24oZWwsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgIC8vIFNoaW55IGNhbiBjYWxsIHJlc2l6ZSBiZWZvcmUgaW5pdGlhbGl6ZS9yZW5kZXJWYWx1ZSBoYXZlIGJlZW4KICAgICAgICAgIC8vIGNhbGxlZCwgd2hpY2ggZG9lc24ndCBtYWtlIHNlbnNlIGZvciB3aWRnZXRzLgogICAgICAgICAgaWYgKGVsZW1lbnREYXRhKGVsLCAiaW5pdGlhbGl6ZWQiKSkgewogICAgICAgICAgICBiaW5kaW5nRGVmLnJlc2l6ZShlbCwgd2lkdGgsIGhlaWdodCwgZWxlbWVudERhdGEoZWwsICJpbml0X3Jlc3VsdCIpKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CgogICAgICBTaGlueS5vdXRwdXRCaW5kaW5ncy5yZWdpc3RlcihzaGlueUJpbmRpbmcsIGJpbmRpbmdEZWYubmFtZSk7CiAgICB9CiAgfTsKCiAgdmFyIHNjaGVkdWxlU3RhdGljUmVuZGVyVGltZXJJZCA9IG51bGw7CiAgZnVuY3Rpb24gc2NoZWR1bGVTdGF0aWNSZW5kZXIoKSB7CiAgICBpZiAoIXNjaGVkdWxlU3RhdGljUmVuZGVyVGltZXJJZCkgewogICAgICBzY2hlZHVsZVN0YXRpY1JlbmRlclRpbWVySWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHNjaGVkdWxlU3RhdGljUmVuZGVyVGltZXJJZCA9IG51bGw7CiAgICAgICAgd2luZG93LkhUTUxXaWRnZXRzLnN0YXRpY1JlbmRlcigpOwogICAgICB9LCAxKTsKICAgIH0KICB9CgogIC8vIFJlbmRlciBzdGF0aWMgd2lkZ2V0cyBhZnRlciB0aGUgZG9jdW1lbnQgZmluaXNoZXMgbG9hZGluZwogIC8vIFN0YXRpY2FsbHkgcmVuZGVyIGFsbCBlbGVtZW50cyB0aGF0IGFyZSBvZiB0aGlzIHdpZGdldCdzIGNsYXNzCiAgd2luZG93LkhUTUxXaWRnZXRzLnN0YXRpY1JlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGJpbmRpbmdzID0gd2luZG93LkhUTUxXaWRnZXRzLndpZGdldHMgfHwgW107CiAgICBmb3JFYWNoKGJpbmRpbmdzLCBmdW5jdGlvbihiaW5kaW5nKSB7CiAgICAgIHZhciBtYXRjaGVzID0gYmluZGluZy5maW5kKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCk7CiAgICAgIGZvckVhY2gobWF0Y2hlcywgZnVuY3Rpb24oZWwpIHsKICAgICAgICB2YXIgc2l6ZU9iaiA9IGluaXRTaXppbmcoZWwsIGJpbmRpbmcpOwoKICAgICAgICBpZiAoaGFzQ2xhc3MoZWwsICJodG1sLXdpZGdldC1zdGF0aWMtYm91bmQiKSkKICAgICAgICAgIHJldHVybjsKICAgICAgICBlbC5jbGFzc05hbWUgPSBlbC5jbGFzc05hbWUgKyAiIGh0bWwtd2lkZ2V0LXN0YXRpYy1ib3VuZCI7CgogICAgICAgIHZhciBpbml0UmVzdWx0OwogICAgICAgIGlmIChiaW5kaW5nLmluaXRpYWxpemUpIHsKICAgICAgICAgIGluaXRSZXN1bHQgPSBiaW5kaW5nLmluaXRpYWxpemUoZWwsCiAgICAgICAgICAgIHNpemVPYmogPyBzaXplT2JqLmdldFdpZHRoKCkgOiBlbC5vZmZzZXRXaWR0aCwKICAgICAgICAgICAgc2l6ZU9iaiA/IHNpemVPYmouZ2V0SGVpZ2h0KCkgOiBlbC5vZmZzZXRIZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgICBlbGVtZW50RGF0YShlbCwgImluaXRfcmVzdWx0IiwgaW5pdFJlc3VsdCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoYmluZGluZy5yZXNpemUpIHsKICAgICAgICAgIHZhciBsYXN0U2l6ZSA9IHsKICAgICAgICAgICAgdzogc2l6ZU9iaiA/IHNpemVPYmouZ2V0V2lkdGgoKSA6IGVsLm9mZnNldFdpZHRoLAogICAgICAgICAgICBoOiBzaXplT2JqID8gc2l6ZU9iai5nZXRIZWlnaHQoKSA6IGVsLm9mZnNldEhlaWdodAogICAgICAgICAgfTsKICAgICAgICAgIHZhciByZXNpemVIYW5kbGVyID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgc2l6ZSA9IHsKICAgICAgICAgICAgICB3OiBzaXplT2JqID8gc2l6ZU9iai5nZXRXaWR0aCgpIDogZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgaDogc2l6ZU9iaiA/IHNpemVPYmouZ2V0SGVpZ2h0KCkgOiBlbC5vZmZzZXRIZWlnaHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHNpemUudyA9PT0gMCAmJiBzaXplLmggPT09IDApCiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBpZiAoc2l6ZS53ID09PSBsYXN0U2l6ZS53ICYmIHNpemUuaCA9PT0gbGFzdFNpemUuaCkKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGxhc3RTaXplID0gc2l6ZTsKICAgICAgICAgICAgYmluZGluZy5yZXNpemUoZWwsIHNpemUudywgc2l6ZS5oLCBpbml0UmVzdWx0KTsKICAgICAgICAgIH07CgogICAgICAgICAgb24od2luZG93LCAicmVzaXplIiwgcmVzaXplSGFuZGxlcik7CgogICAgICAgICAgLy8gVGhpcyBpcyBuZWVkZWQgZm9yIGNhc2VzIHdoZXJlIHdlJ3JlIHJ1bm5pbmcgaW4gYSBTaGlueQogICAgICAgICAgLy8gYXBwLCBidXQgdGhlIHdpZGdldCBpdHNlbGYgaXMgbm90IGEgU2hpbnkgb3V0cHV0LCBidXQKICAgICAgICAgIC8vIHJhdGhlciBhIHNpbXBsZSBzdGF0aWMgd2lkZ2V0LiBPbmUgZXhhbXBsZSBvZiB0aGlzIGlzCiAgICAgICAgICAvLyBhbiBybWFya2Rvd24gZG9jdW1lbnQgdGhhdCBoYXMgcnVudGltZTpzaGlueSBhbmQgd2lkZ2V0CiAgICAgICAgICAvLyB0aGF0IGlzbid0IGluIGEgcmVuZGVyIGZ1bmN0aW9uLiBTaGlueSBvbmx5IGtub3dzIHRvCiAgICAgICAgICAvLyBjYWxsIHJlc2l6ZSBoYW5kbGVycyBmb3IgU2hpbnkgb3V0cHV0cywgbm90IGZvciBzdGF0aWMKICAgICAgICAgIC8vIHdpZGdldHMsIHNvIHdlIGRvIGl0IG91cnNlbHZlcy4KICAgICAgICAgIGlmICh3aW5kb3cualF1ZXJ5KSB7CiAgICAgICAgICAgIHdpbmRvdy5qUXVlcnkoZG9jdW1lbnQpLm9uKAogICAgICAgICAgICAgICJzaG93bi5odG1sd2lkZ2V0cyBzaG93bi5icy50YWIuaHRtbHdpZGdldHMgc2hvd24uYnMuY29sbGFwc2UuaHRtbHdpZGdldHMiLAogICAgICAgICAgICAgIHJlc2l6ZUhhbmRsZXIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgd2luZG93LmpRdWVyeShkb2N1bWVudCkub24oCiAgICAgICAgICAgICAgImhpZGRlbi5odG1sd2lkZ2V0cyBoaWRkZW4uYnMudGFiLmh0bWx3aWRnZXRzIGhpZGRlbi5icy5jb2xsYXBzZS5odG1sd2lkZ2V0cyIsCiAgICAgICAgICAgICAgcmVzaXplSGFuZGxlcgogICAgICAgICAgICApOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFRoaXMgaXMgbmVlZGVkIGZvciB0aGUgc3BlY2lmaWMgY2FzZSBvZiBpb3NsaWRlcywgd2hpY2gKICAgICAgICAgIC8vIGZsaXBzIHNsaWRlcyBiZXR3ZWVuIGRpc3BsYXk6bm9uZSBhbmQgZGlzcGxheTpibG9jay4KICAgICAgICAgIC8vIElkZWFsbHkgd2Ugd291bGQgbm90IGhhdmUgdG8gaGF2ZSBpb3NsaWRlLXNwZWNpZmljIGNvZGUKICAgICAgICAgIC8vIGhlcmUsIGJ1dCByYXRoZXIgaGF2ZSBpb3NsaWRlcyByYWlzZSBhIGdlbmVyaWMgZXZlbnQsCiAgICAgICAgICAvLyBidXQgdGhlIHJtYXJrZG93biBwYWNrYWdlIGp1c3Qgd2VudCB0byBDUkFOIHNvIHRoZQogICAgICAgICAgLy8gd2luZG93IHRvIGdldHRpbmcgdGhhdCBmaXhlZCBtYXkgYmUgbG9uZy4KICAgICAgICAgIGlmICh3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAvLyBJdCdzIE9LIHRvIGxpbWl0IHRoaXMgdG8gd2luZG93LmFkZEV2ZW50TGlzdGVuZXIKICAgICAgICAgICAgLy8gYnJvd3NlcnMgYmVjYXVzZSBpb3NsaWRlcyBpdHNlbGYgb25seSBzdXBwb3J0cwogICAgICAgICAgICAvLyBzdWNoIGJyb3dzZXJzLgogICAgICAgICAgICBvbihkb2N1bWVudCwgInNsaWRlZW50ZXIiLCByZXNpemVIYW5kbGVyKTsKICAgICAgICAgICAgb24oZG9jdW1lbnQsICJzbGlkZWxlYXZlIiwgcmVzaXplSGFuZGxlcik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgc2NyaXB0RGF0YSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoInNjcmlwdFtkYXRhLWZvcj0nIiArIGVsLmlkICsgIiddW3R5cGU9J2FwcGxpY2F0aW9uL2pzb24nXSIpOwogICAgICAgIGlmIChzY3JpcHREYXRhKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IEpTT04ucGFyc2Uoc2NyaXB0RGF0YS50ZXh0Q29udGVudCB8fCBzY3JpcHREYXRhLnRleHQpOwogICAgICAgICAgLy8gUmVzb2x2ZSBzdHJpbmdzIG1hcmtlZCBhcyBqYXZhc2NyaXB0IGxpdGVyYWxzIHRvIG9iamVjdHMKICAgICAgICAgIGlmICghKGRhdGEuZXZhbHMgaW5zdGFuY2VvZiBBcnJheSkpIGRhdGEuZXZhbHMgPSBbZGF0YS5ldmFsc107CiAgICAgICAgICBmb3IgKHZhciBrID0gMDsgZGF0YS5ldmFscyAmJiBrIDwgZGF0YS5ldmFscy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICB3aW5kb3cuSFRNTFdpZGdldHMuZXZhbHVhdGVTdHJpbmdNZW1iZXIoZGF0YS54LCBkYXRhLmV2YWxzW2tdKTsKICAgICAgICAgIH0KICAgICAgICAgIGJpbmRpbmcucmVuZGVyVmFsdWUoZWwsIGRhdGEueCwgaW5pdFJlc3VsdCk7CiAgICAgICAgICBldmFsQW5kUnVuKGRhdGEuanNIb29rcy5yZW5kZXIsIGluaXRSZXN1bHQsIFtlbCwgZGF0YS54XSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwoKICAgIGludm9rZVBvc3RSZW5kZXJIYW5kbGVycygpOwogIH0KCgogIGZ1bmN0aW9uIGhhc19qUXVlcnkzKCkgewogICAgaWYgKCF3aW5kb3cualF1ZXJ5KSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHZhciAkdmVyc2lvbiA9IHdpbmRvdy5qUXVlcnkuZm4uanF1ZXJ5OwogICAgdmFyICRtYWpvcl92ZXJzaW9uID0gcGFyc2VJbnQoJHZlcnNpb24uc3BsaXQoIi4iKVswXSk7CiAgICByZXR1cm4gJG1ham9yX3ZlcnNpb24gPj0gMzsKICB9CgogIC8qCiAgLyBTaGlueSAxLjQgYnVtcGVkIGpRdWVyeSBmcm9tIDEueCB0byAzLnggd2hpY2ggbWVhbnMgalF1ZXJ5J3MKICAvIG9uLXJlYWR5IGhhbmRsZXIgKGkuZS4sICQoZm4pKSBpcyBub3cgYXN5bmNyb25vdXMgKGkuZS4sIGl0IG5vdwogIC8gcmVhbGx5IG1lYW5zICQoc2V0VGltZW91dChmbikpLgogIC8gaHR0cHM6Ly9qcXVlcnkuY29tL3VwZ3JhZGUtZ3VpZGUvMy4wLyNicmVha2luZy1jaGFuZ2UtZG9jdW1lbnQtcmVhZHktaGFuZGxlcnMtYXJlLW5vdy1hc3luY2hyb25vdXMKICAvCiAgLyBTaW5jZSBTaGlueSB1c2VzICQoKSB0byBzY2hlZHVsZSBpbml0U2hpbnksIHNoaW55Pj0xLjQgY2FsbHMgaW5pdFNoaW55CiAgLyBvbmUgdGljayBsYXRlciB0aGFuIGl0IGRpZCBiZWZvcmUsIHdoaWNoIG1lYW5zIHN0YXRpY1JlbmRlcigpIGlzCiAgLyBjYWxsZWQgcmVuZGVyVmFsdWUoKSBlYXJsaWVyIHRoYW4gKGFkdmFuY2VkKSB3aWRnZXQgYXV0aG9ycyBtaWdodCBiZSBleHBlY3RpbmcuCiAgLyBodHRwczovL2dpdGh1Yi5jb20vcnN0dWRpby9zaGlueS9pc3N1ZXMvMjYzMAogIC8KICAvIEZvciBhIGNvbmNyZXRlIGV4YW1wbGUsIGxlYWZsZXQgaGFzIHNvbWUgbWV0aG9kcyAoZS5nLiwgdXBkYXRlQm91bmRzKQogIC8gd2hpY2ggcmVmZXJlbmNlIFNoaW55IG1ldGhvZHMgcmVnaXN0ZXJlZCBpbiBpbml0U2hpbnkgKGUuZy4sIHNldElucHV0VmFsdWUpLgogIC8gU2luY2UgbGVhZmxldCBpcyBwcml2eSB0byB0aGlzIGxpZmUtY3ljbGUsIGl0IGtub3dzIHRvIHVzZSBzZXRUaW1lb3V0KCkgdG8KICAvIGRlbGF5IGV4ZWN1dGlvbiBvZiB0aG9zZSBtZXRob2RzICh1bnRpbCBTaGlueSBtZXRob2RzIGFyZSByZWFkeSkKICAvIGh0dHBzOi8vZ2l0aHViLmNvbS9yc3R1ZGlvL2xlYWZsZXQvYmxvYi8xOGVjOTgxL2phdmFzY3JpcHQvc3JjL2luZGV4LmpzI0wyNjYtTDI2OAogIC8KICAvIElkZWFsbHkgd2lkZ2V0IGF1dGhvcnMgd291bGRuJ3QgbmVlZCB0byB1c2UgdGhpcyBzZXRUaW1lb3V0KCkgaGFjayB0aGF0CiAgLyBsZWFmbGV0IHVzZXMgdG8gY2FsbCBTaGlueSBtZXRob2RzIG9uIGEgc3RhdGljUmVuZGVyKCkuIEluIHRoZSBsb25nIHJ1biwKICAvIHRoZSBsb2dpYyBpbml0U2hpbnkgc2hvdWxkIGJlIGJyb2tlbiB1cCBzbyB0aGF0IG1ldGhvZCByZWdpc3RyYXRpb24gaGFwcGVucwogIC8gcmlnaHQgYXdheSwgYnV0IGJpbmRpbmcgaGFwcGVucyBsYXRlci4KICAqLwogIGZ1bmN0aW9uIG1heWJlU3RhdGljUmVuZGVyTGF0ZXIoKSB7CiAgICBpZiAoc2hpbnlNb2RlICYmIGhhc19qUXVlcnkzKCkpIHsKICAgICAgd2luZG93LmpRdWVyeSh3aW5kb3cuSFRNTFdpZGdldHMuc3RhdGljUmVuZGVyKTsKICAgIH0gZWxzZSB7CiAgICAgIHdpbmRvdy5IVE1MV2lkZ2V0cy5zdGF0aWNSZW5kZXIoKTsKICAgIH0KICB9CgogIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgZnVuY3Rpb24oKSB7CiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBhcmd1bWVudHMuY2FsbGVlLCBmYWxzZSk7CiAgICAgIG1heWJlU3RhdGljUmVuZGVyTGF0ZXIoKTsKICAgIH0sIGZhbHNlKTsKICB9IGVsc2UgaWYgKGRvY3VtZW50LmF0dGFjaEV2ZW50KSB7CiAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSB7CiAgICAgICAgZG9jdW1lbnQuZGV0YWNoRXZlbnQoIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIGFyZ3VtZW50cy5jYWxsZWUpOwogICAgICAgIG1heWJlU3RhdGljUmVuZGVyTGF0ZXIoKTsKICAgICAgfQogICAgfSk7CiAgfQoKCiAgd2luZG93LkhUTUxXaWRnZXRzLmdldEF0dGFjaG1lbnRVcmwgPSBmdW5jdGlvbihkZXBuYW1lLCBrZXkpIHsKICAgIC8vIElmIG5vIGtleSwgZGVmYXVsdCB0byB0aGUgZmlyc3QgaXRlbQogICAgaWYgKHR5cGVvZihrZXkpID09PSAidW5kZWZpbmVkIikKICAgICAga2V5ID0gMTsKCiAgICB2YXIgbGluayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGRlcG5hbWUgKyAiLSIgKyBrZXkgKyAiLWF0dGFjaG1lbnQiKTsKICAgIGlmICghbGluaykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkF0dGFjaG1lbnQgIiArIGRlcG5hbWUgKyAiLyIgKyBrZXkgKyAiIG5vdCBmb3VuZCBpbiBkb2N1bWVudCIpOwogICAgfQogICAgcmV0dXJuIGxpbmsuZ2V0QXR0cmlidXRlKCJocmVmIik7CiAgfTsKCiAgd2luZG93LkhUTUxXaWRnZXRzLmRhdGFmcmFtZVRvRDMgPSBmdW5jdGlvbihkZikgewogICAgdmFyIG5hbWVzID0gW107CiAgICB2YXIgbGVuZ3RoOwogICAgZm9yICh2YXIgbmFtZSBpbiBkZikgewogICAgICAgIGlmIChkZi5oYXNPd25Qcm9wZXJ0eShuYW1lKSkKICAgICAgICAgICAgbmFtZXMucHVzaChuYW1lKTsKICAgICAgICBpZiAodHlwZW9mKGRmW25hbWVdKSAhPT0gIm9iamVjdCIgfHwgdHlwZW9mKGRmW25hbWVdLmxlbmd0aCkgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQWxsIGZpZWxkcyBtdXN0IGJlIGFycmF5cyIpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mKGxlbmd0aCkgIT09ICJ1bmRlZmluZWQiICYmIGxlbmd0aCAhPT0gZGZbbmFtZV0ubGVuZ3RoKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQWxsIGZpZWxkcyBtdXN0IGJlIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGgiKTsKICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gZGZbbmFtZV0ubGVuZ3RoOwogICAgfQogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIHZhciBpdGVtOwogICAgZm9yICh2YXIgcm93ID0gMDsgcm93IDwgbGVuZ3RoOyByb3crKykgewogICAgICAgIGl0ZW0gPSB7fTsKICAgICAgICBmb3IgKHZhciBjb2wgPSAwOyBjb2wgPCBuYW1lcy5sZW5ndGg7IGNvbCsrKSB7CiAgICAgICAgICAgIGl0ZW1bbmFtZXNbY29sXV0gPSBkZltuYW1lc1tjb2xdXVtyb3ddOwogICAgICAgIH0KICAgICAgICByZXN1bHRzLnB1c2goaXRlbSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICB3aW5kb3cuSFRNTFdpZGdldHMudHJhbnNwb3NlQXJyYXkyRCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICAgIGlmIChhcnJheS5sZW5ndGggPT09IDApIHJldHVybiBhcnJheTsKICAgICAgdmFyIG5ld0FycmF5ID0gYXJyYXlbMF0ubWFwKGZ1bmN0aW9uKGNvbCwgaSkgewogICAgICAgICAgcmV0dXJuIGFycmF5Lm1hcChmdW5jdGlvbihyb3cpIHsKICAgICAgICAgICAgICByZXR1cm4gcm93W2ldCiAgICAgICAgICB9KQogICAgICB9KTsKICAgICAgcmV0dXJuIG5ld0FycmF5OwogIH07CiAgLy8gU3BsaXQgdmFsdWUgYXQgc3BsaXRDaGFyLCBidXQgYWxsb3cgc3BsaXRDaGFyIHRvIGJlIGVzY2FwZWQKICAvLyB1c2luZyBlc2NhcGVDaGFyLiBBbnkgb3RoZXIgY2hhcmFjdGVycyBlc2NhcGVkIGJ5IGVzY2FwZUNoYXIKICAvLyB3aWxsIGJlIGluY2x1ZGVkIGFzIHVzdWFsIChpbmNsdWRpbmcgZXNjYXBlQ2hhciBpdHNlbGYpLgogIGZ1bmN0aW9uIHNwbGl0V2l0aEVzY2FwZSh2YWx1ZSwgc3BsaXRDaGFyLCBlc2NhcGVDaGFyKSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIGVzY2FwZU1vZGUgPSBmYWxzZTsKICAgIHZhciBjdXJyZW50UmVzdWx0ID0gIiI7CiAgICBmb3IgKHZhciBwb3MgPSAwOyBwb3MgPCB2YWx1ZS5sZW5ndGg7IHBvcysrKSB7CiAgICAgIGlmICghZXNjYXBlTW9kZSkgewogICAgICAgIGlmICh2YWx1ZVtwb3NdID09PSBzcGxpdENoYXIpIHsKICAgICAgICAgIHJlc3VsdHMucHVzaChjdXJyZW50UmVzdWx0KTsKICAgICAgICAgIGN1cnJlbnRSZXN1bHQgPSAiIjsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlW3Bvc10gPT09IGVzY2FwZUNoYXIpIHsKICAgICAgICAgIGVzY2FwZU1vZGUgPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJyZW50UmVzdWx0ICs9IHZhbHVlW3Bvc107CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGN1cnJlbnRSZXN1bHQgKz0gdmFsdWVbcG9zXTsKICAgICAgICBlc2NhcGVNb2RlID0gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIGlmIChjdXJyZW50UmVzdWx0ICE9PSAiIikgewogICAgICByZXN1bHRzLnB1c2goY3VycmVudFJlc3VsdCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9CiAgLy8gRnVuY3Rpb24gYXV0aG9yZWQgYnkgWWlodWkvSkogQWxsYWlyZQogIHdpbmRvdy5IVE1MV2lkZ2V0cy5ldmFsdWF0ZVN0cmluZ01lbWJlciA9IGZ1bmN0aW9uKG8sIG1lbWJlcikgewogICAgdmFyIHBhcnRzID0gc3BsaXRXaXRoRXNjYXBlKG1lbWJlciwgJy4nLCAnXFwnKTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gcGFydHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBwYXJ0ID0gcGFydHNbaV07CiAgICAgIC8vIHBhcnQgbWF5IGJlIGEgY2hhcmFjdGVyIG9yICdudW1lcmljJyBtZW1iZXIgbmFtZQogICAgICBpZiAobyAhPT0gbnVsbCAmJiB0eXBlb2YgbyA9PT0gIm9iamVjdCIgJiYgcGFydCBpbiBvKSB7CiAgICAgICAgaWYgKGkgPT0gKGwgLSAxKSkgeyAvLyBpZiB3ZSBhcmUgYXQgdGhlIGVuZCBvZiB0aGUgbGluZSB0aGVuIGV2YWx1bGF0ZQogICAgICAgICAgaWYgKHR5cGVvZiBvW3BhcnRdID09PSAic3RyaW5nIikKICAgICAgICAgICAgb1twYXJ0XSA9IHRyeUV2YWwob1twYXJ0XSk7CiAgICAgICAgfSBlbHNlIHsgLy8gb3RoZXJ3aXNlIGNvbnRpbnVlIHRvIG5leHQgZW1iZWRkZWQgb2JqZWN0CiAgICAgICAgICBvID0gb1twYXJ0XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBSZXRyaWV2ZSB0aGUgSFRNTFdpZGdldCBpbnN0YW5jZSAoaS5lLiB0aGUgcmV0dXJuIHZhbHVlIG9mIGFuCiAgLy8gSFRNTFdpZGdldCBiaW5kaW5nJ3MgaW5pdGlhbGl6ZSgpIG9yIGZhY3RvcnkoKSBmdW5jdGlvbikKICAvLyBhc3NvY2lhdGVkIHdpdGggYW4gZWxlbWVudCwgb3IgbnVsbCBpZiBub25lLgogIHdpbmRvdy5IVE1MV2lkZ2V0cy5nZXRJbnN0YW5jZSA9IGZ1bmN0aW9uKGVsKSB7CiAgICByZXR1cm4gZWxlbWVudERhdGEoZWwsICJpbml0X3Jlc3VsdCIpOwogIH07CgogIC8vIEZpbmRzIHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZSBzY29wZSB0aGF0IG1hdGNoZXMgdGhlIHNlbGVjdG9yLAogIC8vIGFuZCByZXR1cm5zIHRoZSBIVE1MV2lkZ2V0IGluc3RhbmNlIChpLmUuIHRoZSByZXR1cm4gdmFsdWUgb2YKICAvLyBhbiBIVE1MV2lkZ2V0IGJpbmRpbmcncyBpbml0aWFsaXplKCkgb3IgZmFjdG9yeSgpIGZ1bmN0aW9uKQogIC8vIGFzc29jaWF0ZWQgd2l0aCB0aGF0IGVsZW1lbnQsIGlmIGFueS4gSWYgbm8gZWxlbWVudCBtYXRjaGVzIHRoZQogIC8vIHNlbGVjdG9yLCBvciB0aGUgZmlyc3QgbWF0Y2hpbmcgZWxlbWVudCBoYXMgbm8gSFRNTFdpZGdldAogIC8vIGluc3RhbmNlIGFzc29jaWF0ZWQgd2l0aCBpdCwgdGhlbiBudWxsIGlzIHJldHVybmVkLgogIC8vCiAgLy8gVGhlIHNjb3BlIGFyZ3VtZW50IGlzIG9wdGlvbmFsLCBhbmQgZGVmYXVsdHMgdG8gd2luZG93LmRvY3VtZW50LgogIHdpbmRvdy5IVE1MV2lkZ2V0cy5maW5kID0gZnVuY3Rpb24oc2NvcGUsIHNlbGVjdG9yKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CiAgICAgIHNlbGVjdG9yID0gc2NvcGU7CiAgICAgIHNjb3BlID0gZG9jdW1lbnQ7CiAgICB9CgogICAgdmFyIGVsID0gc2NvcGUucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7CiAgICBpZiAoZWwgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gd2luZG93LkhUTUxXaWRnZXRzLmdldEluc3RhbmNlKGVsKTsKICAgIH0KICB9OwoKICAvLyBGaW5kcyBhbGwgZWxlbWVudHMgaW4gdGhlIHNjb3BlIHRoYXQgbWF0Y2ggdGhlIHNlbGVjdG9yLCBhbmQKICAvLyByZXR1cm5zIHRoZSBIVE1MV2lkZ2V0IGluc3RhbmNlcyAoaS5lLiB0aGUgcmV0dXJuIHZhbHVlcyBvZgogIC8vIGFuIEhUTUxXaWRnZXQgYmluZGluZydzIGluaXRpYWxpemUoKSBvciBmYWN0b3J5KCkgZnVuY3Rpb24pCiAgLy8gYXNzb2NpYXRlZCB3aXRoIHRoZSBlbGVtZW50cywgaW4gYW4gYXJyYXkuIElmIGVsZW1lbnRzIHRoYXQKICAvLyBtYXRjaCB0aGUgc2VsZWN0b3IgZG9uJ3QgaGF2ZSBhbiBhc3NvY2lhdGVkIEhUTUxXaWRnZXQKICAvLyBpbnN0YW5jZSwgdGhlIHJldHVybmVkIGFycmF5IHdpbGwgY29udGFpbiBudWxscy4KICAvLwogIC8vIFRoZSBzY29wZSBhcmd1bWVudCBpcyBvcHRpb25hbCwgYW5kIGRlZmF1bHRzIHRvIHdpbmRvdy5kb2N1bWVudC4KICB3aW5kb3cuSFRNTFdpZGdldHMuZmluZEFsbCA9IGZ1bmN0aW9uKHNjb3BlLCBzZWxlY3RvcikgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewogICAgICBzZWxlY3RvciA9IHNjb3BlOwogICAgICBzY29wZSA9IGRvY3VtZW50OwogICAgfQoKICAgIHZhciBub2RlcyA9IHNjb3BlLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpOwogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0cy5wdXNoKHdpbmRvdy5IVE1MV2lkZ2V0cy5nZXRJbnN0YW5jZShub2Rlc1tpXSkpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgdmFyIHBvc3RSZW5kZXJIYW5kbGVycyA9IFtdOwogIGZ1bmN0aW9uIGludm9rZVBvc3RSZW5kZXJIYW5kbGVycygpIHsKICAgIHdoaWxlIChwb3N0UmVuZGVySGFuZGxlcnMubGVuZ3RoKSB7CiAgICAgIHZhciBoYW5kbGVyID0gcG9zdFJlbmRlckhhbmRsZXJzLnNoaWZ0KCk7CiAgICAgIGlmIChoYW5kbGVyKSB7CiAgICAgICAgaGFuZGxlcigpOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBSZWdpc3RlciB0aGUgZ2l2ZW4gY2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUgaW52b2tlZCBhZnRlciB0aGUKICAvLyBuZXh0IHRpbWUgc3RhdGljIHdpZGdldHMgYXJlIHJlbmRlcmVkLgogIHdpbmRvdy5IVE1MV2lkZ2V0cy5hZGRQb3N0UmVuZGVySGFuZGxlciA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICBwb3N0UmVuZGVySGFuZGxlcnMucHVzaChjYWxsYmFjayk7CiAgfTsKCiAgLy8gVGFrZXMgYSBuZXctc3R5bGUgaW5zdGFuY2UtYm91bmQgZGVmaW5pdGlvbiwgYW5kIHJldHVybnMgYW4KICAvLyBvbGQtc3R5bGUgY2xhc3MtYm91bmQgZGVmaW5pdGlvbi4gVGhpcyBzYXZlcyB1cyBmcm9tIGhhdmluZwogIC8vIHRvIHJld3JpdGUgYWxsIHRoZSBsb2dpYyBpbiB0aGlzIGZpbGUgdG8gYWNjb21vZGF0ZSBib3RoCiAgLy8gdHlwZXMgb2YgZGVmaW5pdGlvbnMuCiAgZnVuY3Rpb24gY3JlYXRlTGVnYWN5RGVmaW5pdGlvbkFkYXB0ZXIoZGVmbikgewogICAgdmFyIHJlc3VsdCA9IHsKICAgICAgbmFtZTogZGVmbi5uYW1lLAogICAgICB0eXBlOiBkZWZuLnR5cGUsCiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVsLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGRlZm4uZmFjdG9yeShlbCwgd2lkdGgsIGhlaWdodCk7CiAgICAgIH0sCiAgICAgIHJlbmRlclZhbHVlOiBmdW5jdGlvbihlbCwgeCwgaW5zdGFuY2UpIHsKICAgICAgICByZXR1cm4gaW5zdGFuY2UucmVuZGVyVmFsdWUoeCk7CiAgICAgIH0sCiAgICAgIHJlc2l6ZTogZnVuY3Rpb24oZWwsIHdpZHRoLCBoZWlnaHQsIGluc3RhbmNlKSB7CiAgICAgICAgcmV0dXJuIGluc3RhbmNlLnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KTsKICAgICAgfQogICAgfTsKCiAgICBpZiAoZGVmbi5maW5kKQogICAgICByZXN1bHQuZmluZCA9IGRlZm4uZmluZDsKICAgIGlmIChkZWZuLnJlbmRlckVycm9yKQogICAgICByZXN1bHQucmVuZGVyRXJyb3IgPSBkZWZuLnJlbmRlckVycm9yOwogICAgaWYgKGRlZm4uY2xlYXJFcnJvcikKICAgICAgcmVzdWx0LmNsZWFyRXJyb3IgPSBkZWZuLmNsZWFyRXJyb3I7CgogICAgcmV0dXJuIHJlc3VsdDsKICB9Cn0pKCk7Cgo="></script>
<script src="data:application/x-javascript;base64,LyohIHB5bS5qcyAtIHYxLjMuMSAtIDIwMTctMDgtMDYgKi8KLyoKKiBQeW0uanMgaXMgbGlicmFyeSB0aGF0IHJlc2l6ZXMgYW4gaWZyYW1lIGJhc2VkIG9uIHRoZSB3aWR0aCBvZiB0aGUgcGFyZW50IGFuZCB0aGUgcmVzdWx0aW5nIGhlaWdodCBvZiB0aGUgY2hpbGQuCiogQ2hlY2sgb3V0IHRoZSBkb2NzIGF0IGh0dHA6Ly9ibG9nLmFwcHMubnByLm9yZy9weW0uanMvIG9yIHRoZSByZWFkbWUgYXQgUkVBRE1FLm1kIGZvciB1c2FnZS4KKi8KCi8qKiBAbW9kdWxlIHB5bSAqLwooZnVuY3Rpb24oZmFjdG9yeSkgewogICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIGRlZmluZShmYWN0b3J5KTsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7CiAgICB9IGVsc2UgewogICAgICAgIHdpbmRvdy5weW0gPSBmYWN0b3J5LmNhbGwodGhpcyk7CiAgICB9Cn0pKGZ1bmN0aW9uKCkgewogICAgdmFyIE1FU1NBR0VfREVMSU1JVEVSID0gJ3hQWU14JzsKCiAgICB2YXIgbGliID0ge307CgogICAgLyoqCiAgICAqIENyZWF0ZSBhbmQgZGlzcGF0Y2ggYSBjdXN0b20gcHltIGV2ZW50CiAgICAqCiAgICAqIEBtZXRob2QgX3JhaXNlQ3VzdG9tRXZlbnQKICAgICogQGlubmVyCiAgICAqCiAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudE5hbWUKICAgICovCiAgIHZhciBfcmFpc2VDdXN0b21FdmVudCA9IGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogICAgIHZhciBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdFdmVudCcpOwogICAgIGV2ZW50LmluaXRFdmVudCgncHltOicgKyBldmVudE5hbWUsIHRydWUsIHRydWUpOwogICAgIGRvY3VtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICB9OwoKICAgIC8qKgogICAgKiBHZW5lcmljIGZ1bmN0aW9uIGZvciBwYXJzaW5nIFVSTCBwYXJhbXMuCiAgICAqIFZpYSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzkwMTExNS9ob3ctY2FuLWktZ2V0LXF1ZXJ5LXN0cmluZy12YWx1ZXMtaW4tamF2YXNjcmlwdAogICAgKgogICAgKiBAbWV0aG9kIF9nZXRQYXJhbWV0ZXJCeU5hbWUKICAgICogQGlubmVyCiAgICAqCiAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBwYXJhbXRlciB0byBnZXQgZnJvbSB0aGUgVVJMLgogICAgKi8KICAgIHZhciBfZ2V0UGFyYW1ldGVyQnlOYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciByZWdleCA9IG5ldyBSZWdFeHAoIltcXD8mXSIgKyBuYW1lLnJlcGxhY2UoL1tcW10vLCAnXFxbJykucmVwbGFjZSgvW1xdXS8sICdcXF0nKSArICc9KFteJiNdKiknKTsKICAgICAgICB2YXIgcmVzdWx0cyA9IHJlZ2V4LmV4ZWMobG9jYXRpb24uc2VhcmNoKTsKCiAgICAgICAgaWYgKHJlc3VsdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChyZXN1bHRzWzFdLnJlcGxhY2UoL1wrL2csICIgIikpOwogICAgfTsKCiAgICAvKioKICAgICAqIENoZWNrIHRoZSBtZXNzYWdlIHRvIG1ha2Ugc3VyZSBpdCBjb21lcyBmcm9tIGFuIGFjY2VwdGFibGUgeGRvbWFpbi4KICAgICAqIERlZmF1bHRzIHRvICcqJyBidXQgY2FuIGJlIG92ZXJyaWRlbiBpbiBjb25maWcuCiAgICAgKgogICAgICogQG1ldGhvZCBfaXNTYWZlTWVzc2FnZQogICAgICogQGlubmVyCiAgICAgKgogICAgICogQHBhcmFtIHtFdmVudH0gZSBUaGUgbWVzc2FnZSBldmVudC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyBDb25maWd1cmF0aW9uLgogICAgICovCiAgICB2YXIgX2lzU2FmZU1lc3NhZ2UgPSBmdW5jdGlvbihlLCBzZXR0aW5ncykgewogICAgICAgIGlmIChzZXR0aW5ncy54ZG9tYWluICE9PSAnKicpIHsKICAgICAgICAgICAgLy8gSWYgb3JpZ2luIGRvZXNuJ3QgbWF0Y2ggb3VyIHhkb21haW4sIHJldHVybi4KICAgICAgICAgICAgaWYgKCFlLm9yaWdpbi5tYXRjaChuZXcgUmVnRXhwKHNldHRpbmdzLnhkb21haW4gKyAnJCcpKSkgeyByZXR1cm47IH0KICAgICAgICB9CgogICAgICAgIC8vIElnbm9yZSBldmVudHMgdGhhdCBkbyBub3QgY2Fycnkgc3RyaW5nIGRhdGEgIzE1MQogICAgICAgIGlmICh0eXBlb2YgZS5kYXRhICE9PSAnc3RyaW5nJykgeyByZXR1cm47IH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwoKICAgIC8qKgogICAgICogQ29uc3RydWN0IGEgbWVzc2FnZSB0byBzZW5kIGJldHdlZW4gZnJhbWVzLgogICAgICoKICAgICAqIE5COiBXZSB1c2Ugc3RyaW5nLWJ1aWxkaW5nIGhlcmUgYmVjYXVzZSBKU09OIG1lc3NhZ2UgcGFzc2luZyBpcwogICAgICogbm90IHN1cHBvcnRlZCBpbiBhbGwgYnJvd3NlcnMuCiAgICAgKgogICAgICogQG1ldGhvZCBfbWFrZU1lc3NhZ2UKICAgICAqIEBpbm5lcgogICAgICoKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgdW5pcXVlIGlkIG9mIHRoZSBtZXNzYWdlIHJlY2lwaWVudC4KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlVHlwZSBUaGUgdHlwZSBvZiBtZXNzYWdlIHRvIHNlbmQuCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzZW5kLgogICAgICovCiAgICB2YXIgX21ha2VNZXNzYWdlID0gZnVuY3Rpb24oaWQsIG1lc3NhZ2VUeXBlLCBtZXNzYWdlKSB7CiAgICAgICAgdmFyIGJpdHMgPSBbJ3B5bScsIGlkLCBtZXNzYWdlVHlwZSwgbWVzc2FnZV07CgogICAgICAgIHJldHVybiBiaXRzLmpvaW4oTUVTU0FHRV9ERUxJTUlURVIpOwogICAgfTsKCiAgICAvKioKICAgICAqIENvbnN0cnVjdCBhIHJlZ2V4IHRvIHZhbGlkYXRlIGFuZCBwYXJzZSBtZXNzYWdlcy4KICAgICAqCiAgICAgKiBAbWV0aG9kIF9tYWtlTWVzc2FnZVJlZ2V4CiAgICAgKiBAaW5uZXIKICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIHVuaXF1ZSBpZCBvZiB0aGUgbWVzc2FnZSByZWNpcGllbnQuCiAgICAgKi8KICAgIHZhciBfbWFrZU1lc3NhZ2VSZWdleCA9IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgdmFyIGJpdHMgPSBbJ3B5bScsIGlkLCAnKFxcUyspJywgJyguKiknXTsKCiAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgYml0cy5qb2luKE1FU1NBR0VfREVMSU1JVEVSKSArICckJyk7CiAgICB9OwoKICAgIC8qKgogICAgKiBVbmRlcnNjb3JlIGltcGxlbWVudGF0aW9uIG9mIGdldE5vdwogICAgKgogICAgKiBAbWV0aG9kIF9nZXROb3cKICAgICogQGlubmVyCiAgICAqCiAgICAqLwogICAgdmFyIF9nZXROb3cgPSBEYXRlLm5vdyB8fCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB9OwoKICAgIC8qKgogICAgKiBVbmRlcnNjb3JlIGltcGxlbWVudGF0aW9uIG9mIHRocm90dGxlCiAgICAqCiAgICAqIEBtZXRob2QgX3Rocm90dGxlCiAgICAqIEBpbm5lcgogICAgKgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmdW5jIFRocm90dGxlZCBmdW5jdGlvbgogICAgKiBAcGFyYW0ge251bWJlcn0gd2FpdCBUaHJvdHRsZSB3YWl0IHRpbWUKICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgVGhyb3R0bGUgc2V0dGluZ3MKICAgICovCgogICAgdmFyIF90aHJvdHRsZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgY29udGV4dCwgYXJncywgcmVzdWx0OwogICAgICAgIHZhciB0aW1lb3V0ID0gbnVsbDsKICAgICAgICB2YXIgcHJldmlvdXMgPSAwOwogICAgICAgIGlmICghb3B0aW9ucykge29wdGlvbnMgPSB7fTt9CiAgICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHByZXZpb3VzID0gb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSA/IDAgOiBfZ2V0Tm93KCk7CiAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICBpZiAoIXRpbWVvdXQpIHtjb250ZXh0ID0gYXJncyA9IG51bGw7fQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbm93ID0gX2dldE5vdygpOwogICAgICAgICAgICBpZiAoIXByZXZpb3VzICYmIG9wdGlvbnMubGVhZGluZyA9PT0gZmFsc2UpIHtwcmV2aW91cyA9IG5vdzt9CiAgICAgICAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKICAgICAgICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgICAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIGlmIChyZW1haW5pbmcgPD0gMCB8fCByZW1haW5pbmcgPiB3YWl0KSB7CiAgICAgICAgICAgICAgICBpZiAodGltZW91dCkgewogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgICAgIGlmICghdGltZW91dCkge2NvbnRleHQgPSBhcmdzID0gbnVsbDt9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRpbWVvdXQgJiYgb3B0aW9ucy50cmFpbGluZyAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDbGVhbiBhdXRvSW5pdCBJbnN0YW5jZXM6IHRob3NlIHRoYXQgcG9pbnQgdG8gY29udGVudGxlc3MgaWZyYW1lcwogICAgICogQG1ldGhvZCBfY2xlYW5BdXRvSW5pdEluc3RhbmNlcwogICAgICogQGlubmVyCiAgICAgKi8KICAgIHZhciBfY2xlYW5BdXRvSW5pdEluc3RhbmNlcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBsZW5ndGggPSBsaWIuYXV0b0luaXRJbnN0YW5jZXMubGVuZ3RoOwoKICAgICAgICAvLyBMb29wIGJhY2t3YXJkcyB0byBhdm9pZCBpbmRleCBpc3N1ZXMKICAgICAgICBmb3IgKHZhciBpZHggPSBsZW5ndGggLSAxOyBpZHggPj0gMDsgaWR4LS0pIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbGliLmF1dG9Jbml0SW5zdGFuY2VzW2lkeF07CiAgICAgICAgICAgIC8vIElmIGluc3RhbmNlIGhhcyBiZWVuIHJlbW92ZWQgb3IgaXMgY29udGVudGxlc3MgdGhlbiByZW1vdmUgaXQKICAgICAgICAgICAgaWYgKGluc3RhbmNlLmVsLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKS5sZW5ndGggJiYKICAgICAgICAgICAgICAgIGluc3RhbmNlLmVsLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKVswXS5jb250ZW50V2luZG93KSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgcmVmZXJlbmNlIHRvIHRoZSByZW1vdmVkIG9yIG9ycGhhbiBpbnN0YW5jZQogICAgICAgICAgICAgICAgbGliLmF1dG9Jbml0SW5zdGFuY2VzLnNwbGljZShpZHgsMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogU3RvcmUgYXV0byBpbml0aWFsaXplZCBQeW0gaW5zdGFuY2VzIGZvciBmdXJ0aGVyIHJlZmVyZW5jZQogICAgICogQG5hbWUgbW9kdWxlOnB5bSNhdXRvSW5pdEluc3RhbmNlcwogICAgICogQHR5cGUgQXJyYXkKICAgICAqIEBkZWZhdWx0IFtdCiAgICAgKi8KICAgIGxpYi5hdXRvSW5pdEluc3RhbmNlcyA9IFtdOwoKICAgIC8qKgogICAgICogSW5pdGlhbGl6ZSBQeW0gZm9yIGVsZW1lbnRzIG9uIHBhZ2UgdGhhdCBoYXZlIGRhdGEtcHltIGF0dHJpYnV0ZXMuCiAgICAgKiBFeHBvc2UgYXV0b2luaXQgaW4gY2FzZSB3ZSBuZWVkIHRvIGNhbGwgaXQgZnJvbSB0aGUgb3V0c2lkZQogICAgICogQGluc3RhbmNlCiAgICAgKiBAbWV0aG9kIGF1dG9Jbml0CiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGRvTm90UmFpc2VFdmVudHMgZmxhZyB0byBhdm9pZCBzZW5kaW5nIGN1c3RvbSBldmVudHMKICAgICAqLwogICAgbGliLmF1dG9Jbml0ID0gZnVuY3Rpb24oZG9Ob3RSYWlzZUV2ZW50cykgewogICAgICAgIHZhciBlbGVtZW50cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLXB5bS1zcmNdOm5vdChbZGF0YS1weW0tYXV0by1pbml0aWFsaXplZF0pJyk7CiAgICAgICAgdmFyIGxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsKCiAgICAgICAgLy8gQ2xlYW4gc3RvcmVkIGluc3RhbmNlcyBpbiBjYXNlIG5lZWRlZAogICAgICAgIF9jbGVhbkF1dG9Jbml0SW5zdGFuY2VzKCk7CiAgICAgICAgZm9yICh2YXIgaWR4ID0gMDsgaWR4IDwgbGVuZ3RoOyArK2lkeCkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGVsZW1lbnRzW2lkeF07CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICogTWFyayBhdXRvbWF0aWNhbGx5LWluaXRpYWxpemVkIGVsZW1lbnRzIHNvIHRoZXkgYXJlIG5vdAogICAgICAgICAgICAqIHJlLWluaXRpYWxpemVkIGlmIHRoZSB1c2VyIGluY2x1ZGVzIHB5bS5qcyBtb3JlIHRoYW4gb25jZSBpbiB0aGUKICAgICAgICAgICAgKiBzYW1lIGRvY3VtZW50LgogICAgICAgICAgICAqLwogICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnZGF0YS1weW0tYXV0by1pbml0aWFsaXplZCcsICcnKTsKCiAgICAgICAgICAgIC8vIEVuc3VyZSBlbGVtZW50cyBoYXZlIGFuIGlkCiAgICAgICAgICAgIGlmIChlbGVtZW50LmlkID09PSAnJykgewogICAgICAgICAgICAgICAgZWxlbWVudC5pZCA9ICdweW0tJyArIGlkeCArICItIiArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLDUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgc3JjID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcHltLXNyYycpOwoKICAgICAgICAgICAgLy8gTGlzdCBvZiBkYXRhIGF0dHJpYnV0ZXMgdG8gY29uZmlndXJlIHRoZSBjb21wb25lbnQKICAgICAgICAgICAgLy8gc3RydWN0dXJlOiB7J2F0dHJpYnV0ZSBuYW1lJzogJ3R5cGUnfQogICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSB7J3hkb21haW4nOiAnc3RyaW5nJywgJ3RpdGxlJzogJ3N0cmluZycsICduYW1lJzogJ3N0cmluZycsICdpZCc6ICdzdHJpbmcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NhbmRib3gnOiAnc3RyaW5nJywgJ2FsbG93ZnVsbHNjcmVlbic6ICdib29sZWFuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwYXJlbnR1cmxwYXJhbSc6ICdzdHJpbmcnLCAncGFyZW50dXJsdmFsdWUnOiAnc3RyaW5nJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvcHRpb25hbHBhcmFtcyc6ICdib29sZWFuJywgJ3RyYWNrc2Nyb2xsJzogJ2Jvb2xlYW4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Njcm9sbHdhaXQnOiAnbnVtYmVyJywgJ2xhenlsb2FkJzogJ2Jvb2xlYW4nfTsKCiAgICAgICAgICAgIHZhciBjb25maWcgPSB7fTsKCiAgICAgICAgICAgIGZvciAodmFyIGF0dHJpYnV0ZSBpbiBzZXR0aW5ncykgewogICAgICAgICAgICAgICAgLy8gdmlhIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9FbGVtZW50L2dldEF0dHJpYnV0ZSNOb3RlcwogICAgICAgICAgICAgICBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcHltLScrYXR0cmlidXRlKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKHNldHRpbmdzW2F0dHJpYnV0ZV0pIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICAgICAgICAgICAgICAgICBjb25maWdbYXR0cmlidXRlXSA9ICEoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcHltLScrYXR0cmlidXRlKSA9PT0gJ2ZhbHNlJyk7IC8vIGpzaGludCBpZ25vcmU6bGluZQogICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnW2F0dHJpYnV0ZV0gPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS1weW0tJythdHRyaWJ1dGUpOwogICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuID0gTnVtYmVyKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXB5bS0nK2F0dHJpYnV0ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKG4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWdbYXR0cmlidXRlXSA9IG47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycigndW5yZWNvZ25pemVkIGF0dHJpYnV0ZSB0eXBlJyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2VzIHRvIGF1dG9pbml0aWFsaXplZCBweW0gaW5zdGFuY2VzCiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBuZXcgbGliLlBhcmVudChlbGVtZW50LmlkLCBzcmMsIGNvbmZpZyk7CiAgICAgICAgICAgIGxpYi5hdXRvSW5pdEluc3RhbmNlcy5wdXNoKHBhcmVudCk7CiAgICAgICAgfQoKICAgICAgICAvLyBGaXJlIGN1c3RvbUV2ZW50CiAgICAgICAgaWYgKCFkb05vdFJhaXNlRXZlbnRzKSB7CiAgICAgICAgICAgIF9yYWlzZUN1c3RvbUV2ZW50KCJweW0taW5pdGlhbGl6ZWQiKTsKICAgICAgICB9CiAgICAgICAgLy8gUmV0dXJuIHN0b3JlZCBhdXRvaW5pdGFsaXplZCBweW0gaW5zdGFuY2VzCiAgICAgICAgcmV0dXJuIGxpYi5hdXRvSW5pdEluc3RhbmNlczsKICAgIH07CgogICAgLyoqCiAgICAgKiBUaGUgUGFyZW50IGhhbGYgb2YgYSByZXNwb25zZSBpZnJhbWUuCiAgICAgKgogICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0KICAgICAqIEBjbGFzcyBQYXJlbnQKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIGRpdiBpbnRvIHdoaWNoIHRoZSBpZnJhbWUgd2lsbCBiZSByZW5kZXJlZC4gc2V0cyB7QGxpbmsgbW9kdWxlOnB5bS5QYXJlbnR+aWR9CiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgb2YgdGhlIGlmcmFtZSBzb3VyY2UuIHNldHMge0BsaW5rIG1vZHVsZTpweW0uUGFyZW50fnVybH0KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbY29uZmlnXSBDb25maWd1cmF0aW9uIGZvciB0aGUgcGFyZW50IGluc3RhbmNlLiBzZXRzIHtAbGluayBtb2R1bGU6cHltLlBhcmVudH5zZXR0aW5nc30KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29uZmlnLnhkb21haW49JyonXSAtIHhkb21haW4gdG8gdmFsaWRhdGUgbWVzc2FnZXMgcmVjZWl2ZWQKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29uZmlnLnRpdGxlXSAtIGlmIHBhc3NlZCBpdCB3aWxsIGJlIGFzc2lnbmVkIHRvIHRoZSBpZnJhbWUgdGl0bGUgYXR0cmlidXRlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbmZpZy5uYW1lXSAtIGlmIHBhc3NlZCBpdCB3aWxsIGJlIGFzc2lnbmVkIHRvIHRoZSBpZnJhbWUgbmFtZSBhdHRyaWJ1dGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29uZmlnLmlkXSAtIGlmIHBhc3NlZCBpdCB3aWxsIGJlIGFzc2lnbmVkIHRvIHRoZSBpZnJhbWUgaWQgYXR0cmlidXRlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjb25maWcuYWxsb3dmdWxsc2NyZWVuXSAtIGlmIHBhc3NlZCBhbmQgZGlmZmVyZW50IHRoYW4gZmFsc2UgaXQgd2lsbCBiZSBhc3NpZ25lZCB0byB0aGUgaWZyYW1lIGFsbG93ZnVsbHNjcmVlbiBhdHRyaWJ1dGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29uZmlnLnNhbmRib3hdIC0gaWYgcGFzc2VkIGl0IHdpbGwgYmUgYXNzaWduZWQgdG8gdGhlIGlmcmFtZSBzYW5kYm94IGF0dHJpYnV0ZSAod2UgZG8gbm90IHZhbGlkYXRlIHRoZSBzeW50YXggc28gYmUgY2FyZWZ1bCEhKQogICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb25maWcucGFyZW50dXJscGFyYW1dIC0gaWYgcGFzc2VkIGl0IHdpbGwgYmUgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgcGFyZW50VXJsIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXIgbmFtZSBwYXNzZWQgdG8gdGhlIGlmcmFtZSBzcmMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29uZmlnLnBhcmVudHVybHZhbHVlXSAtIGlmIHBhc3NlZCBpdCB3aWxsIGJlIG92ZXJyaWRlIHRoZSBkZWZhdWx0IHBhcmVudFVybCBxdWVyeSBzdHJpbmcgcGFyYW1ldGVyIHZhbHVlIHBhc3NlZCB0byB0aGUgaWZyYW1lIHNyYwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb25maWcub3B0aW9uYWxwYXJhbXNdIC0gaWYgcGFzc2VkIGFuZCBkaWZmZXJlbnQgdGhhbiBmYWxzZSBpdCB3aWxsIHN0cmlwIHRoZSBxdWVyeXN0cmluZyBwYXJhbXMgcGFyZW50VXJsIGFuZCBwYXJlbnRUaXRsZSBwYXNzZWQgdG8gdGhlIGlmcmFtZSBzcmMKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2NvbmZpZy50cmFja3Njcm9sbF0gLSBpZiBwYXNzZWQgaXQgd2lsbCBhY3RpdmF0ZSBzY3JvbGwgdHJhY2tpbmcgb24gdGhlIHBhcmVudAogICAgICogQHBhcmFtIHtudW1iZXJ9IFtjb25maWcuc2Nyb2xsd2FpdF0gLSBpZiBwYXNzZWQgaXQgd2lsbCBzZXQgdGhlIHRocm90dGxlIHdhaXQgaW4gb3JkZXIgdG8gZmlyZSBzY3JvbGwgbWVzc2FnaW5nLiBEZWZhdWx0cyB0byAxMDAgbXMuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjb25maWcubGF6eWxvYWRdIC0gaWYgcGFzc2VkIGFuZCBkaWZmZXJlbnQgdGhhbiBmYWxzZSBjb25zdHJ1Y3QgYSBpZnJhbWUgdGhhdCBjYW4gYmUgbGF6eSBsb2FkZWQgYWxvbmcgd2l0aCB7QGxpbmsgaHR0cDovL2RpbmJyb3IuZGsvYmxvZy9ibGF6eS8/cmVmPWdpdGh1YiNpZnJhbWUgYmxhenktaWZyYW1lfQogICAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSFRNTC9FbGVtZW50L2lmcmFtZSBpRnJhbWV9CiAgICAgKi8KICAgIGxpYi5QYXJlbnQgPSBmdW5jdGlvbihpZCwgdXJsLCBjb25maWcpIHsKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgaWQgb2YgdGhlIGNvbnRhaW5lciBlbGVtZW50CiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9IGlkCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5pZCA9IGlkOwogICAgICAgIC8qKgogICAgICAgICAqIFRoZSB1cmwgdGhhdCB3aWxsIGJlIHNldCBhcyB0aGUgaWZyYW1lJ3Mgc3JjCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWVtYmVyIHtTdHJpbmd9IHVybAogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMudXJsID0gdXJsOwoKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgY29udGFpbmVyIERPTSBvYmplY3QKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZW1iZXIge0hUTUxFbGVtZW50fSBlbAogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGNvbnRhaW5lZCBjaGlsZCBpZnJhbWUKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZW1iZXIge0hUTUxFbGVtZW50fSBpZnJhbWUKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKiBAZGVmYXVsdCBudWxsCiAgICAgICAgICovCiAgICAgICAgdGhpcy5pZnJhbWUgPSBudWxsOwogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBwYXJlbnQgaW5zdGFuY2Ugc2V0dGluZ3MsIHVwZGF0ZWQgYnkgdGhlIHZhbHVlcyBwYXNzZWQgaW4gdGhlIGNvbmZpZyBvYmplY3QKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZW1iZXIge09iamVjdH0gc2V0dGluZ3MKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLnNldHRpbmdzID0gewogICAgICAgICAgICB4ZG9tYWluOiAnKicsCiAgICAgICAgICAgIG9wdGlvbmFscGFyYW1zOiB0cnVlLAogICAgICAgICAgICBwYXJlbnR1cmxwYXJhbTogJ3BhcmVudFVybCcsCiAgICAgICAgICAgIHBhcmVudHVybHZhbHVlOiB3aW5kb3cubG9jYXRpb24uaHJlZiwKICAgICAgICAgICAgdHJhY2tzY3JvbGw6IGZhbHNlLAogICAgICAgICAgICBzY3JvbGx3YWl0OiAxMDAsCiAgICAgICAgfTsKICAgICAgICAvKioKICAgICAgICAgKiBSZWd1bGFyRXhwcmVzc2lvbiB0byB2YWxpZGF0ZSB0aGUgcmVjZWl2ZWQgbWVzc2FnZXMKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZW1iZXIge1N0cmluZ30gbWVzc2FnZVJlZ2V4CiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5tZXNzYWdlUmVnZXggPSBfbWFrZU1lc3NhZ2VSZWdleCh0aGlzLmlkKTsKICAgICAgICAvKioKICAgICAgICAgKiBTdG9yZXMgdGhlIHJlZ2lzdGVyZWQgbWVzc2FnZUhhbmRsZXJzIGZvciBlYWNoIG1lc3NhZ2VUeXBlCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWVtYmVyIHtPYmplY3R9IG1lc3NhZ2VIYW5kbGVycwogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMubWVzc2FnZUhhbmRsZXJzID0ge307CgogICAgICAgIC8vIGVuc3VyZSBhIGNvbmZpZyBvYmplY3QKICAgICAgICBjb25maWcgPSAoY29uZmlnIHx8IHt9KTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29uc3RydWN0IHRoZSBpZnJhbWUuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWV0aG9kIF9jb25zdHJ1Y3RJZnJhbWUKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLl9jb25zdHJ1Y3RJZnJhbWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIHRoZSB3aWR0aCBvZiB0aGlzIGVsZW1lbnQuCiAgICAgICAgICAgIHZhciB3aWR0aCA9IHRoaXMuZWwub2Zmc2V0V2lkdGgudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIC8vIENyZWF0ZSBhbiBpZnJhbWUgZWxlbWVudCBhdHRhY2hlZCB0byB0aGUgZG9jdW1lbnQuCiAgICAgICAgICAgIHRoaXMuaWZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CgogICAgICAgICAgICAvLyBTYXZlIGZyYWdtZW50IGlkCiAgICAgICAgICAgIHZhciBoYXNoID0gJyc7CiAgICAgICAgICAgIHZhciBoYXNoSW5kZXggPSB0aGlzLnVybC5pbmRleE9mKCcjJyk7CgogICAgICAgICAgICBpZiAoaGFzaEluZGV4ID4gLTEpIHsKICAgICAgICAgICAgICAgIGhhc2ggPSB0aGlzLnVybC5zdWJzdHJpbmcoaGFzaEluZGV4LCB0aGlzLnVybC5sZW5ndGgpOwogICAgICAgICAgICAgICAgdGhpcy51cmwgPSB0aGlzLnVybC5zdWJzdHJpbmcoMCwgaGFzaEluZGV4KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgdGhlIFVSTCBjb250YWlucyBxdWVyeXN0cmluZyBiaXRzLCB1c2UgdGhlbS4KICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBqdXN0IGNyZWF0ZSBhIHNldCBvZiB2YWxpZCBwYXJhbXMuCiAgICAgICAgICAgIGlmICh0aGlzLnVybC5pbmRleE9mKCc/JykgPCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVybCArPSAnPyc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnVybCArPSAnJic7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFwcGVuZCB0aGUgaW5pdGlhbCB3aWR0aCBhcyBhIHF1ZXJ5c3RyaW5nIHBhcmFtZXRlcgogICAgICAgICAgICAvLyBhbmQgb3B0aW9uYWwgcGFyYW1zIGlmIGNvbmZpZ3VyZWQgdG8gZG8gc28KICAgICAgICAgICAgdGhpcy5pZnJhbWUuc3JjID0gdGhpcy51cmwgKyAnaW5pdGlhbFdpZHRoPScgKyB3aWR0aCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZjaGlsZElkPScgKyB0aGlzLmlkOwoKICAgICAgICAgICAgaWYgKHRoaXMuc2V0dGluZ3Mub3B0aW9uYWxwYXJhbXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNyYyArPSAnJnBhcmVudFRpdGxlPScgKyBlbmNvZGVVUklDb21wb25lbnQoZG9jdW1lbnQudGl0bGUpOwogICAgICAgICAgICAgICAgdGhpcy5pZnJhbWUuc3JjICs9ICcmJysgdGhpcy5zZXR0aW5ncy5wYXJlbnR1cmxwYXJhbSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLnNldHRpbmdzLnBhcmVudHVybHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlmcmFtZS5zcmMgKz1oYXNoOwoKICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5sYXp5bG9hZCkgewogICAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnZGF0YS1zcmMnLCB0aGlzLmlmcmFtZS5zcmMpOwogICAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnYi1sYXp5Jyk7CiAgICAgICAgICAgICAgdGhpcy5pZnJhbWUuc3JjID0gJ2Fib3V0OmJsYW5rJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2V0IHNvbWUgYXR0cmlidXRlcyB0byB0aGlzIHByb3RvLWlmcmFtZS4KICAgICAgICAgICAgdGhpcy5pZnJhbWUuc2V0QXR0cmlidXRlKCd3aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnc2Nyb2xsaW5nJywgJ25vJyk7CiAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnbWFyZ2luaGVpZ2h0JywgJzAnKTsKICAgICAgICAgICAgdGhpcy5pZnJhbWUuc2V0QXR0cmlidXRlKCdmcmFtZWJvcmRlcicsICcwJyk7CgogICAgICAgICAgICBpZiAodGhpcy5zZXR0aW5ncy50aXRsZSkgewogICAgICAgICAgICAgICAgdGhpcy5pZnJhbWUuc2V0QXR0cmlidXRlKCd0aXRsZScsIHRoaXMuc2V0dGluZ3MudGl0bGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zZXR0aW5ncy5hbGxvd2Z1bGxzY3JlZW4gIT09IHVuZGVmaW5lZCAmJiB0aGlzLnNldHRpbmdzLmFsbG93ZnVsbHNjcmVlbiAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnYWxsb3dmdWxsc2NyZWVuJywnJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnNldHRpbmdzLnNhbmRib3ggIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdGhpcy5zZXR0aW5ncy5zYW5kYm94ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgdGhpcy5pZnJhbWUuc2V0QXR0cmlidXRlKCdzYW5kYm94JywgdGhpcy5zZXR0aW5ncy5zYW5kYm94KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc2V0dGluZ3MuaWQpIHsKICAgICAgICAgICAgICAgIGlmICghZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5zZXR0aW5ncy5pZCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlmcmFtZS5zZXRBdHRyaWJ1dGUoJ2lkJywgdGhpcy5zZXR0aW5ncy5pZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnNldHRpbmdzLm5hbWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnbmFtZScsIHRoaXMuc2V0dGluZ3MubmFtZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJlcGxhY2UgdGhlIGNoaWxkIGNvbnRlbnQgaWYgbmVlZGVkCiAgICAgICAgICAgIC8vIChzb21lIENNU3MgbWlnaHQgc3RyaXAgb3V0IGVtcHR5IGVsZW1lbnRzKQogICAgICAgICAgICB3aGlsZSh0aGlzLmVsLmZpcnN0Q2hpbGQpIHsgdGhpcy5lbC5yZW1vdmVDaGlsZCh0aGlzLmVsLmZpcnN0Q2hpbGQpOyB9CiAgICAgICAgICAgIC8vIEFwcGVuZCB0aGUgaWZyYW1lIHRvIG91ciBlbGVtZW50LgogICAgICAgICAgICB0aGlzLmVsLmFwcGVuZENoaWxkKHRoaXMuaWZyYW1lKTsKCiAgICAgICAgICAgIC8vIEFkZCBhbiBldmVudCBsaXN0ZW5lciB0aGF0IHdpbGwgaGFuZGxlIHJlZHJhd2luZyB0aGUgY2hpbGQgb24gcmVzaXplLgogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5fb25SZXNpemUpOwoKICAgICAgICAgICAgLy8gQWRkIGFuIGV2ZW50IGxpc3RlbmVyIHRoYXQgd2lsbCBzZW5kIHRoZSBjaGlsZCB0aGUgdmlld3BvcnQuCiAgICAgICAgICAgIGlmICh0aGlzLnNldHRpbmdzLnRyYWNrc2Nyb2xsKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5fdGhyb3R0bGVPblNjcm9sbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBTZW5kIHdpZHRoIG9uIHJlc2l6ZS4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZXRob2QgX29uUmVzaXplCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fb25SZXNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5zZW5kV2lkdGgoKTsKICAgICAgICAgICAgaWYgKHRoaXMuc2V0dGluZ3MudHJhY2tzY3JvbGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VuZFZpZXdwb3J0QW5kSUZyYW1lUG9zaXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH0uYmluZCh0aGlzKTsKCiAgICAgICAgLyoqCiAgICAgICAgICogU2VuZCB2aWV3cG9ydCBhbmQgaWZyYW1lIGluZm8gb24gc2Nyb2xsLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uUGFyZW50CiAgICAgICAgICogQG1ldGhvZCBfb25TY3JvbGwKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLl9vblNjcm9sbCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnNlbmRWaWV3cG9ydEFuZElGcmFtZVBvc2l0aW9uKCk7CiAgICAgICAgfS5iaW5kKHRoaXMpOwoKICAgICAgICAvKioKICAgICAgICAgKiBGaXJlIGFsbCBldmVudCBoYW5kbGVycyBmb3IgYSBnaXZlbiBtZXNzYWdlIHR5cGUuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWV0aG9kIF9maXJlCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZVR5cGUgVGhlIHR5cGUgb2YgbWVzc2FnZS4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbWVzc2FnZSBkYXRhLgogICAgICAgICAqLwogICAgICAgIHRoaXMuX2ZpcmUgPSBmdW5jdGlvbihtZXNzYWdlVHlwZSwgbWVzc2FnZSkgewogICAgICAgICAgICBpZiAobWVzc2FnZVR5cGUgaW4gdGhpcy5tZXNzYWdlSGFuZGxlcnMpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5tZXNzYWdlSGFuZGxlcnNbbWVzc2FnZVR5cGVdLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyc1ttZXNzYWdlVHlwZV1baV0uY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFJlbW92ZSB0aGlzIHBhcmVudCBmcm9tIHRoZSBwYWdlIGFuZCB1bmJpbmQgaXQncyBldmVudCBoYW5kbGVycy4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZXRob2QgcmVtb3ZlCiAgICAgICAgICogQGluc3RhbmNlCiAgICAgICAgICovCiAgICAgICAgdGhpcy5yZW1vdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCB0aGlzLl9wcm9jZXNzTWVzc2FnZSk7CiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLl9vblJlc2l6ZSk7CgogICAgICAgICAgICB0aGlzLmVsLnJlbW92ZUNoaWxkKHRoaXMuaWZyYW1lKTsKICAgICAgICAgICAgLy8gX2NsZWFuQXV0b0luaXRJbnN0YW5jZXMgaW4gY2FzZSB0aGlzIHBhcmVudCB3YXMgYXV0b0luaXRpYWxpemVkCiAgICAgICAgICAgIF9jbGVhbkF1dG9Jbml0SW5zdGFuY2VzKCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogUHJvY2VzcyBhIG5ldyBtZXNzYWdlIGZyb20gdGhlIGNoaWxkLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uUGFyZW50CiAgICAgICAgICogQG1ldGhvZCBfcHJvY2Vzc01lc3NhZ2UKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RXZlbnR9IGUgQSBtZXNzYWdlIGV2ZW50LgogICAgICAgICAqLwogICAgICAgIHRoaXMuX3Byb2Nlc3NNZXNzYWdlID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAvLyBGaXJzdCwgcHVudCBpZiB0aGlzIGlzbid0IGZyb20gYW4gYWNjZXB0YWJsZSB4ZG9tYWluLgogICAgICAgICAgICBpZiAoIV9pc1NhZmVNZXNzYWdlKGUsIHRoaXMuc2V0dGluZ3MpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERpc2NhcmQgb2JqZWN0IG1lc3NhZ2VzLCB3ZSBvbmx5IGNhcmUgYWJvdXQgc3RyaW5ncwogICAgICAgICAgICBpZiAodHlwZW9mIGUuZGF0YSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR3JhYiB0aGUgbWVzc2FnZSBmcm9tIHRoZSBjaGlsZCBhbmQgcGFyc2UgaXQuCiAgICAgICAgICAgIHZhciBtYXRjaCA9IGUuZGF0YS5tYXRjaCh0aGlzLm1lc3NhZ2VSZWdleCk7CgogICAgICAgICAgICAvLyBJZiB0aGVyZSdzIG5vIG1hdGNoIG9yIHRvbyBtYW55IG1hdGNoZXMgaW4gdGhlIG1lc3NhZ2UsIHB1bnQuCiAgICAgICAgICAgIGlmICghbWF0Y2ggfHwgbWF0Y2gubGVuZ3RoICE9PSAzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBtZXNzYWdlVHlwZSA9IG1hdGNoWzFdOwogICAgICAgICAgICB2YXIgbWVzc2FnZSA9IG1hdGNoWzJdOwoKICAgICAgICAgICAgdGhpcy5fZmlyZShtZXNzYWdlVHlwZSwgbWVzc2FnZSk7CiAgICAgICAgfS5iaW5kKHRoaXMpOwoKICAgICAgICAvKioKICAgICAgICAgKiBSZXNpemUgaWZyYW1lIGluIHJlc3BvbnNlIHRvIG5ldyBoZWlnaHQgbWVzc2FnZSBmcm9tIGNoaWxkLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uUGFyZW50CiAgICAgICAgICogQG1ldGhvZCBfb25IZWlnaHRNZXNzYWdlCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbmV3IGhlaWdodC4KICAgICAgICAgKi8KICAgICAgICB0aGlzLl9vbkhlaWdodE1lc3NhZ2UgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAqIEhhbmRsZSBwYXJlbnQgaGVpZ2h0IG1lc3NhZ2UgZnJvbSBjaGlsZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHZhciBoZWlnaHQgPSBwYXJzZUludChtZXNzYWdlKTsKCiAgICAgICAgICAgIHRoaXMuaWZyYW1lLnNldEF0dHJpYnV0ZSgnaGVpZ2h0JywgaGVpZ2h0ICsgJ3B4Jyk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogTmF2aWdhdGUgcGFyZW50IHRvIGEgbmV3IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZXRob2QgX29uTmF2aWdhdGVUb01lc3NhZ2UKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlIFRoZSB1cmwgdG8gbmF2aWdhdGUgdG8uCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fb25OYXZpZ2F0ZVRvTWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICogSGFuZGxlIHBhcmVudCBzY3JvbGwgbWVzc2FnZSBmcm9tIGNoaWxkLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IG1lc3NhZ2U7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogU2Nyb2xsIHBhcmVudCB0byBhIGdpdmVuIGNoaWxkIHBvc2l0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uUGFyZW50CiAgICAgICAgICogQG1ldGhvZCBfb25TY3JvbGxUb0NoaWxkUG9zTWVzc2FnZQogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG9mZnNldCBpbnNpZGUgdGhlIGNoaWxkIHBhZ2UuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fb25TY3JvbGxUb0NoaWxkUG9zTWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICAgICAgLy8gR2V0IHRoZSBjaGlsZCBjb250YWluZXIgcG9zaXRpb24gdXNpbmcgZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICsgcGFnZVlPZmZzZXQKICAgICAgICAgICAgLy8gdmlhIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9FbGVtZW50L2dldEJvdW5kaW5nQ2xpZW50UmVjdAogICAgICAgICAgICB2YXIgaWZyYW1lUG9zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5pZCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wICsgd2luZG93LnBhZ2VZT2Zmc2V0OwoKICAgICAgICAgICAgdmFyIHRvdGFsT2Zmc2V0ID0gaWZyYW1lUG9zICsgcGFyc2VJbnQobWVzc2FnZSk7CiAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCB0b3RhbE9mZnNldCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQmluZCBhIGNhbGxiYWNrIHRvIGEgZ2l2ZW4gbWVzc2FnZVR5cGUgZnJvbSB0aGUgY2hpbGQuCiAgICAgICAgICoKICAgICAgICAgKiBSZXNlcnZlZCBtZXNzYWdlIG5hbWVzIGFyZTogImhlaWdodCIsICJzY3JvbGxUbyIgYW5kICJuYXZpZ2F0ZVRvIi4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZXRob2Qgb25NZXNzYWdlCiAgICAgICAgICogQGluc3RhbmNlCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZVR5cGUgVGhlIHR5cGUgb2YgbWVzc2FnZSBiZWluZyBsaXN0ZW5lZCBmb3IuCiAgICAgICAgICogQHBhcmFtIHttb2R1bGU6cHltLlBhcmVudH5vbk1lc3NhZ2VDYWxsYmFja30gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIHRvIGludm9rZSB3aGVuIGEgbWVzc2FnZSBvZiB0aGUgZ2l2ZW4gdHlwZSBpcyByZWNlaXZlZC4KICAgICAgICAgKi8KICAgICAgICB0aGlzLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2VUeXBlLCBjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoIShtZXNzYWdlVHlwZSBpbiB0aGlzLm1lc3NhZ2VIYW5kbGVycykpIHsKICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZUhhbmRsZXJzW21lc3NhZ2VUeXBlXSA9IFtdOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyc1ttZXNzYWdlVHlwZV0ucHVzaChjYWxsYmFjayk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQGNhbGxiYWNrIG1vZHVsZTpweW0uUGFyZW50fm9uTWVzc2FnZUNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG1lc3NhZ2UgZGF0YS4KICAgICAgICAgKi8KCiAgICAgICAgLyoqCiAgICAgICAgICogU2VuZCBhIG1lc3NhZ2UgdG8gdGhlIHRoZSBjaGlsZC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLlBhcmVudAogICAgICAgICAqIEBtZXRob2Qgc2VuZE1lc3NhZ2UKICAgICAgICAgKiBAaW5zdGFuY2UKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlVHlwZSBUaGUgdHlwZSBvZiBtZXNzYWdlIHRvIHNlbmQuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG1lc3NhZ2UgZGF0YSB0byBzZW5kLgogICAgICAgICAqLwogICAgICAgIHRoaXMuc2VuZE1lc3NhZ2UgPSBmdW5jdGlvbihtZXNzYWdlVHlwZSwgbWVzc2FnZSkgewogICAgICAgICAgICAvLyBXaGVuIHVzZWQgYWxvbmdzaWRlIHdpdGggcGpheCBzb21lIHJlZmVyZW5jZXMgYXJlIGxvc3QKICAgICAgICAgICAgaWYgKHRoaXMuZWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lmcmFtZScpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lmcmFtZScpWzBdLmNvbnRlbnRXaW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKVswXS5jb250ZW50V2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgIC5wb3N0TWVzc2FnZShfbWFrZU1lc3NhZ2UodGhpcy5pZCwgbWVzc2FnZVR5cGUsIG1lc3NhZ2UpLCAnKicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29udGVudGxlc3MgY2hpbGQgZGV0ZWN0ZWQgcmVtb3ZlIGxpc3RlbmVycyBhbmQgaWZyYW1lCiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFRyYW5zbWl0IHRoZSBjdXJyZW50IGlmcmFtZSB3aWR0aCB0byB0aGUgY2hpbGQuCiAgICAgICAgICoKICAgICAgICAgKiBZb3Ugc2hvdWxkbid0IG5lZWQgdG8gY2FsbCB0aGlzIGRpcmVjdGx5LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uUGFyZW50CiAgICAgICAgICogQG1ldGhvZCBzZW5kV2lkdGgKICAgICAgICAgKiBAaW5zdGFuY2UKICAgICAgICAgKi8KICAgICAgICB0aGlzLnNlbmRXaWR0aCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgd2lkdGggPSB0aGlzLmVsLm9mZnNldFdpZHRoLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIHRoaXMuc2VuZE1lc3NhZ2UoJ3dpZHRoJywgd2lkdGgpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFRyYW5zbWl0IHRoZSBjdXJyZW50IHZpZXdwb3J0IGFuZCBpZnJhbWUgcG9zaXRpb24gdG8gdGhlIGNoaWxkLgogICAgICAgICAqIFNlbmRzIHZpZXdwb3J0IHdpZHRoLCB2aWV3cG9ydCBoZWlnaHQKICAgICAgICAgKiBhbmQgaWZyYW1lIGJvdW5kaW5nIHJlY3QgdG9wLWxlZnQtYm90dG9tLXJpZ2h0CiAgICAgICAgICogYWxsIHNlcGFyYXRlZCBieSBzcGFjZXMKICAgICAgICAgKgogICAgICAgICAqIFlvdSBzaG91bGRuJ3QgbmVlZCB0byBjYWxsIHRoaXMgZGlyZWN0bHkuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWV0aG9kIHNlbmRWaWV3cG9ydEFuZElGcmFtZVBvc2l0aW9uCiAgICAgICAgICogQGluc3RhbmNlCiAgICAgICAgICovCiAgICAgICAgdGhpcy5zZW5kVmlld3BvcnRBbmRJRnJhbWVQb3NpdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaWZyYW1lUmVjdCA9IHRoaXMuaWZyYW1lLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICB2YXIgdldpZHRoICAgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGg7CiAgICAgICAgICAgIHZhciB2SGVpZ2h0ICA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICB2YXIgcGF5bG9hZCA9IHZXaWR0aCArICcgJyArIHZIZWlnaHQ7CiAgICAgICAgICAgIHBheWxvYWQgKz0gJyAnICsgaWZyYW1lUmVjdC50b3AgKyAnICcgKyBpZnJhbWVSZWN0LmxlZnQ7CiAgICAgICAgICAgIHBheWxvYWQgKz0gJyAnICsgaWZyYW1lUmVjdC5ib3R0b20gKyAnICcgKyBpZnJhbWVSZWN0LnJpZ2h0OwogICAgICAgICAgICB0aGlzLnNlbmRNZXNzYWdlKCd2aWV3cG9ydC1pZnJhbWUtcG9zaXRpb24nLCBwYXlsb2FkKTsKICAgICAgICB9OwoKICAgICAgICAvLyBBZGQgYW55IG92ZXJyaWRlcyB0byBzZXR0aW5ncyBjb21pbmcgZnJvbSBjb25maWcuCiAgICAgICAgZm9yICh2YXIga2V5IGluIGNvbmZpZykgewogICAgICAgICAgICB0aGlzLnNldHRpbmdzW2tleV0gPSBjb25maWdba2V5XTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIFRocm90dGxlZCBzY3JvbGwgZnVuY3Rpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5QYXJlbnQKICAgICAgICAgKiBAbWV0aG9kIF90aHJvdHRsZU9uU2Nyb2xsCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fdGhyb3R0bGVPblNjcm9sbCA9IF90aHJvdHRsZSh0aGlzLl9vblNjcm9sbC5iaW5kKHRoaXMpLCB0aGlzLnNldHRpbmdzLnNjcm9sbHdhaXQpOwoKICAgICAgICAvLyBCaW5kIHJlcXVpcmVkIG1lc3NhZ2UgaGFuZGxlcnMKICAgICAgICB0aGlzLm9uTWVzc2FnZSgnaGVpZ2h0JywgdGhpcy5fb25IZWlnaHRNZXNzYWdlKTsKICAgICAgICB0aGlzLm9uTWVzc2FnZSgnbmF2aWdhdGVUbycsIHRoaXMuX29uTmF2aWdhdGVUb01lc3NhZ2UpOwogICAgICAgIHRoaXMub25NZXNzYWdlKCdzY3JvbGxUb0NoaWxkUG9zJywgdGhpcy5fb25TY3JvbGxUb0NoaWxkUG9zTWVzc2FnZSk7CiAgICAgICAgdGhpcy5vbk1lc3NhZ2UoJ3BhcmVudFBvc2l0aW9uSW5mbycsIHRoaXMuc2VuZFZpZXdwb3J0QW5kSUZyYW1lUG9zaXRpb24pOwoKICAgICAgICAvLyBBZGQgYSBsaXN0ZW5lciBmb3IgcHJvY2Vzc2luZyBtZXNzYWdlcyBmcm9tIHRoZSBjaGlsZC4KICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIHRoaXMuX3Byb2Nlc3NNZXNzYWdlLCBmYWxzZSk7CgogICAgICAgIC8vIENvbnN0cnVjdCB0aGUgaWZyYW1lIGluIHRoZSBjb250YWluZXIgZWxlbWVudC4KICAgICAgICB0aGlzLl9jb25zdHJ1Y3RJZnJhbWUoKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIC8qKgogICAgICogVGhlIENoaWxkIGhhbGYgb2YgYSByZXNwb25zaXZlIGlmcmFtZS4KICAgICAqCiAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bQogICAgICogQGNsYXNzIENoaWxkCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW2NvbmZpZ10gQ29uZmlndXJhdGlvbiBmb3IgdGhlIGNoaWxkIGluc3RhbmNlLiBzZXRzIHtAbGluayBtb2R1bGU6cHltLkNoaWxkfnNldHRpbmdzfQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gW2NvbmZpZy5yZW5kZXJDYWxsYmFjaz1udWxsXSBDYWxsYmFjayBpbnZva2VkIGFmdGVyIHJlY2VpdmluZyBhIHJlc2l6ZSBldmVudCBmcm9tIHRoZSBwYXJlbnQsIHNldHMge0BsaW5rIG1vZHVsZTpweW0uQ2hpbGQjc2V0dGluZ3MucmVuZGVyQ2FsbGJhY2t9CiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbmZpZy54ZG9tYWluPScqJ10gLSB4ZG9tYWluIHRvIHZhbGlkYXRlIG1lc3NhZ2VzIHJlY2VpdmVkCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2NvbmZpZy5wb2xsaW5nPTBdIC0gcG9sbGluZyBmcmVxdWVuY3kgaW4gbWlsbGlzZWNvbmRzIHRvIHNlbmQgaGVpZ2h0IHRvIHBhcmVudAogICAgICogQHBhcmFtIHtudW1iZXJ9IFtjb25maWcuaWRdIC0gcGFyZW50IGNvbnRhaW5lciBpZCB1c2VkIHdoZW4gbmF2aWdhdGluZyB0aGUgY2hpbGQgaWZyYW1lIHRvIGEgbmV3IHBhZ2UgYnV0IHdlIHdhbnQgdG8ga2VlcCBpdCByZXNwb25zaXZlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb25maWcucGFyZW50dXJscGFyYW1dIC0gaWYgcGFzc2VkIGl0IHdpbGwgYmUgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgcGFyZW50VXJsIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXIgbmFtZSBleHBlY3RlZCBvbiB0aGUgaWZyYW1lIHNyYwogICAgICovCiAgICBsaWIuQ2hpbGQgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgaW5pdGlhbCB3aWR0aCBvZiB0aGUgcGFyZW50IHBhZ2UKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSBwYXJlbnRXaWR0aAogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMucGFyZW50V2lkdGggPSBudWxsOwogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBpZCBvZiB0aGUgcGFyZW50IGNvbnRhaW5lcgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWVtYmVyIHtTdHJpbmd9IGlkCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5pZCA9IG51bGw7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHRpdGxlIG9mIHRoZSBwYXJlbnQgcGFnZSBmcm9tIGRvY3VtZW50LnRpdGxlLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWVtYmVyIHtTdHJpbmd9IHBhcmVudFRpdGxlCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5wYXJlbnRUaXRsZSA9IG51bGw7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIFVSTCBvZiB0aGUgcGFyZW50IHBhZ2UgZnJvbSB3aW5kb3cubG9jYXRpb24uaHJlZi4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1lbWJlciB7U3RyaW5nfSBwYXJlbnRVcmwKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLnBhcmVudFVybCA9IG51bGw7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHNldHRpbmdzIGZvciB0aGUgY2hpbGQgaW5zdGFuY2UuIENhbiBiZSBvdmVycmlkZW4gYnkgcGFzc2luZyBhIGNvbmZpZyBvYmplY3QgdG8gdGhlIGNoaWxkIGNvbnN0cnVjdG9yCiAgICAgICAgICogaS5lLjogdmFyIHB5bUNoaWxkID0gbmV3IHB5bS5DaGlsZCh7cmVuZGVyQ2FsbGJhY2s6IHJlbmRlciwgeGRvbWFpbjogIlxcKlwubnByXC5vcmcifSkKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkLnNldHRpbmdzCiAgICAgICAgICogQG1lbWJlciB7T2JqZWN0fSBzZXR0aW5ncyAtIGRlZmF1bHQgc2V0dGluZ3MgZm9yIHRoZSBjaGlsZCBpbnN0YW5jZQogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMuc2V0dGluZ3MgPSB7CiAgICAgICAgICAgIHJlbmRlckNhbGxiYWNrOiBudWxsLAogICAgICAgICAgICB4ZG9tYWluOiAnKicsCiAgICAgICAgICAgIHBvbGxpbmc6IDAsCiAgICAgICAgICAgIHBhcmVudHVybHBhcmFtOiAncGFyZW50VXJsJwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFRoZSB0aW1lcklkIGluIG9yZGVyIHRvIGJlIGFibGUgdG8gc3RvcCB3aGVuIHBvbGxpbmcgaXMgZW5hYmxlZAogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWVtYmVyIHtTdHJpbmd9IHRpbWVySWQKICAgICAgICAgKiBAaW5uZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLnRpbWVySWQgPSBudWxsOwogICAgICAgIC8qKgogICAgICAgICAqIFJlZ3VsYXJFeHByZXNzaW9uIHRvIHZhbGlkYXRlIHRoZSByZWNlaXZlZCBtZXNzYWdlcwogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWVtYmVyIHtTdHJpbmd9IG1lc3NhZ2VSZWdleAogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqLwogICAgICAgIHRoaXMubWVzc2FnZVJlZ2V4ID0gbnVsbDsKICAgICAgICAvKioKICAgICAgICAgKiBTdG9yZXMgdGhlIHJlZ2lzdGVyZWQgbWVzc2FnZUhhbmRsZXJzIGZvciBlYWNoIG1lc3NhZ2VUeXBlCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZW1iZXIge09iamVjdH0gbWVzc2FnZUhhbmRsZXJzCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5tZXNzYWdlSGFuZGxlcnMgPSB7fTsKCiAgICAgICAgLy8gRW5zdXJlIGEgY29uZmlnIG9iamVjdAogICAgICAgIGNvbmZpZyA9IChjb25maWcgfHwge30pOwoKICAgICAgICAvKioKICAgICAgICAgKiBCaW5kIGEgY2FsbGJhY2sgdG8gYSBnaXZlbiBtZXNzYWdlVHlwZSBmcm9tIHRoZSBjaGlsZC4KICAgICAgICAgKgogICAgICAgICAqIFJlc2VydmVkIG1lc3NhZ2UgbmFtZXMgYXJlOiAid2lkdGgiLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWV0aG9kIG9uTWVzc2FnZQogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2VUeXBlIFRoZSB0eXBlIG9mIG1lc3NhZ2UgYmVpbmcgbGlzdGVuZWQgZm9yLgogICAgICAgICAqIEBwYXJhbSB7bW9kdWxlOnB5bS5DaGlsZH5vbk1lc3NhZ2VDYWxsYmFja30gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIHRvIGludm9rZSB3aGVuIGEgbWVzc2FnZSBvZiB0aGUgZ2l2ZW4gdHlwZSBpcyByZWNlaXZlZC4KICAgICAgICAgKi8KICAgICAgICB0aGlzLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2VUeXBlLCBjYWxsYmFjaykgewoKICAgICAgICAgICAgaWYgKCEobWVzc2FnZVR5cGUgaW4gdGhpcy5tZXNzYWdlSGFuZGxlcnMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyc1ttZXNzYWdlVHlwZV0gPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5tZXNzYWdlSGFuZGxlcnNbbWVzc2FnZVR5cGVdLnB1c2goY2FsbGJhY2spOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBjYWxsYmFjayBtb2R1bGU6cHltLkNoaWxkfm9uTWVzc2FnZUNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG1lc3NhZ2UgZGF0YS4KICAgICAgICAgKi8KCgogICAgICAgIC8qKgogICAgICAgICAqIEZpcmUgYWxsIGV2ZW50IGhhbmRsZXJzIGZvciBhIGdpdmVuIG1lc3NhZ2UgdHlwZS4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1ldGhvZCBfZmlyZQogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2VUeXBlIFRoZSB0eXBlIG9mIG1lc3NhZ2UuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIG1lc3NhZ2UgZGF0YS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLl9maXJlID0gZnVuY3Rpb24obWVzc2FnZVR5cGUsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICogRmlyZSBhbGwgZXZlbnQgaGFuZGxlcnMgZm9yIGEgZ2l2ZW4gbWVzc2FnZSB0eXBlLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaWYgKG1lc3NhZ2VUeXBlIGluIHRoaXMubWVzc2FnZUhhbmRsZXJzKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubWVzc2FnZUhhbmRsZXJzW21lc3NhZ2VUeXBlXS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgdGhpcy5tZXNzYWdlSGFuZGxlcnNbbWVzc2FnZVR5cGVdW2ldLmNhbGwodGhpcywgbWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBQcm9jZXNzIGEgbmV3IG1lc3NhZ2UgZnJvbSB0aGUgcGFyZW50LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWV0aG9kIF9wcm9jZXNzTWVzc2FnZQogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtFdmVudH0gZSBBIG1lc3NhZ2UgZXZlbnQuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fcHJvY2Vzc01lc3NhZ2UgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICogUHJvY2VzcyBhIG5ldyBtZXNzYWdlIGZyb20gcGFyZW50IGZyYW1lLgogICAgICAgICAgICAqLwogICAgICAgICAgICAvLyBGaXJzdCwgcHVudCBpZiB0aGlzIGlzbid0IGZyb20gYW4gYWNjZXB0YWJsZSB4ZG9tYWluLgogICAgICAgICAgICBpZiAoIV9pc1NhZmVNZXNzYWdlKGUsIHRoaXMuc2V0dGluZ3MpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIERpc2NhcmQgb2JqZWN0IG1lc3NhZ2VzLCB3ZSBvbmx5IGNhcmUgYWJvdXQgc3RyaW5ncwogICAgICAgICAgICBpZiAodHlwZW9mIGUuZGF0YSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR2V0IHRoZSBtZXNzYWdlIGZyb20gdGhlIHBhcmVudC4KICAgICAgICAgICAgdmFyIG1hdGNoID0gZS5kYXRhLm1hdGNoKHRoaXMubWVzc2FnZVJlZ2V4KTsKCiAgICAgICAgICAgIC8vIElmIHRoZXJlJ3Mgbm8gbWF0Y2ggb3IgaXQncyBhIGJhZCBmb3JtYXQsIHB1bnQuCiAgICAgICAgICAgIGlmICghbWF0Y2ggfHwgbWF0Y2gubGVuZ3RoICE9PSAzKSB7IHJldHVybjsgfQoKICAgICAgICAgICAgdmFyIG1lc3NhZ2VUeXBlID0gbWF0Y2hbMV07CiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gbWF0Y2hbMl07CgogICAgICAgICAgICB0aGlzLl9maXJlKG1lc3NhZ2VUeXBlLCBtZXNzYWdlKTsKICAgICAgICB9LmJpbmQodGhpcyk7CgogICAgICAgIC8qKgogICAgICAgICAqIFJlc2l6ZSBpZnJhbWUgaW4gcmVzcG9uc2UgdG8gbmV3IHdpZHRoIG1lc3NhZ2UgZnJvbSBwYXJlbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZXRob2QgX29uV2lkdGhNZXNzYWdlCiAgICAgICAgICogQGlubmVyCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbmV3IHdpZHRoLgogICAgICAgICAqLwogICAgICAgIHRoaXMuX29uV2lkdGhNZXNzYWdlID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICAvKgogICAgICAgICAgICAgKiBIYW5kbGUgd2lkdGggbWVzc2FnZSBmcm9tIHRoZSBjaGlsZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHZhciB3aWR0aCA9IHBhcnNlSW50KG1lc3NhZ2UpOwoKICAgICAgICAgICAgLy8gQ2hhbmdlIHRoZSB3aWR0aCBpZiBpdCdzIGRpZmZlcmVudC4KICAgICAgICAgICAgaWYgKHdpZHRoICE9PSB0aGlzLnBhcmVudFdpZHRoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudFdpZHRoID0gd2lkdGg7CgogICAgICAgICAgICAgICAgLy8gQ2FsbCB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gaWYgaXQgZXhpc3RzLgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2V0dGluZ3MucmVuZGVyQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldHRpbmdzLnJlbmRlckNhbGxiYWNrKHdpZHRoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTZW5kIHRoZSBoZWlnaHQgYmFjayB0byB0aGUgcGFyZW50LgogICAgICAgICAgICAgICAgdGhpcy5zZW5kSGVpZ2h0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBTZW5kIGEgbWVzc2FnZSB0byB0aGUgdGhlIFBhcmVudC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1ldGhvZCBzZW5kTWVzc2FnZQogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2VUeXBlIFRoZSB0eXBlIG9mIG1lc3NhZ2UgdG8gc2VuZC4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbWVzc2FnZSBkYXRhIHRvIHNlbmQuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5zZW5kTWVzc2FnZSA9IGZ1bmN0aW9uKG1lc3NhZ2VUeXBlLCBtZXNzYWdlKSB7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAqIFNlbmQgYSBtZXNzYWdlIHRvIHRoZSBwYXJlbnQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB3aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKF9tYWtlTWVzc2FnZSh0aGlzLmlkLCBtZXNzYWdlVHlwZSwgbWVzc2FnZSksICcqJyk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogVHJhbnNtaXQgdGhlIGN1cnJlbnQgaWZyYW1lIGhlaWdodCB0byB0aGUgcGFyZW50LgogICAgICAgICAqCiAgICAgICAgICogQ2FsbCB0aGlzIGRpcmVjdGx5IGluIGNhc2VzIHdoZXJlIHlvdSBtYW51YWxseSBhbHRlciB0aGUgaGVpZ2h0IG9mIHRoZSBpZnJhbWUgY29udGVudHMuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZXRob2Qgc2VuZEhlaWdodAogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqLwogICAgICAgIHRoaXMuc2VuZEhlaWdodCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBHZXQgdGhlIGNoaWxkJ3MgaGVpZ2h0LgogICAgICAgICAgICB2YXIgaGVpZ2h0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXS5vZmZzZXRIZWlnaHQudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIC8vIFNlbmQgdGhlIGhlaWdodCB0byB0aGUgcGFyZW50LgogICAgICAgICAgICB0aGlzLnNlbmRNZXNzYWdlKCdoZWlnaHQnLCBoZWlnaHQpOwoKICAgICAgICAgICAgcmV0dXJuIGhlaWdodDsKICAgICAgICB9LmJpbmQodGhpcyk7CgogICAgICAgIC8qKgogICAgICAgICAqIEFzayBwYXJlbnQgdG8gc2VuZCB0aGUgY3VycmVudCB2aWV3cG9ydCBhbmQgaWZyYW1lIHBvc2l0aW9uIGluZm9ybWF0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZXRob2Qgc2VuZEhlaWdodAogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqLwogICAgICAgIHRoaXMuZ2V0UGFyZW50UG9zaXRpb25JbmZvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIFNlbmQgdGhlIGhlaWdodCB0byB0aGUgcGFyZW50LgogICAgICAgICAgICB0aGlzLnNlbmRNZXNzYWdlKCdwYXJlbnRQb3NpdGlvbkluZm8nKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBTY3JvbGwgcGFyZW50IHRvIGEgZ2l2ZW4gZWxlbWVudCBpZC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1ldGhvZCBzY3JvbGxQYXJlbnRUbwogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGhhc2ggVGhlIGlkIG9mIHRoZSBlbGVtZW50IHRvIHNjcm9sbCB0by4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnNjcm9sbFBhcmVudFRvID0gZnVuY3Rpb24oaGFzaCkgewogICAgICAgICAgICB0aGlzLnNlbmRNZXNzYWdlKCduYXZpZ2F0ZVRvJywgJyMnICsgaGFzaCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogTmF2aWdhdGUgcGFyZW50IHRvIGEgZ2l2ZW4gdXJsLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWV0aG9kIG5hdmlnYXRlUGFyZW50VG8KICAgICAgICAgKiBAaW5zdGFuY2UKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBuYXZpZ2F0ZSB0by4KICAgICAgICAgKi8KICAgICAgICB0aGlzLm5hdmlnYXRlUGFyZW50VG8gPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgdGhpcy5zZW5kTWVzc2FnZSgnbmF2aWdhdGVUbycsIHVybCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogU2Nyb2xsIHBhcmVudCB0byBhIGdpdmVuIGNoaWxkIGVsZW1lbnQgaWQuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZXRob2Qgc2Nyb2xsUGFyZW50VG9DaGlsZEVsCiAgICAgICAgICogQGluc3RhbmNlCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIG9mIHRoZSBjaGlsZCBlbGVtZW50IHRvIHNjcm9sbCB0by4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnNjcm9sbFBhcmVudFRvQ2hpbGRFbCA9IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIC8vIEdldCB0aGUgY2hpbGQgZWxlbWVudCBwb3NpdGlvbiB1c2luZyBnZXRCb3VuZGluZ0NsaWVudFJlY3QgKyBwYWdlWU9mZnNldAogICAgICAgICAgICAvLyB2aWEgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0VsZW1lbnQvZ2V0Qm91bmRpbmdDbGllbnRSZWN0CiAgICAgICAgICAgIHZhciB0b3BQb3MgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wICsgd2luZG93LnBhZ2VZT2Zmc2V0OwogICAgICAgICAgICB0aGlzLnNjcm9sbFBhcmVudFRvQ2hpbGRQb3ModG9wUG9zKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBTY3JvbGwgcGFyZW50IHRvIGEgcGFydGljdWxhciBjaGlsZCBvZmZzZXQuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOnB5bS5DaGlsZAogICAgICAgICAqIEBtZXRob2Qgc2Nyb2xsUGFyZW50VG9DaGlsZFBvcwogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IHBvcyBUaGUgb2Zmc2V0IG9mIHRoZSBjaGlsZCBlbGVtZW50IHRvIHNjcm9sbCB0by4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnNjcm9sbFBhcmVudFRvQ2hpbGRQb3MgPSBmdW5jdGlvbihwb3MpIHsKICAgICAgICAgICAgdGhpcy5zZW5kTWVzc2FnZSgnc2Nyb2xsVG9DaGlsZFBvcycsIHBvcy50b1N0cmluZygpKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBNYXJrIFdoZXRoZXIgdGhlIGNoaWxkIGlzIGVtYmVkZGVkIG9yIG5vdAogICAgICAgICAqIGV4ZWN1dGVzIGEgY2FsbGJhY2sgaW4gY2FzZSBpdCB3YXMgcGFzc2VkIHRvIHRoZSBjb25maWcKICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6cHltLkNoaWxkCiAgICAgICAgICogQG1ldGhvZCBfbWFya1doZXRoZXJFbWJlZGRlZAogICAgICAgICAqIEBpbm5lcgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHttb2R1bGU6cHltLkNoaWxkfm9uTWFya2VkRW1iZWRkZWRTdGF0dXN9IFRoZSBjYWxsYmFjayB0byBleGVjdXRlIGFmdGVyIGRldGVybWluaW5nIHdoZXRoZXIgZW1iZWRkZWQgb3Igbm90LgogICAgICAgICAqLwogICAgICAgIHZhciBfbWFya1doZXRoZXJFbWJlZGRlZCA9IGZ1bmN0aW9uKG9uTWFya2VkRW1iZWRkZWRTdGF0dXMpIHsKICAgICAgICAgIHZhciBodG1sRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdodG1sJylbMF0sCiAgICAgICAgICAgICAgbmV3Q2xhc3NGb3JIdG1sLAogICAgICAgICAgICAgIG9yaWdpbmFsSHRtbENsYXNzZXMgPSBodG1sRWxlbWVudC5jbGFzc05hbWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZih3aW5kb3cuc2VsZiAhPT0gd2luZG93LnRvcCkgewogICAgICAgICAgICAgIG5ld0NsYXNzRm9ySHRtbCA9ICJlbWJlZGRlZCI7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgIG5ld0NsYXNzRm9ySHRtbCA9ICJub3QtZW1iZWRkZWQiOwogICAgICAgICAgICB9CiAgICAgICAgICB9Y2F0Y2goZSkgewogICAgICAgICAgICBuZXdDbGFzc0Zvckh0bWwgPSAiZW1iZWRkZWQiOwogICAgICAgICAgfQogICAgICAgICAgaWYob3JpZ2luYWxIdG1sQ2xhc3Nlcy5pbmRleE9mKG5ld0NsYXNzRm9ySHRtbCkgPCAwKSB7CiAgICAgICAgICAgIGh0bWxFbGVtZW50LmNsYXNzTmFtZSA9IG9yaWdpbmFsSHRtbENsYXNzZXMgPyBvcmlnaW5hbEh0bWxDbGFzc2VzICsgJyAnICsgbmV3Q2xhc3NGb3JIdG1sIDogbmV3Q2xhc3NGb3JIdG1sOwogICAgICAgICAgICBpZihvbk1hcmtlZEVtYmVkZGVkU3RhdHVzKXsKICAgICAgICAgICAgICBvbk1hcmtlZEVtYmVkZGVkU3RhdHVzKG5ld0NsYXNzRm9ySHRtbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3JhaXNlQ3VzdG9tRXZlbnQoIm1hcmtlZC1lbWJlZGRlZCIpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBjYWxsYmFjayBtb2R1bGU6cHltLkNoaWxkfm9uTWFya2VkRW1iZWRkZWRTdGF0dXMKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gY2xhc3NuYW1lICJlbWJlZGRlZCIgb3IgIm5vdC1lbWJlZGRlZCIuCiAgICAgICAgICovCgogICAgICAgIC8qKgogICAgICAgICAqIFVuYmluZCBjaGlsZCBldmVudCBoYW5kbGVycyBhbmQgdGltZXJzLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpweW0uQ2hpbGQKICAgICAgICAgKiBAbWV0aG9kIHJlbW92ZQogICAgICAgICAqIEBpbnN0YW5jZQogICAgICAgICAqLwogICAgICAgIHRoaXMucmVtb3ZlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgdGhpcy5fcHJvY2Vzc01lc3NhZ2UpOwogICAgICAgICAgICBpZiAodGhpcy50aW1lcklkKSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMudGltZXJJZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLyBJbml0aWFsaXplIHNldHRpbmdzIHdpdGggb3ZlcnJpZGVzLgogICAgICAgIGZvciAodmFyIGtleSBpbiBjb25maWcpIHsKICAgICAgICAgICAgdGhpcy5zZXR0aW5nc1trZXldID0gY29uZmlnW2tleV07CiAgICAgICAgfQoKICAgICAgICAvLyBJZGVudGlmeSB3aGF0IElEIHRoZSBwYXJlbnQga25vd3MgdGhpcyBjaGlsZCBhcy4KICAgICAgICB0aGlzLmlkID0gX2dldFBhcmFtZXRlckJ5TmFtZSgnY2hpbGRJZCcpIHx8IGNvbmZpZy5pZDsKICAgICAgICB0aGlzLm1lc3NhZ2VSZWdleCA9IG5ldyBSZWdFeHAoJ15weW0nICsgTUVTU0FHRV9ERUxJTUlURVIgKyB0aGlzLmlkICsgTUVTU0FHRV9ERUxJTUlURVIgKyAnKFxcUyspJyArIE1FU1NBR0VfREVMSU1JVEVSICsgJyguKikkJyk7CgogICAgICAgIC8vIEdldCB0aGUgaW5pdGlhbCB3aWR0aCBmcm9tIGEgVVJMIHBhcmFtZXRlci4KICAgICAgICB2YXIgd2lkdGggPSBwYXJzZUludChfZ2V0UGFyYW1ldGVyQnlOYW1lKCdpbml0aWFsV2lkdGgnKSk7CgogICAgICAgIC8vIEdldCB0aGUgdXJsIG9mIHRoZSBwYXJlbnQgZnJhbWUKICAgICAgICB0aGlzLnBhcmVudFVybCA9IF9nZXRQYXJhbWV0ZXJCeU5hbWUodGhpcy5zZXR0aW5ncy5wYXJlbnR1cmxwYXJhbSk7CgogICAgICAgIC8vIEdldCB0aGUgdGl0bGUgb2YgdGhlIHBhcmVudCBmcmFtZQogICAgICAgIHRoaXMucGFyZW50VGl0bGUgPSBfZ2V0UGFyYW1ldGVyQnlOYW1lKCdwYXJlbnRUaXRsZScpOwoKICAgICAgICAvLyBCaW5kIHRoZSByZXF1aXJlZCBtZXNzYWdlIGhhbmRsZXJzCiAgICAgICAgdGhpcy5vbk1lc3NhZ2UoJ3dpZHRoJywgdGhpcy5fb25XaWR0aE1lc3NhZ2UpOwoKICAgICAgICAvLyBTZXQgdXAgYSBsaXN0ZW5lciB0byBoYW5kbGUgYW55IGluY29taW5nIG1lc3NhZ2VzLgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgdGhpcy5fcHJvY2Vzc01lc3NhZ2UsIGZhbHNlKTsKCiAgICAgICAgLy8gSWYgdGhlcmUncyBhIGNhbGxiYWNrIGZ1bmN0aW9uLCBjYWxsIGl0LgogICAgICAgIGlmICh0aGlzLnNldHRpbmdzLnJlbmRlckNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MucmVuZGVyQ2FsbGJhY2sod2lkdGgpOwogICAgICAgIH0KCiAgICAgICAgLy8gU2VuZCB0aGUgaW5pdGlhbCBoZWlnaHQgdG8gdGhlIHBhcmVudC4KICAgICAgICB0aGlzLnNlbmRIZWlnaHQoKTsKCiAgICAgICAgLy8gSWYgd2UncmUgY29uZmlndXJlZCB0byBwb2xsLCBjcmVhdGUgYSBzZXRJbnRlcnZhbCB0byBoYW5kbGUgdGhhdC4KICAgICAgICBpZiAodGhpcy5zZXR0aW5ncy5wb2xsaW5nKSB7CiAgICAgICAgICAgIHRoaXMudGltZXJJZCA9IHdpbmRvdy5zZXRJbnRlcnZhbCh0aGlzLnNlbmRIZWlnaHQsIHRoaXMuc2V0dGluZ3MucG9sbGluZyk7CiAgICAgICAgfQoKICAgICAgICBfbWFya1doZXRoZXJFbWJlZGRlZChjb25maWcub25NYXJrZWRFbWJlZGRlZFN0YXR1cyk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICAvLyBJbml0aWFsaXplIGVsZW1lbnRzIHdpdGggcHltIGRhdGEgYXR0cmlidXRlcwogICAgLy8gaWYgd2UgYXJlIG5vdCBpbiBzZXJ2ZXIgY29uZmlndXJhdGlvbgogICAgaWYodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgIGxpYi5hdXRvSW5pdCh0cnVlKTsKICAgIH0KCiAgICByZXR1cm4gbGliOwp9KTsKCg=="></script>
<script src="data:application/x-javascript;base64,SFRNTFdpZGdldHMud2lkZ2V0KHsKCiAgbmFtZTogJ3dpZGdldGZyYW1lJywKCiAgdHlwZTogJ291dHB1dCcsCgogIGZhY3Rvcnk6IGZ1bmN0aW9uKGVsLCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgcmV0dXJuIHsKCiAgICAgIHJlbmRlclZhbHVlOiBmdW5jdGlvbih4KSB7CiAgICAgICAgIEhUTUxXaWRnZXRzLnB5bVBhcmVudCA9ICBuZXcgcHltLlBhcmVudChlbC5pZCwgeC51cmwsIHgub3B0aW9ucyB8fCB7fSk7CiAgICAgIH0sCgogICAgICByZXNpemU6IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgIH0KCiAgICB9OwogIH0KfSk7"></script>
</head>
<body style="background-color: white;">
<div id="htmlwidget_container">
<div id="htmlwidget-34dff898e629d03efd47" class="widgetframe html-widget" style="width:100%;height:400px;">

</div>
</div>
<script type="application/json" data-for="htmlwidget-34dff898e629d03efd47">{"x":{"url":"about:blank","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<script type="application/htmlwidget-sizing" data-for="htmlwidget-34dff898e629d03efd47">{"viewer":{"width":"100%","height":"400px","padding":15,"fill":false},"browser":{"width":"100%","height":"400px","padding":40,"fill":false}}</script>
</body>
</html>
